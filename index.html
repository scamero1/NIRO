<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIRO - niro-tv.online</title>
    <meta name="description" content="La experiencia de streaming definitiva.">
    <meta name="theme-color" content="#0F0720">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NIRO">
    <link rel="icon" href="Niro_original.png">
    <link rel="apple-touch-icon" href="Niro_original.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* -------------------------------------------------------------------------- */
        /*                                DESIGN TOKENS                               */
        /* -------------------------------------------------------------------------- */
        :root {
            /* Colors */
            --color-brand-primary: #8B5CF6; /* Violeta Vibrante */
            --color-brand-glow: rgba(139, 92, 246, 0.6);
            --color-brand-accent: #D946EF; /* Fucsia para contrastes */
            
            --color-bg-base: #0F0720; /* Fondo muy oscuro morado */
            --color-bg-surface: #1E1035; /* Superficie morada oscura */
            --color-bg-surface-hover: #2D1B4E;
            --color-bg-glass: rgba(15, 7, 32, 0.7);
            
            --color-text-primary: #FFFFFF;
            --color-text-secondary: #C4B5FD; /* Lavanda claro */
            --color-text-tertiary: #8B8198;
            
            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Inter', sans-serif;
            
            /* Spacing */
            --header-height: 80px;
            --container-width: 92%;
            --max-width: 1400px; /* Centering limit */
            --mobile-nav-height: 60px;
            
            /* Animation */
            --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* -------------------------------------------------------------------------- */
        /*                                   RESET                                    */
        /* -------------------------------------------------------------------------- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-base);
            color: var(--color-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            padding-bottom: 0;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-base); }
        ::-webkit-scrollbar-thumb { background: var(--color-bg-surface-hover); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-brand-primary); }

        a, button {
            all: unset;
            cursor: pointer;
        }
        
        /* Inputs */
        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        input, textarea, select {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-family: var(--font-body);
            width: 100%;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-brand-primary);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-left: 2px;
        }

        /* Login/Register Card */
        .auth-card {
            position: relative;
            background: rgba(30,16,53,0.8);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* Profile Gate */
        .profile-gate {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: #141414;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s;
        }
        .profile-list {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }
        .profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .profile-item:hover {
            transform: scale(1.05);
        }
        .profile-item:hover .profile-name {
            color: white;
        }
        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 3px solid transparent;
            transition: border-color 0.2s;
        }
        .profile-item:hover .profile-avatar {
            border-color: white;
        }
        .profile-name {
            color: #808080;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        .add-profile-btn {
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 4rem;
            color: #808080;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .add-profile-btn:hover {
            background: white;
            color: black;
        }

        /* -------------------------------------------------------------------------- */
        /*                                 COMPONENTS                                 */
        /* -------------------------------------------------------------------------- */
        
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            z-index: 1000;
            transition: background-color 0.4s var(--ease-out-expo), backdrop-filter 0.4s;
        }
        .header.scrolled {
            background-color: rgba(15, 7, 32, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            height: 100%;
            width: var(--container-width);
            max-width: var(--max-width);
            margin: 0 auto;
        }
        
        .logo {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 800;
            color: transparent;
            background: linear-gradient(135deg, #fff 20%, var(--color-brand-primary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            margin-right: 3rem;
            letter-spacing: -1px;
            filter: drop-shadow(0 0 15px var(--color-brand-glow));
            transition: transform 0.3s;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
        }
        .nav-link {
            font-size: 0.95rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            text-shadow: 0 0 10px var(--color-brand-glow);
        }
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--color-brand-primary);
            box-shadow: 0 0 8px var(--color-brand-primary);
        }
        
        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Search & Moods */
        .search-bar {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 5px 15px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .search-bar:focus-within {
            background: rgba(0,0,0,0.5);
            border-color: var(--color-brand-primary);
            width: 250px;
        }
        .search-input {
            background: transparent;
            border: none;
            color: white;
            padding: 5px;
            outline: none;
            width: 150px;
            transition: width 0.3s;
        }
        .search-input:focus {
            width: 200px;
            box-shadow: none;
            background: transparent;
        }

        .mood-section {
            padding: 2rem 0;
            text-align: center;
        }
        .mood-grid {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }
        .mood-chip {
            padding: 0.8rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mood-chip:hover, .mood-chip.active {
            background: var(--color-brand-primary);
            border-color: var(--color-brand-primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.6em 1.5em;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s var(--ease-out-expo);
            letter-spacing: 0.02em;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--color-brand-primary), #7c3aed);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6);
            filter: brightness(1.1);
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-danger:hover { filter: brightness(1.1); }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.4);
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .btn-icon:hover {
            border-color: var(--color-brand-primary);
            background: var(--color-brand-primary);
            color: white;
            transform: scale(1.1);
        }

        /* Hero */
        .hero {
            position: relative;
            height: 85vh;
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            margin-bottom: -10vh;
        }
        
        .hero-bg {
            position: absolute;
            inset: -5%;
            width: 110%;
            height: 110%;
            background-size: cover;
            background-position: center;
            z-index: 0;
            animation: kenburns 30s infinite alternate;
            filter: brightness(0.6);
        }
        @keyframes kenburns {
            from { transform: scale(1); }
            to { transform: scale(1.1) translate(-2%, -2%); }
        }
        
        .hero-overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 70% 20%, rgba(0,0,0,0) 0%, rgba(11,12,15,0.6) 50%, var(--color-bg-base) 100%),
                        linear-gradient(to top, var(--color-bg-base) 10%, transparent 60%);
            z-index: 1;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            width: var(--container-width);
            max-width: var(--max-width);
            margin: 0 auto;
            padding-top: 60px;
        }
        
        .hero-title {
            font-family: var(--font-display);
            font-size: clamp(2rem, 5vw, 5rem);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            background: linear-gradient(to bottom, #fff 40%, #ccc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .hero-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            color: #e5e5e5;
        }
        
        .match-score { color: var(--color-brand-accent); font-weight: 700; }
        
        .hero-desc {
            font-size: 1.1rem;
            color: var(--color-text-secondary);
            margin-bottom: 2rem;
            max-width: 600px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* Sections & Cards */
        .section {
            padding: 2rem 0;
            position: relative;
            z-index: 10;
        }
        
        .section-header {
            width: var(--container-width);
            max-width: var(--max-width);
            margin: 0 auto 1rem;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }
        
        .slider-container {
            position: relative;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }
        
        .slider-track {
            display: flex;
            gap: 1rem;
            padding: 1rem calc((100% - min(var(--container-width), var(--max-width))) / 2);
            overflow-x: auto;
            scroll-behavior: smooth;
        }
        .slider-track::-webkit-scrollbar { display: none; }
        
        .card {
            flex: 0 0 220px;
            aspect-ratio: 16/9;
            position: relative;
            border-radius: 6px;
            transition: transform 0.3s var(--ease-out-expo), z-index 0s;
            cursor: pointer;
            background: #1a1a1a;
        }
        .card.poster {
            flex: 0 0 160px;
            aspect-ratio: 2/3;
        }
        
        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .card:hover {
            transform: scale(1.1);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Admin / Tables */
        .admin-container {
            width: var(--container-width);
            max-width: var(--max-width);
            margin: 120px auto 50px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .admin-tab {
            padding: 0.5rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .admin-tab.active {
            background: var(--color-brand-primary);
            color: white;
            border-color: var(--color-brand-primary);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-bg-surface);
            border-radius: 8px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .data-table th {
            background: rgba(0,0,0,0.2);
            color: var(--color-text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .data-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none; /* JS toggles flex */
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .modal-content {
            background-color: var(--color-bg-surface);
            width: 100%;
            max-width: 800px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Mobile Nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--mobile-nav-height);
            background: rgba(11, 12, 15, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 1001;
            justify-content: space-around;
            align-items: center;
        }
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: var(--color-text-secondary);
        }
        
        @media (max-width: 768px) {
            .mobile-nav { display: flex; }
            body.in-profile-gate .mobile-nav { display: none; }
        }
        .mobile-nav-item.active { color: white; }

        @media (max-width: 768px) {
            .nav-menu, .header-actions { display: none; }
            .mobile-nav { display: flex; }
            .hero-title { font-size: 2.5rem; }
            .admin-container { width: 95%; margin-top: 100px; }
            .card { flex: 0 0 160px; }
            .data-table { display: block; overflow-x: auto; }
            /* Fix crowded buttons */
            .hero-content div { flex-wrap: wrap; }
            .btn { width: 100%; margin-bottom: 0.5rem; }
            .header { background-color: rgba(15, 7, 32, 0.95); backdrop-filter: blur(12px); } /* Always dark on mobile */
        }
        
        /* Ultra small screens */
        @media (max-width: 480px) {
            .hero-title { font-size: 2rem; }
            .hero-desc { font-size: 0.9rem; -webkit-line-clamp: 3; line-clamp: 3; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }
            .section-title { font-size: 1.1rem; }
            .data-table th, .data-table td { padding: 0.5rem; font-size: 0.8rem; }
            .btn-primary, .btn-secondary { padding: 0.5em 1em; font-size: 0.85rem; }
            .modal-backdrop { padding: 10px; }
            .modal-content { max-height: 85vh; }
            .search-input { width: 100px; }
            .search-bar:focus-within { width: 100%; position: absolute; left: 10px; right: 10px; z-index: 10; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 80px; /* Above mobile nav */
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        @media(min-width: 769px) {
            .toast-container { bottom: 20px; }
        }
        .toast {
            background: rgba(30, 16, 53, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            min-width: 250px;
            max-width: 90vw;
        }
        .toast.success { border-left: 4px solid var(--color-brand-primary); }
        .toast.error { border-left: 4px solid #ef4444; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(10px); }
        }

        /* Video Overlay Responsive */
        .video-overlay-container {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .video-header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 15px;
            width: 90%;
        }
        .video-back-btn {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .video-title {
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media(max-width: 480px) {
            .video-header { top: 10px; left: 10px; }
            .video-back-btn { width: 36px; height: 36px; font-size: 1.2rem; }
            .video-title { font-size: 1rem; }
        }

        /* Custom Video Player Styles */
        .video-overlay-container {
            position: fixed; inset: 0; background: black; z-index: 2000; display: flex; flex-direction: column;
        }
        .video-ui-header {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; align-items: center; gap: 20px; z-index: 2010;
            transition: opacity 0.3s;
        }
        .video-click-area {
            position: absolute; inset: 0; z-index: 2005;
        }
        .video-controls-bar {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 20px 40px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 2010; transition: opacity 0.3s;
            display: flex; flex-direction: column; gap: 10px;
        }
        .video-progress-container {
            height: 5px; background: rgba(255,255,255,0.3); cursor: pointer;
            position: relative; border-radius: 2px;
            transition: height 0.2s;
            width: 100%;
        }
        .video-progress-container:hover { height: 8px; }
        .video-progress-fill {
            height: 100%; background: var(--color-brand-primary); width: 0%; border-radius: 2px;
            position: relative;
        }
        .video-progress-fill::after {
            content:''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; background: white; border-radius: 50%; opacity: 0;
            transition: opacity 0.2s;
        }
        .video-progress-container:hover .video-progress-fill::after { opacity: 1; }

        .video-controls-row {
            display: flex; justify-content: space-between; align-items: center;
        }
        .video-controls-left, .video-controls-right {
            display: flex; align-items: center; gap: 15px;
        }
        .video-btn {
            background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;
            opacity: 0.8; transition: opacity 0.2s; padding: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .video-btn:hover { opacity: 1; transform: scale(1.1); }
        
        .user-idle .video-ui-header, .user-idle .video-controls-bar {
            opacity: 0; pointer-events: none;
        }
        
        /* Volume Slider */
        input[type=range] {
            appearance: none; -webkit-appearance: none; background: transparent; width: 80px; height: 4px; border-radius: 2px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: white; margin-top: -4px;
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div id="app">
        <!-- Header -->
        <header class="header" id="main-header">
            <!-- Rendered by JS -->
        </header>

        <!-- Main View -->
        <main id="main-view">
            <!-- Rendered by JS -->
        </main>

        <!-- Global Mobile Nav -->
        <div class="mobile-nav">
            <div class="mobile-nav-item" id="nav-home" onclick="app.router('home')"><i class="ri-home-5-fill"></i><span>Inicio</span></div>
            <div class="mobile-nav-item" id="nav-series" onclick="app.router('series')"><i class="ri-tv-line"></i><span>Series</span></div>
            <div class="mobile-nav-item" id="nav-movies" onclick="app.router('movies')"><i class="ri-movie-2-line"></i><span>Pelis</span></div>
            <div class="mobile-nav-item" id="nav-mylist" onclick="app.router('mylist')"><i class="ri-list-check"></i><span>Mi Lista</span></div>
            <div class="mobile-nav-item" id="nav-profile" onclick="app.router('profiles')"><i class="ri-user-3-fill"></i><span>Perfil</span></div>
        </div>

        <!-- Modal -->
        <div class="modal-backdrop" id="generic-modal">
            <div class="modal-content" id="generic-modal-content">
                <!-- Rendered by JS -->
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(typeof app !== 'undefined' && app.renderHeader) app.renderHeader();
        });

        /* -------------------------------------------------------------------------- */
        /*                                  DATA STORE                                */
        /* -------------------------------------------------------------------------- */
        
        let allItems = [];
        let allUsers = [];

        const AVATARS = [
            'https://i.pinimg.com/736x/c4/88/34/c488340ad56e5454f4576f6c708b3482.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-qo9h82134t9nv0j0.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-88wkdmjrorckekha.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-dyrp6bw6adq4608w.jpg',
            'https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png',
            'https://pro2-bar-s3-cdn-cf1.myportfolio.com/dddb0c1b4ab8a8dcfa88288dcea3848f/a1322748-d3c4-4c07-b365-22d7d6f51c72_rw_1200.png?h=3e2f5b3a4f3b6c5f7f3f6e4a9c4a8f3b',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPfCfPLhwIpjvAbjJ8q3c7v2v5e7f2f6_0qA&usqp=CAU',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_j5_q6_q_q_q_q_q_q_q_q_q_q_q_q_q_q&usqp=CAU',
            'https://i.pinimg.com/originals/b6/77/cd/b677cd1cde292f261166533d6fe75872.png',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu99-u_G5hX_G4rA8E4r4r4r4r4r4r4r4r4r&usqp=CAU',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR-q_q_q_q_q_q_q_q_q_q_q_q_q_q_q_q_q&usqp=CAU',
            'https://ih0.redbubble.net/image.618427277.3222/flat,1000x1000,075,f.u2.jpg',
            'https://i.pinimg.com/originals/10/12/c0/1012c06c7e1b0f8f5e60611992785e5a.png',
            'https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-v3t2794158t8687a.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-6pv9612v2870428d.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-23456789.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-34567890.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-45678901.jpg',
            'https://pbs.twimg.com/media/DmBraxlXcAAKB53.jpg',
            'https://i.pinimg.com/736x/db/70/dc/db70dc468af8c93749d1f587d74dcb08.jpg',
            'https://i.pinimg.com/736x/0d/dc/ca/0ddccaae71591af95020288820a40348.jpg',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/1bdc9a33850498.56ba69ac2ba5b.png',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/64623a33850498.56ba69ac2a6f7.png',
            'https://i.pinimg.com/originals/2b/90/0d/2b900d5612554cd0b5ea796e87588726.png',
            'https://i.pinimg.com/originals/f6/13/46/f61346b9a8885b5420e60057f920d32f.png',
            'https://i.pinimg.com/originals/98/e4/20/98e420b982181518d09817924844335c.png',
            'https://i.pinimg.com/originals/55/79/f0/5579f0460c5a14d567c2957790757753.png',
            'https://i.pinimg.com/originals/1b/71/b8/1b71b85dd741ad27bffa5c834a7ed797.png',
            'https://i.pinimg.com/originals/e3/94/30/e39430434d2b8207188f880ac66c6411.png',
            'https://i.pinimg.com/originals/61/54/76/61547625e01d8daf941aae3ffb37f653.png',
            'https://i.pinimg.com/originals/34/62/d2/3462d27440aa255b1c314ff16f4032b4.png',
            'https://i.pinimg.com/originals/0c/3b/3a/0c3b3adb1a7530892e55ef36d3be6cb8.png',
            'https://i.pinimg.com/originals/f5/66/1b/f5661b1836154238e21016892697858d.png'
        ];

        /* -------------------------------------------------------------------------- */
        /*                              DOWNLOAD MANAGER                              */
        /* -------------------------------------------------------------------------- */
        const DownloadManager = {
            dbName: 'niro_offline_db',
            version: 1,
            db: null,
            
            async init() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, this.version);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                        if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'id' });
                    };
                    req.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    req.onerror = (e) => reject(e);
                });
            },

            async save(id, url, metaData, onProgress) {
                await this.init();
                try {
                    const response = await fetch(url);
                    if(!response.ok) throw new Error("Network error");
                    
                    const reader = response.body.getReader();
                    const contentLength = +response.headers.get('Content-Length');
                    let receivedLength = 0;
                    const chunks = [];
                    
                    while(true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        receivedLength += value.length;
                        if(onProgress && contentLength) onProgress(receivedLength / contentLength);
                    }
                    
                    const blob = new Blob(chunks);
                    const tx = this.db.transaction(['files', 'meta'], 'readwrite');
                    tx.objectStore('files').put(blob, id);
                    tx.objectStore('meta').put({ ...metaData, id, date: Date.now(), size: blob.size });
                    
                    return new Promise((resolve, reject) => {
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    });
                } catch(e) {
                    console.error("Download failed", e);
                    throw e;
                }
            },

            async get(id) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['files'], 'readonly');
                    const req = tx.objectStore('files').get(id);
                    req.onsuccess = () => {
                        if(req.result) resolve(URL.createObjectURL(req.result));
                        else resolve(null);
                    };
                    req.onerror = () => reject(req.error);
                });
            },
            
            async has(id) {
                await this.init();
                return new Promise(resolve => {
                    const tx = this.db.transaction(['meta'], 'readonly');
                    const req = tx.objectStore('meta').get(id);
                    req.onsuccess = () => resolve(!!req.result);
                    req.onerror = () => resolve(false);
                });
            },

            async remove(id) {
                await this.init();
                const tx = this.db.transaction(['files', 'meta'], 'readwrite');
                tx.objectStore('files').delete(id);
                tx.objectStore('meta').delete(id);
                return new Promise(resolve => tx.oncomplete = () => resolve());
            },

            async list() {
                await this.init();
                return new Promise(resolve => {
                    const tx = this.db.transaction(['meta'], 'readonly');
                    const req = tx.objectStore('meta').getAll();
                    req.onsuccess = () => resolve(req.result || []);
                });
            }
        };

        /* -------------------------------------------------------------------------- */
        /*                                 APPLICATION                                */
        /* -------------------------------------------------------------------------- */
        const app = {
            state: {
                user: null,
                currentProfile: null,
                route: 'home',
                adminTab: 'content' // 'content' or 'users'
            },

            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="${type === 'success' ? 'ri-checkbox-circle-fill' : 'ri-error-warning-fill'}" style="font-size:1.2rem; color:${type === 'success' ? '#46d369' : '#ef4444'}"></i>
                    <span>${msg}</span>
                `;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            confirmAction: (msg, onConfirm) => {
                const m = document.createElement('div');
                m.className = 'modal-backdrop';
                m.style.display = 'flex';
                m.style.zIndex = '4000'; // Top level
                m.innerHTML = `
                    <div class="modal-content" style="max-width:400px; text-align:center; padding:2rem;">
                        <h3 style="margin-bottom:1rem;">¿Estás seguro?</h3>
                        <p style="margin-bottom:2rem; color:#ccc;">${msg}</p>
                        <div style="display:flex; justify-content:center; gap:1rem;">
                            <button class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
                            <button class="btn btn-danger" id="confirm-ok">Confirmar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(m);
                
                const close = () => m.remove();
                m.querySelector('#confirm-cancel').onclick = close;
                m.querySelector('#confirm-ok').onclick = () => {
                    close();
                    onConfirm();
                };
            },

            init: async () => {
                await app.fetchDB();
                app.checkSession();
                app.renderHeader();
                app.router(app.state.route); // Start at current route (or home)
                
                // Header scroll effect
                window.addEventListener('scroll', () => {
                    const h = document.getElementById('main-header');
                    if(window.scrollY > 50) h.classList.add('scrolled');
                    else h.classList.remove('scrolled');
                });
            },

            /* --- Data Logic --- */
            fetchDB: async () => {
                try {
                    const res = await fetch('/db');
                    if(res.ok) {
                        const data = await res.json();
                        allItems = data.items || [];
                        allUsers = data.users || [];
                    }
                } catch(e) { console.error("Error DB", e); }
            },

            saveDB: async (updates) => {
                try {
                    // Fetch current to merge
                    const res = await fetch('/db');
                    const current = await res.json();
                    
                    const newData = { ...current, ...updates };
                    
                    await fetch('/db', {
                        method: 'POST',
                        body: JSON.stringify(newData)
                    });
                    
                    // Update local
                    if(updates.items) allItems = updates.items;
                    if(updates.users) allUsers = updates.users;
                    return true;
                } catch(e) {
                    console.error("Save failed", e);
                    app.showToast("Error guardando datos", "error");
                    return false;
                }
            },

            checkSession: async () => {
                const u = localStorage.getItem('niro_user');
                if(u) {
                    const parsedUser = JSON.parse(u);
                    // Re-validate with DB
                    const freshUser = allUsers.find(user => user.email === parsedUser.email);
                    if(freshUser) {
                        app.state.user = freshUser;
                        
                        // Ensure profiles exist (Migration)
                        if(!app.state.user.profiles) {
                            app.state.user.profiles = [{
                                id: Date.now(),
                                name: app.state.user.name,
                                avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)]
                            }];
                            await app.saveDB({ users: allUsers });
                        }

                        // Check stored profile
                        const storedProfile = localStorage.getItem('niro_profile');
                        if (storedProfile) {
                            const pId = JSON.parse(storedProfile).id;
                            const validProfile = app.state.user.profiles.find(p => p.id === pId);
                            if(validProfile) {
                                app.state.currentProfile = validProfile;
                            } else {
                                app.state.route = 'profiles';
                            }
                        } else {
                            app.state.route = 'profiles';
                        }
                    } else {
                        localStorage.removeItem('niro_user');
                        localStorage.removeItem('niro_profile');
                    }
                }
            },

            login: async (email, password) => {
                await app.fetchDB(); // Refresh data
                const user = allUsers.find(u => u.email === email && u.password === password);
                if(user) {
                    if(user.banned) { app.showToast("Usuario bloqueado.", "error"); return false; }
                    if(user.status === 'pending') { app.showToast("Tu cuenta está pendiente de aprobación por un administrador.", "error"); return false; }
                    app.state.user = user;
                    localStorage.setItem('niro_user', JSON.stringify(user));
                    
                    // Ensure profiles exist
                    if(!user.profiles) {
                        user.profiles = [{ id: Date.now(), name: user.name, avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)] }];
                        await app.saveDB({ users: allUsers });
                    }

                    app.router('profiles');
                    return true;
                }
                app.showToast("Credenciales inválidas", "error");
                return false;
            },

            register: async (name, email, password) => {
                await app.fetchDB();
                if(allUsers.find(u => u.email === email)) {
                    app.showToast("El email ya está registrado.", "error");
                    return false;
                }
                
                const newUser = {
                    name,
                    email,
                    password,
                    role: 'user',
                    status: 'pending', // Pending approval
                    banned: false,
                    profiles: [{ id: Date.now(), name: name, avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)] }]
                };
                
                allUsers.push(newUser);
                if(await app.saveDB({ users: allUsers })) {
                    app.showToast("Registro exitoso. Tu cuenta debe ser aprobada por un administrador antes de poder iniciar sesión.");
                    app.router('login');
                }
            },

            logout: () => {
                app.state.user = null;
                app.state.currentProfile = null;
                localStorage.removeItem('niro_user');
                localStorage.removeItem('niro_profile');
                app.renderHeader();
                app.router('home');
            },

            /* --- Router & Rendering --- */
            router: (route) => {
                app.state.route = route;
                window.scrollTo(0,0);
                
                // Update active nav (Desktop)
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                // Update active nav (Mobile)
                document.querySelectorAll('.mobile-nav-item').forEach(l => l.classList.remove('active'));
                const navId = route === 'home' ? 'nav-home' : 
                              route === 'series' ? 'nav-series' : 
                              route === 'movies' ? 'nav-movies' : 
                              route === 'admin' ? 'nav-admin' : '';
                if(navId) document.getElementById(navId)?.classList.add('active');

                if(route === 'home') app.renderHome();
                else if(route === 'movies') app.renderHome('movie');
                else if(route === 'series') app.renderHome('series');
                else if(route === 'mylist') app.renderHome('mylist');
                else if(route === 'downloads') app.renderDownloads();
                else if(route === 'admin') {
                    if(!app.state.user || app.state.user.role !== 'admin') {
                        app.router('home');
                        return;
                    }
                    app.renderAdmin();
                }
                else if(route === 'login') app.renderLogin();
                else if(route === 'register') app.renderRegister();
                else if(route === 'profiles') app.renderProfiles();
                else if(route === 'profile') app.renderProfile();
                else if(route === 'account') app.renderProfile();
            },

            renderProfiles: () => {
                const main = document.getElementById('main-view');
                const user = app.state.user;
                if(!user) { app.router('login'); return; }

                main.innerHTML = `
                    <div class="profile-gate">
                        <h1 style="font-size:3rem; margin-bottom:1rem;">¿Quién está viendo ahora?</h1>
                        <div class="profile-list">
                            ${(user.profiles || []).map(p => `
                                <div class="profile-item" onclick="app.selectProfile(${p.id})">
                                    <div class="profile-avatar" style="background-image:url('${p.avatar}')"></div>
                                    <span class="profile-name">${p.name}</span>
                                </div>
                            `).join('')}
                            <div class="profile-item" onclick="app.promptAddProfile()">
                                <div class="add-profile-btn"><i class="ri-add-line"></i></div>
                                <span class="profile-name">Agregar perfil</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="margin-top:3rem; border:1px solid white; color:#808080;" onclick="app.manageProfiles()">Administrar perfiles</button>
                    </div>
                `;
                document.getElementById('main-header').style.display = 'none';
                document.body.classList.add('in-profile-gate');
            },

            selectProfile: (id) => {
                const profile = app.state.user.profiles.find(p => p.id === id);
                if(profile) {
                    if(profile.pin) {
                        // Prompt for PIN
                        openModal(`
                            <div style="padding:3rem; text-align:center;">
                                <h3 style="margin-bottom:2rem;">Introduce el PIN de perfil</h3>
                                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:2rem;">
                                    <input type="password" id="profile-pin-input" maxlength="4" 
                                        style="width:150px; text-align:center; font-size:2rem; letter-spacing:10px; background:transparent; border:none; border-bottom:2px solid white; border-radius:0;"
                                        onkeyup="if(this.value.length === 4) app.verifyProfilePin(${id})">
                                </div>
                                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                            </div>
                        `);
                        setTimeout(() => document.getElementById('profile-pin-input').focus(), 100);
                        return;
                    }
                    app.activateProfile(profile);
                }
            },

            verifyProfilePin: (id) => {
                const input = document.getElementById('profile-pin-input');
                const pin = input.value;
                const profile = app.state.user.profiles.find(p => p.id === id);
                
                if(profile && profile.pin === pin) {
                    closeModal();
                    app.activateProfile(profile);
                } else {
                    input.value = '';
                    input.style.borderColor = 'red';
                    app.showToast("PIN Incorrecto", "error");
                }
            },

            activateProfile: (profile) => {
                app.state.currentProfile = profile;
                localStorage.setItem('niro_profile', JSON.stringify(profile));
                document.getElementById('main-header').style.display = 'block';
                document.body.classList.remove('in-profile-gate');
                app.renderHeader();
                app.router('home');
            },

            selectAvatar: (el, url) => {
                document.querySelectorAll('.avatar-option').forEach(img => img.style.borderColor = 'transparent');
                el.style.borderColor = 'var(--color-brand-primary)';
                const input = document.getElementById('new-profile-avatar') || document.getElementById('edit-profile-avatar');
                if(input) input.value = url;
            },

            promptAddProfile: async () => {
                const defaultAvatar = AVATARS[0];
                openModal(`
                    <div style="padding:2rem;">
                        <h3 style="margin-bottom:1.5rem;">Nuevo Perfil</h3>
                        
                        <div style="margin-bottom:1.5rem;">
                            <label style="margin-bottom:0.5rem; display:block; color:#ccc;">Elige un avatar:</label>
                            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; scrollbar-width:thin;">
                                ${AVATARS.map((url, i) => `
                                    <img src="${url}" alt="Avatar Option" class="avatar-option" 
                                        style="width:60px; height:60px; border-radius:4px; cursor:pointer; border:3px solid ${i===0 ? 'var(--color-brand-primary)' : 'transparent'}; object-fit:cover;"
                                        onclick="app.selectAvatar(this, '${url}')">
                                `).join('')}
                            </div>
                            <input type="hidden" id="new-profile-avatar" value="${defaultAvatar}">
                        </div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input id="new-profile-name" placeholder="Nombre del perfil" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:4px;">
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.handleAddProfile()">Guardar</button>
                        </div>
                    </div>
                `);
            },

            handleAddProfile: async () => {
                const name = document.getElementById('new-profile-name').value;
                const avatar = document.getElementById('new-profile-avatar').value;
                
                if(!name) {
                    app.showToast("El nombre es requerido", "error");
                    return;
                }
                
                const newProfile = {
                    id: Date.now(),
                    name,
                    avatar
                };
                
                if(!app.state.user.profiles) app.state.user.profiles = [];
                app.state.user.profiles.push(newProfile);
                await app.saveDB({ users: allUsers });
                closeModal();
                app.renderProfiles();
            },

            editProfile: (id) => {
                const p = app.state.user.profiles.find(x => x.id === id);
                if(!p) return;
                
                // Default settings if undefined
                if(p.autoplayNext === undefined) p.autoplayNext = true;
                if(p.autoplayPreviews === undefined) p.autoplayPreviews = true;
                if(!p.maturity) p.maturity = 'all';
                if(!p.language) p.language = 'es';

                openModal(`
                    <div style="padding:2rem; max-width:700px; margin:0 auto;">
                        <h2 style="margin-bottom:2rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem; font-size:2rem;">Editar Perfil</h2>
                        
                        <div style="display:flex; gap:2rem; flex-wrap:wrap;">
                            <div style="flex:0 0 120px;">
                                <img src="${p.avatar}" alt="${p.name}" style="width:120px; height:120px; border-radius:8px; object-fit:cover; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                            </div>
                            
                            <div style="flex:1; min-width:250px;">
                                <div class="form-group">
                                    <label>Nombre del Perfil</label>
                                    <input id="edit-profile-name" value="${p.name}" style="background:#333; font-size:1.1rem;">
                                </div>
                                
                                <div class="form-group">
                                    <label>Idioma</label>
                                    <select id="edit-profile-language" style="background:#333;">
                                        <option value="es" ${p.language === 'es' ? 'selected' : ''}>Español</option>
                                        <option value="en" ${p.language === 'en' ? 'selected' : ''}>English</option>
                                        <option value="pt" ${p.language === 'pt' ? 'selected' : ''}>Português</option>
                                    </select>
                                </div>

                                <div style="margin-bottom:1.5rem;">
                                    <label style="margin-bottom:0.5rem; display:block; color:#ccc;">Avatar</label>
                                    <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; scrollbar-width:thin;">
                                        ${AVATARS.map((url) => `
                                            <img src="${url}" alt="Avatar Option" class="avatar-option" 
                                                style="width:50px; height:50px; border-radius:4px; cursor:pointer; border:2px solid ${url===p.avatar ? 'var(--color-brand-primary)' : 'transparent'}; object-fit:cover;"
                                                onclick="app.selectAvatar(this, '${url}')">
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="edit-profile-avatar" value="${p.avatar}">
                                </div>

                                <div style="margin-bottom:2rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1.5rem;">
                                    <h4 style="margin-bottom:1rem; color:var(--color-text-secondary); text-transform:uppercase; font-size:0.8rem; letter-spacing:1px;">Configuración de Reproducción</h4>
                                    
                                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:10px; background:rgba(255,255,255,0.05); border-radius:4px;">
                                        <span>Reproducción automática del siguiente episodio</span>
                                        <input type="checkbox" id="edit-profile-autoplay-next" ${p.autoplayNext ? 'checked' : ''} style="width:auto;">
                                    </div>
                                    
                                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:10px; background:rgba(255,255,255,0.05); border-radius:4px;">
                                        <span>Reproducción automática de avances</span>
                                        <input type="checkbox" id="edit-profile-autoplay-previews" ${p.autoplayPreviews ? 'checked' : ''} style="width:auto;">
                                    </div>

                                    <div class="form-group">
                                        <label>Clasificación por edad</label>
                                        <select id="edit-profile-maturity" style="background:#333;">
                                            <option value="all" ${p.maturity === 'all' ? 'selected' : ''}>Todo público</option>
                                            <option value="7+" ${p.maturity === '7+' ? 'selected' : ''}>7+</option>
                                            <option value="13+" ${p.maturity === '13+' ? 'selected' : ''}>13+</option>
                                            <option value="16+" ${p.maturity === '16+' ? 'selected' : ''}>16+</option>
                                            <option value="18+" ${p.maturity === '18+' ? 'selected' : ''}>18+</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Bloqueo de Perfil (PIN)</label>
                                        <input type="text" id="edit-profile-pin" value="${p.pin || ''}" maxlength="4" placeholder="4 dígitos (opcional)" style="background:#333; letter-spacing: 2px;" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                                        <small style="color:#888;">Deja en blanco para desactivar.</small>
                                    </div>
                                    
                                    <div style="margin-top:2rem;">
                                        <button class="btn btn-secondary" onclick="app.viewHistory(${p.id})" style="width:100%; justify-content:space-between;">
                                            <span>Historial de visualización</span>
                                            <i class="ri-arrow-right-s-line"></i>
                                        </button>
                                    </div>

                                    <div style="margin-top:1rem;">
                                        <button class="btn btn-secondary" onclick="app.showToast('Configuración de subtítulos próximamente')" style="width:100%; justify-content:space-between;">
                                            <span>Aspecto de los subtítulos</span>
                                            <i class="ri-arrow-right-s-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1.5rem;">
                            <button class="btn btn-danger" onclick="app.deleteProfile(${p.id})">Eliminar Perfil</button>
                            <div style="display:flex; gap:1rem;">
                                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                <button class="btn btn-primary" onclick="app.handleEditProfile(${p.id})">Guardar</button>
                            </div>
                        </div>
                    </div>
                `);
            },

            viewHistory: (profileId) => {
                const p = app.state.user.profiles.find(x => x.id === profileId);
                if(!p) return;
                
                const history = p.continueWatching || [];
                
                openModal(`
                    <div style="padding:2rem; max-width:800px; margin:0 auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem;">
                            <h2 style="font-size:2rem;">Historial de ${p.name}</h2>
                            <button class="btn btn-secondary" onclick="app.editProfile(${p.id})">Volver</button>
                        </div>
                        
                        ${history.length === 0 ? '<p style="color:#ccc;">No hay historial de visualización.</p>' : `
                            <div style="display:flex; flex-direction:column; gap:1rem; max-height:60vh; overflow-y:auto;">
                                ${history.map(h => {
                                    const item = allItems.find(i => i.id === (h.seriesId || h.itemId));
                                    if(!item) return '';
                                    return `
                                      <div style="display:flex; gap:1rem; align-items:center; background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px;">
                                          <img src="${item.img}" alt="${item.title}" style="width:100px; aspect-ratio:16/9; object-fit:cover; border-radius:4px;">
                                          <div style="flex:1;">
                                              <h4 style="font-size:1.1rem; margin-bottom:0.5rem;">${item.title}</h4>
                                                <div style="font-size:0.9rem; color:#aaa;">
                                                    Visto el ${new Date(h.timestamp || Date.now()).toLocaleDateString()}
                                                </div>
                                                <div style="height:4px; background:rgba(255,255,255,0.1); margin-top:0.5rem; border-radius:2px; overflow:hidden;">
                                                    <div style="height:100%; width:${Math.min(100, (h.time/h.duration)*100)}%; background:var(--color-brand-primary);"></div>
                                                </div>
                                            </div>
                                            <button class="btn btn-icon" onclick="app.removeFromHistory(${p.id}, ${h.itemId}, ${h.seriesId || 'null'})"><i class="ri-delete-bin-line"></i></button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `);
            },
            
            removeFromHistory: async (pId, itemId, seriesId) => {
                const pIndex = app.state.user.profiles.findIndex(x => x.id === pId);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex].continueWatching = (app.state.user.profiles[pIndex].continueWatching || []).filter(h => 
                        !((h.itemId === itemId) && (seriesId === null ? !h.seriesId : h.seriesId === seriesId))
                    );
                    await app.saveDB({ users: allUsers });
                    app.viewHistory(pId);
                }
            },

            configureSubtitles: (id) => {
                const p = app.state.user.profiles.find(x => x.id === id);
                if(!p) return;
                
                // Default settings
                const settings = p.subtitleSettings || {
                    font: 'sans-serif',
                    size: 'medium', // small, medium, large
                    color: 'white',
                    shadow: 'drop-shadow'
                };
                
                openModal(`
                    <div style="padding:2rem; max-width:600px; margin:0 auto;">
                        <h2 style="margin-bottom:1.5rem;">Aspecto de los subtítulos</h2>
                        
                        <div style="background:#333; height:200px; display:flex; align-items:flex-end; justify-content:center; margin-bottom:2rem; border-radius:8px; overflow:hidden; position:relative; background-image:url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80'); background-size:cover;">
                            <div style="padding:20px; text-align:center;">
                                <span id="sub-preview" style="
                                    font-family: ${settings.font}; 
                                    font-size: ${settings.size === 'small' ? '1rem' : settings.size === 'large' ? '2rem' : '1.5rem'}; 
                                    color: ${settings.color}; 
                                    text-shadow: ${settings.shadow === 'drop-shadow' ? '2px 2px 4px rgba(0,0,0,0.8)' : settings.shadow === 'outline' ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none'};
                                    background: ${settings.shadow === 'box' ? 'rgba(0,0,0,0.5)' : 'transparent'};
                                    padding: 5px 10px;
                                    transition: all 0.3s;
                                ">
                                    Así se verán los subtítulos en tus dispositivos.
                                </span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Fuente</label>
                            <select id="sub-font" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="sans-serif" ${settings.font==='sans-serif'?'selected':''}>Sans Serif</option>
                                <option value="serif" ${settings.font==='serif'?'selected':''}>Serif</option>
                                <option value="monospace" ${settings.font==='monospace'?'selected':''}>Monospace</option>
                                <option value="cursive" ${settings.font==='cursive'?'selected':''}>Manuscrita</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Tamaño</label>
                            <select id="sub-size" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="small" ${settings.size==='small'?'selected':''}>Pequeño</option>
                                <option value="medium" ${settings.size==='medium'?'selected':''}>Mediano</option>
                                <option value="large" ${settings.size==='large'?'selected':''}>Grande</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Sombra / Fondo</label>
                            <select id="sub-shadow" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="drop-shadow" ${settings.shadow==='drop-shadow'?'selected':''}>Sombra paralela</option>
                                <option value="outline" ${settings.shadow==='outline'?'selected':''}>Contorno</option>
                                <option value="box" ${settings.shadow==='box'?'selected':''}>Caja oscura</option>
                                <option value="none" ${settings.shadow==='none'?'selected':''}>Ninguno</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Color de Texto</label>
                            <div style="display:flex; gap:10px;">
                                ${['white', 'yellow', 'cyan', 'lime'].map(c => `
                                    <div onclick="document.getElementById('sub-color').value='${c}'; app.updateSubPreview(); document.querySelectorAll('.color-opt').forEach(el=>el.style.borderColor='transparent'); this.style.borderColor='white';" 
                                        class="color-opt"
                                        style="width:30px; height:30px; background:${c}; border-radius:50%; cursor:pointer; border:2px solid ${settings.color===c?'white':'transparent'};"></div>
                                `).join('')}
                                <input type="hidden" id="sub-color" value="${settings.color}">
                            </div>
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                            <button class="btn btn-secondary" onclick="app.editProfile(${p.id})">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.saveSubtitles(${p.id})">Guardar</button>
                        </div>
                    </div>
                `);
            },

            updateSubPreview: () => {
                const font = document.getElementById('sub-font').value;
                const size = document.getElementById('sub-size').value;
                const shadow = document.getElementById('sub-shadow').value;
                const color = document.getElementById('sub-color').value;
                
                const el = document.getElementById('sub-preview');
                if(!el) return;
                
                el.style.fontFamily = font;
                el.style.fontSize = size === 'small' ? '1rem' : size === 'large' ? '2rem' : '1.5rem';
                el.style.color = color;
                
                el.style.textShadow = shadow === 'drop-shadow' ? '2px 2px 4px rgba(0,0,0,0.8)' : shadow === 'outline' ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none';
                el.style.background = shadow === 'box' ? 'rgba(0,0,0,0.5)' : 'transparent';
            },

            saveSubtitles: async (id) => {
                const font = document.getElementById('sub-font').value;
                const size = document.getElementById('sub-size').value;
                const shadow = document.getElementById('sub-shadow').value;
                const color = document.getElementById('sub-color').value;
                
                const pIndex = app.state.user.profiles.findIndex(x => x.id === id);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex].subtitleSettings = { font, size, shadow, color };
                    await app.saveDB({ users: allUsers });
                    
                    // Update current if needed
                    if(app.state.currentProfile && app.state.currentProfile.id === id) {
                        app.state.currentProfile = app.state.user.profiles[pIndex];
                        localStorage.setItem('niro_profile', JSON.stringify(app.state.currentProfile));
                    }
                    
                    app.editProfile(id); // Go back
                    app.showToast("Subtítulos guardados");
                }
            },

            handleEditProfile: async (id) => {
                const name = document.getElementById('edit-profile-name').value;
                const avatar = document.getElementById('edit-profile-avatar').value;
                const autoplayNext = document.getElementById('edit-profile-autoplay-next').checked;
                const autoplayPreviews = document.getElementById('edit-profile-autoplay-previews').checked;
                const maturity = document.getElementById('edit-profile-maturity').value;
                const language = document.getElementById('edit-profile-language').value;
                const pin = document.getElementById('edit-profile-pin').value;
                
                if(!name) {
                    app.showToast("El nombre es requerido", "error");
                    return;
                }
                
                const pIndex = app.state.user.profiles.findIndex(x => x.id === id);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex] = {
                        ...app.state.user.profiles[pIndex],
                        name,
                        avatar,
                        autoplayNext,
                        autoplayPreviews,
                        maturity,
                        language,
                        pin
                    };
                    
                    await app.saveDB({ users: allUsers });
                    
                    // Update current profile if it's the one being edited
                    if(app.state.currentProfile && app.state.currentProfile.id === id) {
                        app.state.currentProfile = app.state.user.profiles[pIndex];
                        localStorage.setItem('niro_profile', JSON.stringify(app.state.currentProfile));
                        app.renderHeader();
                    }
                    
                    closeModal();
                    app.manageProfiles();
                }
            },

            manageProfiles: () => {
                const user = app.state.user;
                if(!user || !user.profiles) return;

                document.getElementById('main-header').style.display = 'none';
                document.body.classList.add('in-profile-gate');
                
                const main = document.getElementById('main-view');
                main.innerHTML = `
                    <div class="profile-gate-container" style="min-height:100vh; padding:100px 20px; display:flex; flex-direction:column; align-items:center; animation:fadeIn 0.5s;">
                        <h1 style="font-size:3rem; font-weight:500; margin-bottom:3rem; text-align:center;">Administrar Perfiles</h1>
                        
                        <div class="profiles-grid" style="display:flex; gap:2rem; flex-wrap:wrap; justify-content:center; margin-bottom:4rem;">
                            ${user.profiles.map(p => `
                                <div class="profile-item" style="text-align:center; position:relative; cursor:pointer;" onclick="app.editProfile(${p.id})">
                                    <div class="profile-avatar-wrapper" style="width:10vw; height:10vw; min-width:120px; min-height:120px; max-width:200px; max-height:200px; border-radius:8px; overflow:hidden; margin-bottom:1rem; position:relative;">
                                        <img src="${p.avatar}" alt="${p.name}" style="width:100%; height:100%; object-fit:cover; opacity:0.6; transition:opacity 0.3s;">
                                        <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
                                            <div style="width:50px; height:50px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; color:white;">
                                                <i class="ri-pencil-fill" style="font-size:1.5rem;"></i>
                                            </div>
                                        </div>
                                        ${p.pin ? '<div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:4px; border-radius:50%;"><i class="ri-lock-fill" style="color:white;"></i></div>' : ''}
                                    </div>
                                    <span style="font-size:1.2rem; color:#808080;">${p.name}</span>
                                </div>
                            `).join('')}
                            
                            <div class="profile-item" onclick="app.promptAddProfile()" style="text-align:center; cursor:pointer;">
                                <div class="profile-avatar-wrapper" style="width:10vw; height:10vw; min-width:120px; min-height:120px; max-width:200px; max-height:200px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:transparent; border:1px solid #808080; color:#808080; transition:all 0.2s; margin-bottom:1rem;">
                                    <i class="ri-add-line" style="font-size:3rem;"></i>
                                </div>
                                <span style="font-size:1.2rem; color:#808080;">Agregar Perfil</span>
                            </div>
                        </div>
                        
                        <button onclick="app.renderProfiles()" class="btn" style="background:white; color:black; padding:10px 40px; letter-spacing:1px; font-size:1.1rem; font-weight:bold; border-radius:4px;">LISTO</button>
                    </div>
                `;
            },

            deleteProfile: async (id) => {
                if(app.state.user.profiles.length <= 1) {
                    app.showToast("Debe haber al menos un perfil.", "error");
                    return;
                }
                
                app.confirmAction("¿Eliminar este perfil y todo su historial?", async () => {
                    app.state.user.profiles = app.state.user.profiles.filter(p => p.id !== id);
                    await app.saveDB({ users: allUsers });
                    app.manageProfiles(); // Refresh modal
                });
            },

            toggleMyList: async (itemId) => {
                if(!app.state.user) return app.router('login');
                const user = app.state.user;
                if(!user.myList) user.myList = [];
                
                // Use loose equality to handle string/number ID mismatch
                const idx = user.myList.findIndex(id => id == itemId);
                if(idx > -1) {
                    user.myList.splice(idx, 1);
                    app.showToast("Eliminado de Mi Lista");
                } else {
                    user.myList.push(itemId);
                    app.showToast("Agregado a Mi Lista");
                }
                
                // Update button if exists
                const btn = document.getElementById(`btn-mylist-${itemId}`);
                if(btn) {
                    const inList = idx === -1; // We just added it
                    btn.className = `btn ${inList ? 'btn-primary' : 'btn-secondary'}`;
                    btn.innerHTML = `<i class="${inList ? 'ri-check-line' : 'ri-add-line'}"></i> ${inList ? 'En mi lista' : 'Mi Lista'}`;
                }
                
                // Refresh if on My List view to prevent stale items - Optimized to avoid full re-render
                if(app.state.route === 'mylist') {
                     const card = document.getElementById(`card-${itemId}`);
                     if(card) {
                         // Animate removal if we are removing
                         if(idx > -1) {
                             card.style.transition = 'all 0.3s ease';
                             card.style.opacity = '0';
                             card.style.transform = 'scale(0.9)';
                             setTimeout(() => {
                                 card.remove();
                                 // Check if empty
                                 if(!user.myList || user.myList.length === 0) {
                                    app.renderHome('mylist'); // Show empty state
                                 }
                             }, 300);
                         }
                     } else if (idx === -1) {
                         // We added an item while on my list view? (Rare, but possible if undoing)
                         // In this case, a full refresh is safer to put it in correct order
                         setTimeout(() => app.renderHome('mylist'), 100);
                     }
                }

                // Persist
                const uIdx = allUsers.findIndex(u => u.email === user.email);
                if(uIdx > -1) {
                    allUsers[uIdx] = user;
                    await app.saveDB({ users: allUsers });
                    localStorage.setItem('niro_user', JSON.stringify(user));
                }
            },

            downloadItem: async (id, parentId = null) => {
                let item, videoUrl, title, poster, type, downloadId;

                if (parentId) {
                    // It's an episode
                    const parent = allItems.find(i => i.id === parentId);
                    if (!parent) return;
                    
                    let episode;
                    for (const s of parent.seasons) {
                        episode = s.episodes.find(e => e.id === id);
                        if (episode) break;
                    }
                    if (!episode) return;

                    item = { ...episode, type: 'episode', parentId: parent.id };
                    videoUrl = episode.video;
                    title = `${parent.title} - ${episode.title}`;
                    poster = episode.img || parent.img;
                    type = 'series';
                    downloadId = episode.id;
                } else {
                    // Movie
                    item = allItems.find(i => i.id === id);
                    if (!item) return;
                    
                    if (item.type === 'series') {
                        const epsContainer = document.getElementById('episodes-container');
                        if(epsContainer) {
                            epsContainer.scrollIntoView({behavior: 'smooth'});
                            app.showToast("Selecciona un episodio de la lista para descargar.", "info");
                        } else {
                            app.showToast("No hay episodios disponibles para descargar.", "error");
                        }
                        return;
                    }

                    if (item.type !== 'movie' || !item.video) {
                        app.showToast("Contenido no disponible para descarga.", "info");
                        return;
                    }
                    
                    videoUrl = item.video;
                    title = item.title;
                    poster = item.img;
                    type = item.type;
                    downloadId = item.id;
                }

                if (await DownloadManager.has(downloadId)) {
                     app.confirmAction("¿Eliminar descarga de este dispositivo?", async () => {
                         await DownloadManager.remove(downloadId);
                         app.showToast("Descarga eliminada");
                         openDetails(parentId || downloadId); // Refresh UI
                     });
                     return;
                }

                app.showToast("Iniciando descarga...", "info");
                const btn = document.getElementById(`btn-download-${downloadId}`);
                let originalContent = '';
                if(btn) {
                    originalContent = btn.innerHTML;
                    btn.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> 0%`;
                    btn.disabled = true;
                }

                try {
                    await DownloadManager.save(downloadId, videoUrl, {
                        title: title,
                        poster: poster,
                        type: type,
                        desc: item.desc || '',
                        year: item.year || '',
                        genre: item.genre || '',
                        rating: item.rating || '',
                        parentId: parentId
                    }, (progress) => {
                        if(btn) btn.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> ${(progress*100).toFixed(0)}%`;
                    });
                    
                    app.showToast("Descarga completada", "success");
                    openDetails(parentId || downloadId); // Refresh UI
                } catch(e) {
                    console.error(e);
                    app.showToast("Error en la descarga. Verifica tu conexión.", "error");
                    if(btn) {
                        btn.innerHTML = originalContent || `<i class="ri-download-line"></i>`;
                        btn.disabled = false;
                    }
                }
            },

            installApp: async () => {
                const ua = navigator.userAgent.toLowerCase();
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
                const isMac = /macintosh|mac os x/i.test(ua);
                
                // Logic: Mobile -> PWA, Mac -> PWA Instructions, PC -> EXE
                
                if (isMobile) {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            deferredPrompt = null;
                            app.renderHeader();
                        }
                    } else {
                        if (/iphone|ipad|ipod/.test(ua)) {
                            app.showToast("En iOS: Pulsa el botón 'Compartir' y elige 'Agregar a Inicio'.", "info");
                        } else {
                            app.showToast("Usa el menú de tu navegador y selecciona 'Instalar aplicación'.", "info");
                        }
                    }
                } else if (isMac) {
                    // Mac PWA instructions with visual feedback
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                    } else {
                        // Create modal for Mac instructions
                        const modalHtml = `
                            <div style="text-align:center; padding:20px;">
                                <i class="ri-apple-fill" style="font-size:3rem; margin-bottom:15px;"></i>
                                <h3 style="margin-bottom:15px;">Instalar en Mac</h3>
                                <p style="margin-bottom:20px; color:#ccc;">Para instalar NIRO en tu Mac:</p>
                                <ol style="text-align:left; display:inline-block; color:#ccc; line-height:1.6;">
                                    <li>1. Abre <strong>Safari</strong> o <strong>Chrome</strong></li>
                                    <li>2. Ve al menú del navegador o botón compartir</li>
                                    <li>3. Selecciona <strong>"Agregar al Dock"</strong> o <strong>"Crear acceso directo"</strong></li>
                                </ol>
                                <button class="btn btn-primary" onclick="closeModal()" style="margin-top:20px; width:100%;">Entendido</button>
                            </div>
                        `;
                        openModal(modalHtml);
                    }
                } else {
                    // PC / Windows -> Download EXE directly
                    const a = document.createElement('a');
                    a.href = '/NIRO_App.exe';
                    a.download = 'NIRO.exe';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    app.showToast("Descargando aplicación NIRO...", "success");
                }
            },

            toggleNotifications: () => {
                const menu = document.getElementById('notification-dropdown');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },

            toggleContinueMenu: () => {
                const menu = document.getElementById('continue-dropdown-menu');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },
            
            toggleProfileMenu: () => {
                const menu = document.getElementById('profile-dropdown-menu');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },

            handleSearch: (query) => {
                const resultsContainer = document.getElementById('search-results-dropdown');
                if (!query || query.trim().length === 0) {
                    if (resultsContainer) resultsContainer.style.display = 'none';
                    return;
                }

                const q = query.toLowerCase();
                const matches = allItems.filter(item => 
                    item.title.toLowerCase().includes(q) || 
                    (item.genre && item.genre.toLowerCase().includes(q)) ||
                    (item.description && item.description.toLowerCase().includes(q))
                ).slice(0, 10); // Limit to 10 results

                if (resultsContainer) {
                    if (matches.length > 0) {
                        resultsContainer.innerHTML = matches.map(item => `
                            <div onclick="openDetails(${item.id}); document.getElementById('search-results-dropdown').style.display='none';" 
                                 style="padding:10px; display:flex; gap:10px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); align-items:center;">
                                <img src="${item.poster || item.img}" style="width:50px; height:75px; object-fit:cover; border-radius:4px;">
                                <div>
                                    <div style="font-weight:bold; font-size:0.9rem; color:white;">${item.title}</div>
                                    <div style="font-size:0.8rem; color:#aaa;">${item.year || ''} • ${item.genre || 'Desconocido'}</div>
                                </div>
                            </div>
                        `).join('');
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = `<div style="padding:15px; text-align:center; color:#aaa;">No se encontraron resultados</div>`;
                        resultsContainer.style.display = 'block';
                    }
                }
            },

            isApp: () => {
                return window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone || 
                       window.pywebview !== undefined ||
                       /NIRO_App/.test(navigator.userAgent);
            },

            renderHeader: () => {
                const h = document.getElementById('main-header');
                const user = app.state.user;
                const profile = app.state.currentProfile;
                const showInstall = !app.isApp();
                
                h.innerHTML = `
                    <div class="header-content">
                        <a href="#" class="logo" onclick="app.router('home')" style="display:flex;align-items:center;">
                            <img src="Niro_original.png" alt="NIRO" style="height:40px; width:auto;">
                        </a>
                        <nav class="nav-menu">
                            <a class="nav-link ${app.state.route==='home'?'active':''}" onclick="app.router('home')">Inicio</a>
                            <a class="nav-link ${app.state.route==='series'?'active':''}" onclick="app.router('series')">Series</a>
                            <a class="nav-link ${app.state.route==='movies'?'active':''}" onclick="app.router('movies')">Películas</a>
                            <a class="nav-link ${app.state.route==='downloads'?'active':''}" onclick="app.router('downloads')">Descargas</a>
                            ${user && user.role === 'admin' ? `<a class="nav-link ${app.state.route==='admin'?'active':''}" onclick="app.router('admin')">Admin</a>` : ''}
                        </nav>
                        
                        <div style="margin-left:auto; display:flex; align-items:center; gap:20px;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div class="search-bar" style="position:relative;">
                                    <i class="ri-search-line" style="color:var(--color-text-secondary);"></i>
                                    <input type="text" class="search-input" placeholder="Buscar..." oninput="app.handleSearch(this.value)" onfocus="app.handleSearch(this.value)" onblur="setTimeout(() => { if(document.getElementById('search-results-dropdown')) document.getElementById('search-results-dropdown').style.display='none' }, 200)">
                                    <div id="search-results-dropdown" style="display:none; position:absolute; top:110%; left:0; right:0; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; max-height:400px; overflow-y:auto; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.8);"></div>
                                </div>
                                ${user ? `
                                    <div style="position:relative;">
                                        <div style="cursor:pointer; position:relative;" onclick="app.toggleNotifications()">
                                            <i class="ri-notification-3-line" style="font-size:1.2rem; color:var(--color-text-secondary);"></i>
                                            <span style="position:absolute; top:-2px; right:-2px; width:8px; height:8px; background:var(--color-brand-accent); border-radius:50%;"></span>
                                        </div>
                                        <div id="notification-dropdown" style="display:none; position:absolute; top:120%; right:0; width:300px; background:rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:0; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            <div style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:bold; font-size:0.9rem;">Notificaciones</div>
                                            <div style="max-height:300px; overflow-y:auto;">
                                                <div style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; gap:10px; align-items:center;">
                                                    <div style="width:40px; height:60px; background:rgba(255,255,255,0.1); border-radius:4px; display:flex; align-items:center; justify-content:center;"><i class="ri-film-line"></i></div>
                                                    <div>
                                                        <div style="font-size:0.85rem; color:white;">Nuevo contenido añadido</div>
                                                        <div style="font-size:0.7rem; color:#aaa;">Explora las novedades de hoy</div>
                                                    </div>
                                                </div>
                                                <div style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; gap:10px; align-items:center;">
                                                    <div style="width:40px; height:60px; background:rgba(139, 92, 246, 0.2); border-radius:4px; display:flex; align-items:center; justify-content:center; color:var(--color-brand-primary);"><i class="ri-user-smile-line"></i></div>
                                                    <div>
                                                        <div style="font-size:0.85rem; color:white;">¡Bienvenido a Niro!</div>
                                                        <div style="font-size:0.7rem; color:#aaa;">Configura tu perfil ahora</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="header-actions" style="margin-left:0;">
                                ${!user ? `
                                    <button class="btn btn-primary" onclick="app.router('login')">Iniciar Sesión</button>
                                ` : `
                                    <!-- Continue Watching Dropdown Trigger -->
                                    <div style="position:relative; margin-right:15px;">
                                        <div onclick="app.toggleContinueMenu()" style="cursor:pointer; width:32px; height:32px; display:flex; align-items:center; justify-content:center; position:relative;">
                                            <i class="ri-time-line" style="font-size:1.4rem; color:var(--color-text-secondary); transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--color-text-secondary)'"></i>
                                            ${(profile?.continueWatching?.length > 0) ? `<div style="position:absolute; top:2px; right:2px; width:8px; height:8px; background:var(--color-brand-primary); border-radius:50%; border:1px solid #000;"></div>` : ''}
                                        </div>

                                        <div id="continue-dropdown-menu" style="display:none; position:absolute; top:120%; right:-50px; width:320px; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:15px; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            <h4 style="margin-bottom:12px; font-size:0.9rem; color:#aaa; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                                                Continuar Viendo
                                                <span style="font-size:0.7rem; color:var(--color-brand-primary); cursor:pointer;" onclick="app.router('continue')">Ver Todo</span>
                                            </h4>
                                            
                                            <div style="display:flex; flex-direction:column; gap:10px;">
                                            ${(profile?.continueWatching || []).slice(0, 3).map(cw => {
                                                const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                                                if(!realItem) return '';
                                                const pct = (cw.time / cw.duration) * 100;
                                                // If series, get ep title
                                                let subTitle = cw.title || 'Continuar';
                                                
                                                return `
                                                    <div onclick="playItem(${realItem.id})" style="display:flex; gap:12px; cursor:pointer; group:hover; padding:5px; border-radius:6px; transition:0.2s; background:rgba(255,255,255,0.02);" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                                                        <div style="position:relative; width:110px; height:62px; flex-shrink:0; border-radius:4px; overflow:hidden;">
                                                            <img src="${realItem.img}" style="width:100%; height:100%; object-fit:cover;">
                                                            <div style="position:absolute; bottom:0; left:0; right:0; height:3px; background:rgba(255,255,255,0.3);">
                                                                <div style="width:${pct}%; height:100%; background:var(--color-brand-primary);"></div>
                                                            </div>
                                                            <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
                                                                <i class="ri-play-fill" style="color:white;"></i>
                                                            </div>
                                                        </div>
                                                        <div style="flex:1; overflow:hidden; display:flex; flex-direction:column; justify-content:center;">
                                                            <div style="font-size:0.9rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white;">${realItem.title}</div>
                                                            <div style="font-size:0.75rem; color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${subTitle}</div>
                                                            <div style="font-size:0.7rem; color:var(--color-brand-primary); margin-top:2px;">Restante: ${Math.floor((cw.duration - cw.time)/60)} min</div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                            </div>

                                            ${(!profile?.continueWatching || profile.continueWatching.length === 0) ? '<div style="color:#666; font-size:0.85rem; text-align:center; padding:20px 0;">No tienes contenido pendiente</div>' : ''}
                                        </div>
                                    </div>

                                    <div style="position:relative;">
                                        <div class="profile-dropdown-trigger" onclick="app.toggleProfileMenu()" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                            <div class="profile-avatar" style="width:32px; height:32px; border-radius:4px; background-image:url('${profile ? profile.avatar : ''}'); background-size:cover;"></div>
                                            <i class="ri-arrow-down-s-fill" style="color:white; font-size:0.8rem;"></i>
                                        </div>
                                        
                                        <div id="profile-dropdown-menu" style="display:none; position:absolute; top:120%; right:0; width:200px; background:rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:10px 0; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            ${user.profiles.map(p => `
                                                <div onclick="app.selectProfile(${p.id})" style="padding:10px 20px; display:flex; align-items:center; gap:10px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05);">
                                                    <img src="${p.avatar}" alt="${p.name}" style="width:32px; height:32px; border-radius:4px; object-fit:cover;">
                                                    <span style="font-size:0.9rem; ${p.id === profile?.id ? 'font-weight:bold;' : 'color:#aaa;'}">${p.name}</span>
                                                </div>
                                            `).join('')}
                                            
                                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>

                                            <div onclick="app.router('account')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px;">
                                                <i class="ri-user-settings-line"></i> Cuenta
                                            </div>
                                            <div onclick="app.router('profiles')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px;">
                                                <i class="ri-arrow-left-right-line"></i> Cambiar de perfil
                                            </div>
                                            
                                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                                    
                            ${showInstall ? `
                                <div onclick="app.installApp()" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:var(--color-brand-accent); font-weight:bold; display:flex; align-items:center; gap:8px;">
                                    <i class="ri-download-cloud-2-line"></i> Instalar App
                                </div>
                            ` : ''}
                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                            <a href="/NIRO_App.exe" download style="text-decoration:none;">
                                <div style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:var(--color-text-secondary); display:flex; align-items:center; gap:8px;">
                                    <i class="ri-windows-fill"></i> Descargar App PC
                                </div>
                            </a>
                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                            <div onclick="app.logout()" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc;">Cerrar sesión</div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            },

            deleteDownload: async (id, isFolder=false) => {
                app.confirmAction(isFolder ? "¿Eliminar toda la serie de descargas?" : "¿Eliminar esta descarga?", async () => {
                    if(isFolder) {
                        const downloads = await DownloadManager.list();
                        const toDelete = downloads.filter(d => d.parentId == id || d.seriesId == id);
                        for(const d of toDelete) {
                            await DownloadManager.remove(d.id);
                        }
                    } else {
                        await DownloadManager.remove(id);
                    }
                    app.showToast("Contenido eliminado");
                    app.renderDownloads();
                });
            },

            renderDownloads: async () => {
                const main = document.getElementById('main-view');
                const viewingSeriesId = app.state.viewingDownloadSeriesId;
                
                main.innerHTML = `
                    <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto; text-align:center;">
                        <i class="ri-download-cloud-2-line" style="font-size:4rem; color:var(--color-text-secondary);"></i>
                        <h2 style="margin:1rem 0 2rem;">Mis Descargas</h2>
                        ${viewingSeriesId ? `<button onclick="app.state.viewingDownloadSeriesId=null; app.renderDownloads()" class="btn btn-secondary" style="margin-bottom:1rem;"><i class="ri-arrow-left-line"></i> Volver</button>` : ''}
                        <div id="downloads-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:1.5rem; text-align:left;">
                            <div style="grid-column:1/-1; text-align:center;">Cargando...</div>
                        </div>
                    </div>
                `;
                
                try {
                    const downloads = await DownloadManager.list();
                    const grid = document.getElementById('downloads-grid');
                    
                    if (downloads.length === 0) {
                        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#888;">No tienes contenido descargado.</p>';
                        return;
                    }

                    if (viewingSeriesId) {
                        // Render episodes of specific series
                        const episodes = downloads.filter(d => d.parentId == viewingSeriesId || d.seriesId == viewingSeriesId);
                        if(episodes.length === 0) {
                             app.state.viewingDownloadSeriesId = null;
                             app.renderDownloads();
                             return;
                        }
                        
                        grid.innerHTML = episodes.map(d => `
                            <div class="card" onclick="playItem(${d.id})" style="flex:auto; aspect-ratio:16/9; position:relative;">
                                <button onclick="event.stopPropagation(); app.deleteDownload(${d.id})" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                    ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-movie-2-line" style="font-size:2rem;"></i>'}
                                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;">
                                        <i class="ri-play-circle-line" style="font-size:3rem; color:white; opacity:0.8;"></i>
                                    </div>
                                </div>
                                <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                    <h4 style="font-size:0.9rem;">${d.title}</h4>
                                    <span style="font-size:0.7rem; color:#ccc;">${(d.size / (1024*1024)).toFixed(1)} MB</span>
                                </div>
                            </div>
                        `).join('');

                    } else {
                        // Group by Series
                        const groups = {};
                        const items = [];
                        
                        for(const d of downloads) {
                            if(d.type === 'series' || d.parentId) {
                                const pId = d.parentId || 'unknown';
                                if(!groups[pId]) {
                                    const realSeries = allItems.find(i => i.id == pId);
                                    groups[pId] = {
                                        id: pId,
                                        title: realSeries ? realSeries.title : (d.title.split(' - ')[0] || 'Serie'),
                                        poster: realSeries ? realSeries.img : d.poster,
                                        type: 'series-folder',
                                        count: 0
                                    };
                                }
                                groups[pId].count++;
                            } else {
                                items.push(d);
                            }
                        }
                        
                        const finalItems = [...items, ...Object.values(groups)];
                        
                        grid.innerHTML = finalItems.map(d => {
                            if(d.type === 'series-folder') {
                                return `
                                    <div class="card" onclick="app.state.viewingDownloadSeriesId='${d.id}'; app.renderDownloads()" style="flex:auto; aspect-ratio:2/3; position:relative;">
                                        <button onclick="event.stopPropagation(); app.deleteDownload('${d.id}', true)" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar Serie">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                        <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                            ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-tv-line" style="font-size:2rem;"></i>'}
                                        </div>
                                        <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                            <h4 style="font-size:0.9rem;">${d.title}</h4>
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <span style="font-size:0.7rem; background:var(--color-brand-primary); padding:2px 6px; border-radius:4px;">SERIE</span>
                                                <span style="font-size:0.7rem; color:#ccc;">${d.count} EPS</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="card" onclick="playItem(${d.id})" style="flex:auto; aspect-ratio:2/3; position:relative;">
                                        <button onclick="event.stopPropagation(); app.deleteDownload(${d.id})" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                        <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                            ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-movie-2-line" style="font-size:2rem;"></i>'}
                                        </div>
                                        <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                            <h4 style="font-size:0.9rem;">${d.title}</h4>
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <span style="font-size:0.7rem; background:var(--color-brand-primary); padding:2px 6px; border-radius:4px;">PELÍCULA</span>
                                                <span style="font-size:0.7rem; color:#ccc;">${(d.size / (1024*1024)).toFixed(1)} MB</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('');
                    }
                } catch(e) {
                    console.error(e);
                    document.getElementById('downloads-grid').innerText = "Error cargando descargas.";
                }
            },

            renderHome: async (filterType = null) => {
                const main = document.getElementById('main-view');
                const isOffline = !navigator.onLine;

                if (isOffline) {
                    app.renderDownloads();
                    return;
                }

                if(allItems.length === 0) {
                    main.innerHTML = `
                        <div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;">
                            <h1 style="font-size:3rem;margin-bottom:1rem;">Bienvenido a NIRO</h1>
                            <p style="color:var(--color-text-secondary);max-width:500px;margin-bottom:2rem;">La plataforma está lista. Inicia sesión como administrador para comenzar a agregar contenido.</p>
                            ${!app.state.user ? `<button class="btn btn-primary" onclick="app.router('login')">Iniciar Sesión Admin</button>` : ''}
                        </div>
                    `;
                    return;
                }

                // --- Search View ---
                if(app.state.searchQuery) {
                    const q = app.state.searchQuery;
                    const results = allItems.filter(i => i.title.toLowerCase().includes(q) || i.genre?.toLowerCase().includes(q));
                    
                    main.innerHTML = `
                        <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto;">
                            <h2 style="margin-bottom:2rem;">Resultados para "${q}"</h2>
                            ${results.length === 0 ? '<p>No se encontraron resultados.</p>' : `
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:1.5rem;">
                                    ${results.map(item => `
                                        <div class="card" onclick="openDetails(${item.id})" style="flex:auto; aspect-ratio:2/3;">
                                            <img src="${item.img}" class="card-img" loading="lazy">
                                            <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                                <h4 style="font-size:0.9rem;">${item.title}</h4>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    `;
                    return;
                }

                // --- Continue Watching View ---
                if(filterType === 'continue') {
                     if(!app.state.currentProfile) { app.router('profiles'); return; }
                     
                     const continueItems = (app.state.currentProfile.continueWatching || []).map(cw => {
                         const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                         if(!realItem) return null;
                         
                         let playParams = {};
                         if(cw.seriesId) {
                             if(realItem.seasons) {
                                for(const s of realItem.seasons) {
                                    const ep = s.episodes.find(e => e.id === cw.itemId);
                                    if(ep) {
                                        playParams = { video: ep.video, title: ep.title, itemId: ep.id, seriesId: realItem.id };
                                        break;
                                    }
                                }
                             }
                         } else {
                             playParams = { video: realItem.video, title: realItem.title, itemId: realItem.id, seriesId: null };
                         }
                         
                         if(!playParams.video) return null;
                         return { ...realItem, ...cw, playParams }; 
                     }).filter(i => i);

                     if(continueItems.length === 0) {
                        main.innerHTML = `
                            <div style="padding-top:150px;text-align:center;">
                                <i class="ri-time-line" style="font-size:4rem; color:var(--color-text-secondary); margin-bottom:1rem;"></i>
                                <h2>No tienes contenido pendiente.</h2>
                                <p style="color:var(--color-text-secondary);">Empieza a ver algo y aparecerá aquí.</p>
                            </div>
                        `;
                        return;
                     }

                     main.innerHTML = `
                        <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto;">
                            <h2 style="margin-bottom:2rem; display:flex; align-items:center; gap:10px;">
                                <i class="ri-time-line" style="color:var(--color-brand-primary);"></i> Continuar Viendo
                            </h2>
                            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:1.5rem;">
                                ${continueItems.map(item => `
                                    <div class="card" onclick="playItem(${item.id})" style="aspect-ratio:16/9;">
                                        <div style="position:relative; width:100%; height:100%;">
                                            <img src="${item.img}" class="card-img" style="object-fit:cover; width:100%; height:100%;" loading="lazy">
                                            <div style="position:absolute; inset:0; background:linear-gradient(to top, black, transparent 80%);"></div>
                                            
                                            <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.3);">
                                                <div style="height:100%;width:${(item.time/item.duration)*100}%;background:var(--color-brand-primary);"></div>
                                            </div>
                                            
                                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border:2px solid white; transition:transform 0.2s;" onmouseover="this.style.transform='translate(-50%,-50%) scale(1.1)'" onmouseout="this.style.transform='translate(-50%,-50%) scale(1)'">
                                                <i class="ri-play-fill" style="color:white;font-size:2rem;margin-left:4px;"></i>
                                            </div>

                                            <div style="position:absolute;bottom:10px;left:10px;right:10px;">
                                                <h4 style="font-size:1rem; text-shadow:0 2px 4px black;">${item.title}</h4>
                                                ${item.seriesId ? `<p style="font-size:0.8rem;color:#ccc; text-shadow:0 1px 2px black;">${item.playParams.title}</p>` : ''}
                                                <p style="font-size:0.7rem; color:var(--color-brand-primary); margin-top:2px;">Restante: ${Math.floor((item.duration - item.time)/60)} min</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                     `;
                     return;
                }

                // Filter items based on route & mood
                let displayItems = allItems;
                app.state.currentFilter = filterType; // Store for refresh

                if(filterType === 'mylist') {
                    if(!app.state.user) { app.router('login'); return; }
                    const list = app.state.user.myList || [];
                    displayItems = allItems.filter(i => list.includes(i.id));
                } else if(filterType) {
                    displayItems = allItems.filter(i => i.type === filterType);
                }
                
                if(app.state.currentMood) {
                    // Mock mood filtering logic mapping
                    const moodMap = {
                        'chill': ['Comedia', 'Documental', 'Romance'],
                        'intense': ['Acción', 'Terror', 'Suspenso'],
                        'magic': ['Fantasía', 'Ciencia Ficción', 'Aventura'],
                        'drama': ['Drama']
                    };
                    const allowedGenres = moodMap[app.state.currentMood] || [];
                    displayItems = displayItems.filter(i => allowedGenres.includes(i.genre));
                }

                if(displayItems.length === 0) {
                    main.innerHTML = `
                        <div style="padding-top:150px;text-align:center;">
                            <h2>No hay contenido en esta categoría/mood.</h2>
                            ${app.state.currentMood ? `<button class="btn btn-secondary" onclick="app.filterByMood(null)" style="margin-top:1rem;">Borrar Filtro de Mood</button>` : ''}
                        </div>
                    `;
                    return;
                }

                // Pick a hero (random or first from filtered)
                const heroItem = displayItems[Math.floor(Math.random() * displayItems.length)];
                
                let html = `
                    <div class="hero">
                        <div class="hero-bg" style="background-image: url('${heroItem.img}')"></div>
                        <div class="hero-overlay"></div>
                        <div class="hero-content">
                            <span style="background:rgba(255,255,255,0.2);backdrop-filter:blur(5px);padding:4px 10px;border-radius:4px;font-size:0.8rem;margin-bottom:1rem;display:inline-block;border:1px solid rgba(255,255,255,0.1);">DESTACADO</span>
                            <h1 class="hero-title">${heroItem.title}</h1>
                            <div class="hero-meta">
                                <span class="match-score">${heroItem.match || 98}% Match</span>
                                <span>${heroItem.year}</span>
                                <span style="border:1px solid rgba(255,255,255,0.3);padding:0 5px;border-radius:2px;">${heroItem.rating || '16+'}</span>
                            </div>
                            <p class="hero-desc">${heroItem.desc}</p>
                            <div style="display:flex;gap:1rem;">
                                <button class="btn btn-primary" onclick="playItem(${heroItem.id})"><i class="ri-play-fill"></i> Reproducir</button>
                                <button class="btn btn-secondary" onclick="openDetails(${heroItem.id})"><i class="ri-information-line"></i> Info</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding-bottom:100px; margin-top:-50px; position:relative; z-index:10;">
                        <!-- Mood Section -->
                        <div class="mood-section">
                            <p style="color:var(--color-text-secondary); text-transform:uppercase; letter-spacing:2px; font-size:0.8rem;">¿Qué vibe tienes hoy?</p>
                            <div class="mood-grid">
                                <div class="mood-chip ${app.state.currentMood==='chill'?'active':''}" onclick="app.filterByMood('chill')">☕ Chill & Relax</div>
                                <div class="mood-chip ${app.state.currentMood==='intense'?'active':''}" onclick="app.filterByMood('intense')">🔥 Intensidad</div>
                                <div class="mood-chip ${app.state.currentMood==='magic'?'active':''}" onclick="app.filterByMood('magic')">✨ Magia & Sci-Fi</div>
                                <div class="mood-chip ${app.state.currentMood==='drama'?'active':''}" onclick="app.filterByMood('drama')">🎭 Drama Puro</div>
                            </div>
                        </div>
                `;

                // Categories logic
                let categories = [];
                
                // Continue Watching Category
                if(!filterType && app.state.currentProfile && app.state.currentProfile.continueWatching && app.state.currentProfile.continueWatching.length > 0) {
                     const continueItems = app.state.currentProfile.continueWatching.map(cw => {
                         const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                         if(!realItem) return null;
                         
                         let playParams = {};
                         if(cw.seriesId) {
                             // It's an episode. Find it in seasons.
                             if(realItem.seasons) {
                                for(const s of realItem.seasons) {
                                    const ep = s.episodes.find(e => e.id === cw.itemId);
                                    if(ep) {
                                        playParams = { video: ep.video, title: ep.title, itemId: ep.id, seriesId: realItem.id };
                                        break;
                                    }
                                }
                             }
                         } else {
                             playParams = { video: realItem.video, title: realItem.title, itemId: realItem.id, seriesId: null };
                         }
                         
                         if(!playParams.video) return null; // Can't play if no video found

                         return { ...realItem, ...cw, playParams }; 
                     }).filter(i => i);

                     if(continueItems.length > 0) {
                        categories.push({
                            title: `Continuar viendo de ${app.state.currentProfile.name}`,
                            isContinueWatching: true,
                            items: continueItems
                        });
                     }
                }

                // Add "My List" if exists and not already on mylist page
                if(filterType !== 'mylist' && app.state.user && app.state.user.myList && app.state.user.myList.length > 0) {
                    categories.push({ 
                        title: "Mi Lista", 
                        filter: i => app.state.user.myList.includes(i.id) 
                    });
                }

                if(!filterType || filterType === 'mylist') {
                    categories.push(
                        { title: "Agregados Recientemente", filter: () => true },
                        { title: "Solo Películas", filter: i => i.type === 'movie' },
                        { title: "Series Binge-worthy", filter: i => i.type === 'series' }
                    );
                } else {
                    categories.push(
                        { title: filterType === 'movie' ? "Todas las Películas" : "Todas las Series", filter: i => i.type === filterType },
                        { title: "Recientes", filter: i => i.type === filterType }
                    );
                }

                categories.forEach(cat => {
                    let items;
                    if(cat.isContinueWatching) {
                        items = cat.items;
                    } else {
                        // Apply mood filter to categories as well if active
                        items = allItems.filter(cat.filter);
                        if(app.state.currentMood) {
                            const moodMap = {
                                'chill': ['Comedia', 'Documental', 'Romance'],
                                'intense': ['Acción', 'Terror', 'Suspenso'],
                                'magic': ['Fantasía', 'Ciencia Ficción', 'Aventura'],
                                'drama': ['Drama']
                            };
                            const allowedGenres = moodMap[app.state.currentMood] || [];
                            items = items.filter(i => allowedGenres.includes(i.genre));
                        }
                    }

                    if(items.length === 0) return;
                    
                    html += `
                        <section class="section">
                            <div class="section-header">
                                <h2 class="section-title">${cat.title}</h2>
                            </div>
                            <div class="slider-container">
                                <div class="slider-track">
                                    ${items.map(item => {
                                        const onclick = cat.isContinueWatching 
                                            ? `playItem(${item.id})`
                                            : `openDetails(${item.id})`;
                                            
                                        return `
                                        <div class="card" onclick="${onclick}">
                                            <div style="position:relative;">
                                                <img src="${item.img}" alt="${item.title}" class="card-img" loading="lazy">
                                                ${cat.isContinueWatching && item.duration ? `
                                                    <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.3);">
                                                        <div style="height:100%;width:${(item.time/item.duration)*100}%;background:var(--color-brand-primary);"></div>
                                                    </div>
                                                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border:2px solid white;">
                                                        <i class="ri-play-fill" style="color:white;font-size:1.5rem;margin-left:2px;"></i>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                                <h4 style="font-size:0.9rem;">${item.title}</h4>
                                                ${cat.isContinueWatching && item.seriesId ? `<p style="font-size:0.7rem;color:#ccc;">${item.playParams.title}</p>` : ''}
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        </section>
                    `;
                });

                html += `</div>`; // Closed container
                main.innerHTML = html;
            },

            renderLogin: () => {
                document.getElementById('main-view').innerHTML = `
                    <div style="height:100vh;display:flex;align-items:center;justify-content:center;background: url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80') center/cover;">
                        <div style="position:absolute;inset:0;background:rgba(15,7,32,0.85);backdrop-filter:blur(5px);"></div>
                        
                        <div class="auth-card">
                            <h2 style="text-align:center;margin-bottom:0.5rem;font-size:2.2rem;font-family:var(--font-display);">NIRO</h2>
                            <p style="text-align:center;color:var(--color-text-secondary);margin-bottom:2rem;">Bienvenido de nuevo</p>
                            
                            <form onsubmit="event.preventDefault(); app.login(this.email.value, this.pass.value)">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" required placeholder="tu@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Contraseña</label>
                                    <input type="password" name="pass" required placeholder="******">
                                </div>
                                
                                <div style="text-align:center; margin-top:2rem;">
                                    <button class="btn btn-primary" style="padding:0.8rem 3rem; min-width:150px;">Entrar</button>
                                </div>
                            </form>
                            <div style="margin-top:2rem;text-align:center;font-size:0.9rem;color:var(--color-text-secondary);">
                                ¿No tienes cuenta? <a onclick="app.router('register')" style="color:var(--color-brand-primary);font-weight:600;cursor:pointer;">Regístrate</a>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRegister: () => {
                document.getElementById('main-view').innerHTML = `
                    <div style="height:100vh;display:flex;align-items:center;justify-content:center;background: url('https://images.unsplash.com/photo-1574375927938-d5a98e8efe30?q=80') center/cover;">
                        <div style="position:absolute;inset:0;background:rgba(15,7,32,0.85);backdrop-filter:blur(5px);"></div>
                        
                        <div class="auth-card">
                            <h2 style="text-align:center;margin-bottom:0.5rem;font-size:2rem;font-family:var(--font-display);">Crear Cuenta</h2>
                            <p style="text-align:center;color:var(--color-text-secondary);margin-bottom:2rem;">Únete a la experiencia</p>
                            
                            <form onsubmit="event.preventDefault(); app.register(this.name.value, this.email.value, this.pass.value)">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" name="name" required placeholder="Tu nombre">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" required placeholder="tu@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Contraseña</label>
                                    <input type="password" name="pass" required placeholder="******">
                                </div>
                                
                                <div style="text-align:center; margin-top:2rem;">
                                    <button class="btn btn-primary" style="padding:0.8rem 3rem; min-width:150px;">Crear Cuenta</button>
                                </div>
                            </form>
                            <div style="margin-top:2rem;text-align:center;font-size:0.9rem;color:var(--color-text-secondary);">
                                ¿Ya tienes cuenta? <a onclick="app.router('login')" style="color:var(--color-brand-primary);font-weight:600;cursor:pointer;">Inicia sesión</a>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderProfile: async () => {
                const user = app.state.user;
                if(!user) { app.router('login'); return; }
                
                const profile = app.state.currentProfile;
                const nameToDisplay = profile ? profile.name : user.name;
                const avatarToDisplay = profile ? profile.avatar : (user.avatar || AVATARS[0]);

                // Get download stats
                const downloads = await DownloadManager.list();
                const totalSize = downloads.reduce((acc, curr) => acc + curr.size, 0);
                const sizeStr = (totalSize / (1024*1024)).toFixed(1) + ' MB';

                document.getElementById('main-view').innerHTML = `
                    <div style="padding-top:100px; width:var(--container-width); max-width:800px; margin:0 auto; padding-bottom: 80px;">
                        
                        <div style="display:flex; align-items:center; gap:2rem; margin-bottom:3rem; flex-wrap:wrap;">
                            <div style="position:relative; group:hover cursor:pointer;" onclick="${profile ? `app.editProfile(${profile.id})` : ''}">
                                <img src="${avatarToDisplay}" style="width:120px; height:120px; border-radius:12px; object-fit:cover; border:3px solid var(--color-brand-primary); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.2s; border-radius:12px; pointer-events:none;">
                                    <i class="ri-edit-line" style="font-size:2rem;"></i>
                                </div>
                            </div>
                            <div>
                                <h1 style="font-size:2.5rem; margin-bottom:0.5rem;">${nameToDisplay}</h1>
                                <div style="color:var(--color-text-secondary); font-size:1.1rem;">${user.email}</div>
                                <div style="margin-top:1rem; display:flex; gap:10px;">
                                    <span class="badge" style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:4px;">Miembro desde 2024</span>
                                    ${user.role === 'admin' ? '<span class="badge" style="background:var(--color-brand-primary); padding:5px 10px; border-radius:4px; color:black; font-weight:bold;">ADMIN</span>' : ''}
                                </div>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.5rem; margin-bottom:3rem;">
                            <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-list-check" style="font-size:2rem; color:var(--color-brand-primary); margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${user.myList?.length || 0}</div>
                                <div style="color:var(--color-text-secondary);">En Mi Lista</div>
                            </div>
                            <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-download-cloud-line" style="font-size:2rem; color:#60a5fa; margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${downloads.length}</div>
                                <div style="color:var(--color-text-secondary);">Descargas (${sizeStr})</div>
                            </div>
                             <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-time-line" style="font-size:2rem; color:#f472b6; margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${profile?.continueWatching?.length || 0}</div>
                                <div style="color:var(--color-text-secondary);">Viendo</div>
                            </div>
                        </div>

                        <div style="background:var(--color-bg-surface); padding:2rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin-bottom:1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem;">Configuración</h3>
                            <form onsubmit="event.preventDefault(); app.updateProfile(this)">
                                <div class="form-group">
                                    <label>Nombre de Usuario</label>
                                    <input type="text" name="name" value="${user.name}" required style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:10px; width:100%; color:white; border-radius:4px;">
                                </div>
                                <div class="form-group" style="margin-top:1rem;">
                                    <label>Cambiar Contraseña</label>
                                    <input type="password" name="password" placeholder="Nueva contraseña (opcional)" style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:10px; width:100%; color:white; border-radius:4px;">
                                </div>
                                <div style="margin-top:2rem; text-align:right;">
                                    <button class="btn btn-primary">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>

                        <div style="margin-top:2rem; text-align:center;">
                            <button onclick="app.logout()" style="background:none; border:1px solid #ef4444; color:#ef4444; padding:10px 20px; border-radius:4px; cursor:pointer; transition:0.2s;">
                                <i class="ri-logout-box-line"></i> Cerrar Sesión
                            </button>
                        </div>
                    </div>
                `;
            },
            
            updateProfile: async (form) => {
                const name = form.name.value;
                const password = form.password.value;
                
                const user = app.state.user;
                const userIdx = allUsers.findIndex(u => u.email === user.email);
                
                if(userIdx === -1) return;
                
                allUsers[userIdx].name = name;
                if(password) allUsers[userIdx].password = password;
                
                const success = await app.saveDB({ users: allUsers });
                if(success) {
                    app.state.user = allUsers[userIdx];
                    localStorage.setItem('niro_user', JSON.stringify(app.state.user));
                    app.renderHeader();
                    app.showToast("Perfil actualizado correctamente");
                }
            },

            /* --- Admin Panel --- */
            renderAdmin: () => {
                const main = document.getElementById('main-view');
                const tab = app.state.adminTab;
                
                // Calculate Stats
                const totalContent = allItems.length;
                const totalMovies = allItems.filter(i => i.type === 'movie').length;
                const totalSeries = allItems.filter(i => i.type === 'series').length;
                const totalUsers = allUsers.length;
                const pendingUsers = allUsers.filter(u => u.status === 'pending').length;

                let content = `
                    <div class="admin-container">
                        <div class="admin-header">
                            <h1 style="font-size:2rem;">Panel de Administración</h1>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="openAddContentModal()">
                                    <i class="ri-add-line"></i> Contenido
                                </button>
                                <button class="btn btn-primary" onclick="openAddUserModal()">
                                    <i class="ri-user-add-line"></i> Usuario
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-tabs">
                            <div class="admin-tab ${tab==='dashboard'?'active':''}" onclick="app.state.adminTab='dashboard';app.renderAdmin()">Dashboard</div>
                            <div class="admin-tab ${tab==='content'?'active':''}" onclick="app.state.adminTab='content';app.renderAdmin()">Contenido</div>
                            <div class="admin-tab ${tab==='users'?'active':''}" onclick="app.state.adminTab='users';app.renderAdmin()">Usuarios</div>
                            <div class="admin-tab ${tab==='requests'?'active':''}" onclick="app.state.adminTab='requests';app.renderAdmin()">Solicitudes ${pendingUsers > 0 ? `<span style="background:red;padding:0 6px;border-radius:10px;font-size:0.7rem;margin-left:5px;">${pendingUsers}</span>` : ''}</div>
                        </div>
                `;

                if (tab === 'dashboard') {
                    content += `
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.5rem; margin-bottom:2rem;">
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Total Contenido</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:white;">${totalContent}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Películas</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:var(--color-brand-accent);">${totalMovies}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Series</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:var(--color-brand-primary);">${totalSeries}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Usuarios</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:white;">${totalUsers}</div>
                            </div>
                        </div>
                        
                        <div style="background:var(--color-bg-surface); padding:2rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin-bottom:1rem;">Acciones Rápidas</h3>
                            <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                                <button class="btn btn-secondary" onclick="app.state.adminTab='content';app.renderAdmin()">Gestionar Contenido</button>
                                <button class="btn btn-secondary" onclick="app.state.adminTab='users';app.renderAdmin()">Gestionar Usuarios</button>
                                <button class="btn btn-secondary" onclick="openAddContentModal()">Subir Nuevo</button>
                            </div>
                        </div>
                    `;
                } else if(tab === 'content') {
                    content += `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Título</th>
                                    <th>Tipo</th>
                                    <th>Año</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allItems.map(item => `
                                    <tr>
                                        <td><img src="${item.img}" style="width:40px;height:60px;object-fit:cover;border-radius:4px;"></td>
                                        <td>${item.title}</td>
                                        <td><span style="background:${item.type==='series'?'var(--color-brand-primary)':'#2563eb'};padding:2px 8px;border-radius:4px;font-size:0.75rem;">${item.type==='series'?'Serie':'Película'}</span></td>
                                        <td>${item.year}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="openEditContentModal(${item.id})">Editar</button>
                                            ${item.type==='series' ? `<button class="btn btn-secondary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="manageEpisodes(${item.id})">Episodios</button>` : ''}
                                            <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="deleteItem(${item.id})">Eliminar</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${allItems.length===0 ? '<tr><td colspan="5" style="text-align:center;padding:2rem;">No hay contenido aún</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'users') {
                    const activeUsers = allUsers.filter(u => u.status !== 'pending');
                    content += `
                        <table class="data-table">
                            <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody>
                                ${activeUsers.map(u => `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>${u.role}</td>
                                        <td>${u.status || 'Activo'}</td>
                                        <td>
                                            ${u.email !== 'admin@niro.com' ? `<button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="deleteUser('${u.email}')">Eliminar</button>` : '<span style="opacity:0.5;font-size:0.8rem">Sistema</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'requests') {
                    const pendingUsers = allUsers.filter(u => u.status === 'pending');
                    content += `
                        <h3 style="margin-bottom:1rem;">Solicitudes de Registro</h3>
                        <table class="data-table">
                            <thead><tr><th>Nombre</th><th>Email</th><th>Acciones</th></tr></thead>
                            <tbody>
                                ${pendingUsers.map(u => `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="approveUser('${u.email}', true)">Aceptar</button>
                                            <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="approveUser('${u.email}', false)">Denegar</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${pendingUsers.length===0 ? '<tr><td colspan="3" style="text-align:center;padding:2rem;">No hay solicitudes pendientes</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                }

                content += `</div>`;
                main.innerHTML = content;
            }
        };

        /* -------------------------------------------------------------------------- */
        /*                               HELPER FUNCTIONS                             */
        /* -------------------------------------------------------------------------- */
        
        // --- Modals ---
        function openModal(html) {
            const m = document.getElementById('generic-modal');
            const c = document.getElementById('generic-modal-content');
            c.innerHTML = `<div class="modal-close" onclick="closeModal()"><i class="ri-close-line"></i></div>` + html;
            m.style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('generic-modal').style.display = 'none';
        }

        // --- Content Details ---
        async function openDetails(id) {
            const item = allItems.find(i => i.id === id);
            if(!item) return;
            
            const user = app.state.user;
            const inList = user && user.myList && user.myList.includes(id);
            const isDownloaded = await DownloadManager.has(id);
            
            // Get all downloads to check episodes efficiently
            const allDownloads = await DownloadManager.list();
            const downloadIds = new Set(allDownloads.map(d => d.id));

            let html = `
                <div style="display:flex; flex-direction:column;">
                    <div style="height:350px; background:url('${item.img}') center/cover; position:relative;">
                        <div style="position:absolute;inset:0;background:linear-gradient(to top, var(--color-bg-surface), transparent);"></div>
                        <div style="position:absolute;bottom:20px;left:20px;right:20px;">
                            <h2 style="font-size:2.5rem; line-height:1; margin-bottom:10px; text-shadow:0 2px 10px rgba(0,0,0,0.8);">${item.title}</h2>
                            <div style="display:flex;gap:10px;">
                                <button class="btn btn-primary" onclick="playItem(${item.id})"><i class="ri-play-fill"></i> Reproducir</button>
                                ${user ? `
                                    <button id="btn-mylist-${item.id}" class="btn ${inList ? 'btn-primary' : 'btn-secondary'}" onclick="app.toggleMyList(${item.id})">
                                        <i class="${inList ? 'ri-check-line' : 'ri-add-line'}"></i> ${inList ? 'En mi lista' : 'Mi Lista'
                                    }
                                    </button>
                                ` : ''}
                                ${((item.type === 'movie' && item.video) || item.type === 'series') ? `
                                    <button id="btn-download-${item.id}" class="btn ${isDownloaded ? 'btn-primary' : 'btn-secondary'}" onclick="app.downloadItem(${item.id})">
                                        <i class="${isDownloaded ? 'ri-delete-bin-line' : 'ri-download-line'}"></i> ${isDownloaded ? 'Borrar Descarga' : 'Descargar'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="padding:2rem;">
                        <p style="margin-bottom:1rem;color:#ddd;line-height:1.6;">${item.desc}</p>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:1rem; font-size:0.9rem; color:#aaa; margin-bottom:2rem;">
                            <div>Año: <span style="color:white">${item.year}</span></div>
                            <div>Género: <span style="color:white">${item.genre || 'General'}</span></div>
                            <div>Match: <span style="color:#46d369">${item.match}%</span></div>
                        </div>
            `;

            if(item.type === 'series' && item.seasons) {
                // Season Selector - Custom Dropdown
                html += `
                    <div class="season-selector-container" style="margin-bottom:1.5rem; position:relative; width:fit-content; min-width:200px;">
                        <button onclick="toggleSeasonDropdown()" id="season-dropdown-btn" 
                            style="display:flex; align-items:center; gap:10px; background:transparent; border:1px solid rgba(255,255,255,0.3); padding:8px 15px; border-radius:4px; font-weight:600; font-size:1.1rem; cursor:pointer; color:white;">
                            <span id="current-season-name">${item.seasons[0].name}</span>
                            <i class="ri-arrow-down-s-fill" style="font-size:0.8em;"></i>
                        </button>
                        
                        <div id="season-dropdown-list" style="display:none; position:absolute; top:110%; left:0; min-width:100%; background:var(--color-bg-surface); border:1px solid rgba(255,255,255,0.1); border-radius:4px; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                            ${item.seasons.map((s, idx) => `
                                <div onclick="switchSeason(${idx}, '${s.name}')" class="season-option" style="padding:10px 15px; cursor:pointer; white-space:nowrap; transition:background 0.2s; border-bottom:1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    ${s.name} (${s.episodes.length} episodios)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="episodes-container">
                        ${item.seasons.map((s, sIdx) => `
                            <div id="season-content-${sIdx}" style="display:${sIdx===0?'block':'none'};">
                                ${s.episodes.length === 0 ? '<div style="padding:20px; color:#666;">No hay episodios disponibles.</div>' : ''}
                                ${s.episodes.map((ep, eIdx) => {
                                    const isEpDownloaded = downloadIds.has(ep.id);
                                    return `
                                    <div class="episode-row" onclick="playVideo('${ep.video}', '${ep.title}', ${ep.id}, ${item.id})" style="display:flex; gap:15px; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; align-items:center; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="font-size:1.2rem; color:#666; width:30px; text-align:center;">${eIdx+1}</div>
                                        <div style="width:130px; height:74px; background:url('${ep.img || item.img}') center/cover; border-radius:4px; flex-shrink:0; position:relative;">
                                            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
                                                <i class="ri-play-circle-line" style="font-size:2rem; color:white;"></i>
                                            </div>
                                            ${(() => {
                                                const p = app.state.currentProfile;
                                                if(p && p.continueWatching) {
                                                    const cw = p.continueWatching.find(i => i.itemId === ep.id);
                                                    if(cw) {
                                                        return `<div style="position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,0.3);"><div style="height:100%;width:${(cw.time/cw.duration)*100}%;background:var(--color-brand-primary);"></div></div>`;
                                                    }
                                                }
                                                return '';
                                            })()}
                                        </div>
                                        <div style="flex:1;">
                                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                                <span style="font-weight:bold; font-size:1rem;">${ep.title}</span>
                                                <span style="font-size:0.8rem; color:#aaa;">${Math.floor(Math.random() * 20 + 20)} min</span>
                                            </div>
                                            <div style="font-size:0.85rem; color:#aaa; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.4;">${ep.desc || 'Sin descripción disponible para este episodio.'}</div>
                                        </div>
                                        <div style="margin-left:10px;">
                                            <button id="btn-download-${ep.id}" 
                                                class="btn btn-icon ${isEpDownloaded ? 'btn-primary' : 'btn-secondary'}" 
                                                style="width:40px; height:40px; border-radius:50%; padding:0; display:flex; align-items:center; justify-content:center;"
                                                onclick="event.stopPropagation(); app.downloadItem(${ep.id}, ${item.id})">
                                                <i class="${isEpDownloaded ? 'ri-delete-bin-line' : 'ri-download-line'}"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += `</div></div>`;
            openModal(html);
        }

        function toggleSeasonDropdown() {
            const list = document.getElementById('season-dropdown-list');
            if(list) list.style.display = list.style.display === 'none' ? 'block' : 'none';
        }

        function switchSeason(idx, name) {
            if(name) document.getElementById('current-season-name').innerText = name;
            document.querySelectorAll('[id^="season-content-"]').forEach(el => el.style.display = 'none');
            const target = document.getElementById('season-content-'+idx);
            if(target) target.style.display = 'block';
            toggleSeasonDropdown();
        }

        // --- Playback ---
        async function playItem(id) {
            if(!app.state.user) return app.showToast("Debes iniciar sesión para ver contenido.", "error");
            if(!app.state.currentProfile) return app.router('profiles');
            
            const item = allItems.find(i => i.id === id);

            // Check if it's a direct download item (offline object)
            // The item object from downloads list might be different than allItems
            // But here we are passing ID.
            
            // Try to find in downloads first if item is not in allItems (offline mode)
            let offlineItem = null;
            if (!item) {
                const downloads = await DownloadManager.list();
                offlineItem = downloads.find(d => d.id === id);
                if (offlineItem) {
                     // It's a downloaded item (movie or episode)
                     const blobUrl = await DownloadManager.get(id);
                     if (blobUrl) {
                         playVideo(blobUrl, offlineItem.title, offlineItem.id, offlineItem.parentId, offlineItem.poster);
                         return;
                     }
                }
            }

            if (!item && !offlineItem) return; // Not found anywhere

            // Offline check for online items
            if (!navigator.onLine) {
                 const offlineUrl = await DownloadManager.get(id);
                 if (offlineUrl) {
                     // Determine title/poster from item if available, or fetch from meta
                     const meta = await DownloadManager.list();
                     const metaItem = meta.find(m => m.id === id);
                     playVideo(offlineUrl, metaItem ? metaItem.title : item.title, id, item.type==='series'?id:null, item.img);
                     return;
                 } else {
                     return app.showToast("Este contenido no está disponible sin conexión.", "error");
                 }
            }
            
            if(item.type === 'movie') {
                if(!item.video) return app.showToast("Película aún no disponible.", "error");
                // Check if downloaded to play offline version even if online?
                // Prefer online for quality? Or offline to save bandwidth?
                // Let's check if downloaded exists to save bandwidth
                if (await DownloadManager.has(id)) {
                     const blobUrl = await DownloadManager.get(id);
                     if(blobUrl) {
                         playVideo(blobUrl, item.title, item.id, null, item.img);
                         return;
                     }
                }

                playVideo(item.video, item.title, item.id, null, item.img);
            } else if (item.type === 'series') {
                // ... (series logic remains same for continue watching) ...
                
                // But check if we are trying to play a downloaded EPISODE directly?
                // Usually playItem(id) is called on the SERIES ID, not episode ID.
                // But from Downloads view, it calls playItem(downloadId) which IS the episode ID.
                
                // If item found in allItems is a SERIES, then we do the Continue Watching logic.
                // If the ID passed was actually an EPISODE ID (which won't be in allItems as a top level item),
                // we need to handle that.
                
                // NOTE: allItems contains ONLY top level movies and series.
                // Episodes are nested.
                // So if playItem(id) is called with an episode ID, item will be undefined above!
                
                // So the "offlineItem" check at the top handles the case where we pass an episode ID that is downloaded.
                
                // Logic for Series Parent Object
                const profile = app.state.currentProfile;
                let lastEpisode = null;

                if (profile.continueWatching) {
                    // ... (existing continue watching logic) ...
                    // Find the most recently watched episode for this series
                    // We need to iterate through all continueWatching items and check if they belong to this series
                    // However, current continueWatching structure only has itemId. 
                    // If itemId matches an episode ID of this series.
                    
                    // Let's first flatten all episodes to find their IDs
                    const allSeriesEpisodeIds = [];
                    if(item.seasons) {
                        item.seasons.forEach(s => {
                            if(s.episodes) {
                                s.episodes.forEach(ep => allSeriesEpisodeIds.push(ep));
                            }
                        });
                    }

                    // Find the last watched episode from this series
                    // We assume continueWatching is ordered or we take the one with most progress?
                    // Usually continueWatching is a list. Let's find the one matching any episode of this series.
                    
                    const watched = profile.continueWatching.filter(w => allSeriesEpisodeIds.find(ep => ep.id === w.itemId));
                    if (watched.length > 0) {
                        // Sort by lastUpdated if available, or just take the first one found (assuming latest pushed)
                        // For now, let's take the first one found.
                        const lastWatched = watched[0]; 
                        lastEpisode = allSeriesEpisodeIds.find(ep => ep.id === lastWatched.itemId);
                    }
                }

                if (lastEpisode) {
                    // Show menu: Continue Watching or Season Menu
                    const menuHtml = `
                        <div style="padding:20px; text-align:center;">
                            <h3 style="margin-bottom:20px;">Estás viendo: ${item.title}</h3>
                            <p style="margin-bottom:30px; color:#aaa;">Continuar episodio: <br><strong style="color:white; font-size:1.1rem;">${lastEpisode.title}</strong></p>
                            
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button class="btn btn-primary" onclick="closeModal(); playVideo('${lastEpisode.video}', '${lastEpisode.title}', ${lastEpisode.id}, ${item.id})">
                                    <i class="ri-play-fill"></i> Reanudar Episodio
                                </button>
                                <button class="btn btn-secondary" onclick="closeModal(); openDetails(${item.id})">
                                    <i class="ri-list-check"></i> Ver Temporadas
                                </button>
                            </div>
                        </div>
                    `;
                    // Use a small modal for this
                    openModal(menuHtml);
                } else {
                    // No history, try to play S1 E1 directly or open details?
                    // User asked for "play" to work.
                    // If no history, let's play S1 E1 if available, or open details.
                    // Playing S1 E1 directly is better UX for "Play".
                    
                    if (item.seasons && item.seasons.length > 0 && item.seasons[0].episodes.length > 0) {
                        const firstEp = item.seasons[0].episodes[0];
                        // Just play it? Or ask?
                        // Let's play it directly, assuming that's what "Play" means for a new series.
                        playVideo(firstEp.video, firstEp.title, firstEp.id, item.id);
                    } else {
                        openDetails(id);
                    }
                }
            }
        }

        function playVideo(url, title, itemId, seriesId = null, poster = null) {
            if(!app.state.user) return app.showToast("Debes iniciar sesión.", "error");
            if(!app.state.currentProfile) return app.router('profiles');
            
            const overlay = document.createElement('div');
            overlay.id = 'video-overlay';
            overlay.className = 'video-overlay-container';
            
            overlay.innerHTML = `
                <div class="video-ui-header">
                    <button onclick="closeVideoPlayer()" class="video-btn"><i class="ri-arrow-left-line"></i></button>
                    <h2 class="video-title">${title}</h2>
                </div>
                
                <video id="main-video-player" src="${url}" poster="${poster || ''}" autoplay style="width:100%; height:100%; object-fit:contain; outline:none;"></video>
                
                <div class="video-click-area" onclick="togglePlay()"></div>
                
                <div class="video-controls-bar">
                    <div class="video-progress-container" onclick="seekVideo(event)">
                        <div class="video-progress-fill" id="progress-fill"></div>
                    </div>
                    
                    <div class="video-controls-row">
                        <div class="video-controls-left">
                            <button onclick="togglePlay()" id="play-btn" class="video-btn"><i class="ri-pause-fill"></i></button>
                            <button onclick="skipTime(-10)" class="video-btn"><i class="ri-replay-10-line"></i></button>
                            <button onclick="skipTime(10)" class="video-btn"><i class="ri-forward-10-line"></i></button>
                            <span id="time-display" style="color:white; font-size:0.9rem; font-variant-numeric:tabular-nums;">0:00 / 0:00</span>
                        </div>
                        
                        <div class="video-controls-right">
                            <button onclick="toggleMute()" id="mute-btn" class="video-btn"><i class="ri-volume-up-line"></i></button>
                            <input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)">
                            <button onclick="toggleFullscreen()" class="video-btn"><i class="ri-fullscreen-line"></i></button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);

            const video = document.getElementById('main-video-player');
            const profile = app.state.currentProfile;

            // Restore progress
            if(profile.continueWatching) {
                const saved = profile.continueWatching.find(i => i.itemId === itemId);
                if(saved && saved.time) {
                    video.currentTime = saved.time;
                }
            }

            // Global Helpers for this session
            window.togglePlay = () => {
                if(video.paused) {
                    video.play();
                    document.getElementById('play-btn').innerHTML = '<i class="ri-pause-fill"></i>';
                } else {
                    video.pause();
                    document.getElementById('play-btn').innerHTML = '<i class="ri-play-fill"></i>';
                }
            };

            window.skipTime = (sec) => {
                video.currentTime += sec;
            };

            window.seekVideo = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                video.currentTime = pos * video.duration;
            };

            window.setVolume = (val) => {
                video.volume = val;
                video.muted = false;
                updateMuteIcon();
            };

            window.toggleMute = () => {
                video.muted = !video.muted;
                updateMuteIcon();
            };

            function updateMuteIcon() {
                const btn = document.getElementById('mute-btn');
                if(video.muted || video.volume === 0) btn.innerHTML = '<i class="ri-volume-mute-line"></i>';
                else if(video.volume < 0.5) btn.innerHTML = '<i class="ri-volume-down-line"></i>';
                else btn.innerHTML = '<i class="ri-volume-up-line"></i>';
            }

            window.toggleFullscreen = () => {
                if(!document.fullscreenElement) {
                    overlay.requestFullscreen().catch(err => console.log(err));
                } else {
                    document.exitFullscreen();
                }
            };

            window.closeVideoPlayer = () => {
                document.getElementById('video-overlay').remove();
            };

            // Format Time
            const fmt = (s) => {
                if(isNaN(s)) return "0:00";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec<10?'0':''}${sec}`;
            };

            // Time Update Loop
            video.addEventListener('timeupdate', () => {
                if(!video.duration) return;
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('progress-fill').style.width = `${pct}%`;
                document.getElementById('time-display').innerText = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
            });

            // Idle Detection
            let idleTimer;
            function resetIdle() {
                overlay.classList.remove('user-idle');
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => overlay.classList.add('user-idle'), 3000);
            }
            overlay.addEventListener('mousemove', resetIdle);
            overlay.addEventListener('click', resetIdle);
            resetIdle();

            // Save Progress Logic
            const saveInterval = setInterval(() => {
                if(video.paused || video.ended) return;
                saveProgress(itemId, seriesId, video.currentTime, video.duration, title, url);
            }, 5000);

            video.addEventListener('ended', () => {
                clearInterval(saveInterval);
                removeFromContinueWatching(itemId);
                closeVideoPlayer();
            });

            // Cleanup
            const observer = new MutationObserver((mutations) => {
                if(!document.getElementById('video-overlay')) {
                    clearInterval(saveInterval);
                    if(video && !video.ended && video.currentTime > 0) {
                        saveProgress(itemId, seriesId, video.currentTime, video.duration, title, url);
                    }
                    // Cleanup globals
                    delete window.togglePlay;
                    delete window.skipTime;
                    delete window.seekVideo;
                    delete window.setVolume;
                    delete window.toggleMute;
                    delete window.toggleFullscreen;
                    delete window.closeVideoPlayer;
                    observer.disconnect();
                }
            });
            observer.observe(document.body, { childList: true });
        }

        function saveProgress(itemId, seriesId, time, duration, title, img) {
            if(!app.state.currentProfile) return;
            const p = app.state.currentProfile;
            if(!p.continueWatching) p.continueWatching = [];
            
            // Remove existing entry for this item
            // Clean up previous entries for this series/movie to avoid duplicates
            if(seriesId) {
                p.continueWatching = p.continueWatching.filter(i => i.seriesId !== seriesId);
            } else {
                p.continueWatching = p.continueWatching.filter(i => i.itemId !== itemId);
            }

            // Add new entry to top
            p.continueWatching.unshift({
                itemId,
                seriesId, // null for movies
                time,
                duration,
                title,
                lastWatched: Date.now()
            });

            // Persist locally
            localStorage.setItem('niro_profile', JSON.stringify(p));
            // Sync to user object in memory
             const u = app.state.user;
             const pIdx = u.profiles.findIndex(pr => pr.id === p.id);
             if(pIdx > -1) u.profiles[pIdx] = p;
             localStorage.setItem('niro_user', JSON.stringify(u));
             
             // Update allUsers to ensure persistence on reload
             const uGlobalIdx = allUsers.findIndex(usr => usr.email === u.email);
             if(uGlobalIdx > -1) {
                 allUsers[uGlobalIdx] = u;
                 app.saveDB({ users: allUsers });
             }
        }

        function removeFromContinueWatching(itemId) {
            if(!app.state.currentProfile) return;
            const p = app.state.currentProfile;
            if(!p.continueWatching) return;
            p.continueWatching = p.continueWatching.filter(i => i.itemId !== itemId);
             localStorage.setItem('niro_profile', JSON.stringify(p));
             const u = app.state.user;
             const pIdx = u.profiles.findIndex(pr => pr.id === p.id);
             if(pIdx > -1) u.profiles[pIdx] = p;
             localStorage.setItem('niro_user', JSON.stringify(u));
             
             // Update allUsers to ensure persistence on reload
             const uGlobalIdx = allUsers.findIndex(usr => usr.email === u.email);
             if(uGlobalIdx > -1) {
                 allUsers[uGlobalIdx] = u;
                 app.saveDB({ users: allUsers });
             }
        }

        // --- Admin Actions ---
        function openAddUserModal() {
            openModal(`
                <div style="padding:2rem;">
                    <h2>Agregar Usuario</h2>
                    <form onsubmit="handleAddUser(event)" style="margin-top:1rem;">
                        <div style="margin-bottom:1rem;"><label>Nombre</label><input id="new-u-name" required></div>
                        <div style="margin-bottom:1rem;"><label>Email</label><input id="new-u-email" type="email" required></div>
                        <div style="margin-bottom:1rem;"><label>Contraseña</label><input id="new-u-pass" required></div>
                        <div style="margin-bottom:1rem;"><label>Rol</label>
                            <select id="new-u-role"><option value="user">Usuario</option><option value="admin">Admin</option></select>
                        </div>
                        <button class="btn btn-primary">Crear Usuario</button>
                    </form>
                </div>
            `);
        }
        
        async function approveUser(email, approved) {
            const u = allUsers.find(u => u.email === email);
            if(u) {
                if(approved) {
                    u.status = 'active';
                } else {
                    allUsers = allUsers.filter(user => user.email !== email);
                }
                await app.saveDB({ users: allUsers });
                app.renderAdmin();
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const name = document.getElementById('new-u-name').value;
            const newUser = {
                name,
                email: document.getElementById('new-u-email').value,
                password: document.getElementById('new-u-pass').value,
                role: document.getElementById('new-u-role').value,
                status: 'active', // Admin created users are active
                banned: false,
                profiles: [{ id: Date.now(), name, avatar: 'https://i.pinimg.com/736x/c4/88/34/c488340ad56e5454f4576f6c708b3482.jpg' }]
            };
            allUsers.push(newUser);
            await app.saveDB({ users: allUsers });
            closeModal();
            app.renderAdmin();
        }

        async function deleteUser(email) {
            app.confirmAction("¿Eliminar usuario?", async () => {
                allUsers = allUsers.filter(u => u.email !== email);
                await app.saveDB({ users: allUsers });
                app.renderAdmin();
                app.showToast("Usuario eliminado");
            });
        }

        // --- Add Content Wizard ---
        function openAddContentModal() {
            openModal(`
                <div style="padding:2rem;">
                    <h2>Agregar Contenido</h2>
                    <div style="margin-bottom:1rem;">
                        <label>Tipo</label>
                        <select id="c-type" onchange="toggleVideoField(this.value)">
                            <option value="movie">Película</option>
                            <option value="series">Serie</option>
                        </select>
                    </div>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="c-title" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="c-desc" rows="3"></textarea></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
                        <div><label>Año</label><input id="c-year" type="number" value="2024"></div>
                        <div><label>Match %</label><input id="c-match" type="number" value="98"></div>
                    </div>
                    
                    <div style="margin-bottom:1rem;">
                        <label>Género</label>
                        <select id="c-genre">
                            <option value="Acción">Acción</option>
                            <option value="Aventura">Aventura</option>
                            <option value="Comedia">Comedia</option>
                            <option value="Drama">Drama</option>
                            <option value="Terror">Terror</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Ciencia Ficción">Ciencia Ficción</option>
                            <option value="Fantasía">Fantasía</option>
                            <option value="Romance">Romance</option>
                            <option value="Documental">Documental</option>
                        </select>
                    </div>

                    <div style="margin-bottom:1rem;">
                        <label>Imagen de Portada</label>
                        <input type="file" id="c-img-file" accept="image/*">
                    </div>

                    <div id="video-field" style="margin-bottom:1rem;">
                        <label>Archivo de Video (Solo Películas)</label>
                        <input type="file" id="c-video-file" accept="video/*">
                    </div>

                    <button class="btn btn-primary" onclick="handleAddContent()" id="btn-upload">Publicar</button>
                    <div id="upload-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                </div>
            `);
        }

        function toggleVideoField(val) {
            const f = document.getElementById('video-field');
            f.style.display = val === 'movie' ? 'block' : 'none';
        }

        async function handleAddContent() {
            const btn = document.getElementById('btn-upload');
            const status = document.getElementById('upload-status');
            
            btn.disabled = true;
            status.innerText = "Subiendo archivos...";

            try {
                // Upload Image
                const imgFile = document.getElementById('c-img-file').files[0];
                let imgUrl = "https://via.placeholder.com/800x450";
                
                if(imgFile) {
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) imgUrl = data.url;
                }

                const type = document.getElementById('c-type').value;
                let videoUrl = "";

                if(type === 'movie') {
                    const vidFile = document.getElementById('c-video-file').files[0];
                    if(vidFile) {
                        status.innerText = "Subiendo video (esto puede tardar)...";
                        const fd = new FormData();
                        fd.append('file', vidFile);
                        const res = await fetch('/upload/video', { method:'POST', body:fd });
                        const data = await res.json();
                        if(data.url) videoUrl = data.url;
                    }
                }

                const newItem = {
                    id: Date.now(),
                    type,
                    title: document.getElementById('c-title').value,
                    desc: document.getElementById('c-desc').value,
                    year: document.getElementById('c-year').value,
                    match: document.getElementById('c-match').value,
                    genre: document.getElementById('c-genre').value,
                    img: imgUrl,
                    rating: "16+",
                    seasons: type === 'series' ? [{ id: Date.now(), name: "Temporada 1", episodes: [] }] : undefined,
                    video: type === 'movie' ? videoUrl : undefined
                };

                allItems.unshift(newItem);
                await app.saveDB({ items: allItems });
                
                app.renderAdmin();
                
                if(type === 'series') {
                    // Smooth transition to episode management
                    manageEpisodes(newItem.id);
                } else {
                    closeModal();
                }

            } catch(e) {
                console.error(e);
                app.showToast("Error subiendo contenido", "error");
                btn.disabled = false;
                status.innerText = "";
            }
        }

        // --- Edit Content ---
        function openEditContentModal(id) {
            const item = allItems.find(i => i.id === id);
            if(!item) return;

            openModal(`
                <div style="padding:2rem;">
                    <h2>Editar Contenido</h2>
                    <div style="margin-bottom:1rem;">
                        <label>Tipo</label>
                        <input value="${item.type === 'movie' ? 'Película' : 'Serie'}" disabled style="opacity:0.6;">
                    </div>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="e-title" value="${item.title}" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="e-desc" rows="3">${item.desc}</textarea></div>
                    <div class="input-grid-3">
                        <div><label>Año</label><input id="e-year" type="number" value="${item.year}"></div>
                        <div><label>Género</label><input id="e-genre" value="${item.genre || ''}"></div>
                        <div><label>Match %</label><input id="e-match" type="number" value="${item.match}"></div>
                    </div>
                    
                    <div style="margin-bottom:1rem;">
                        <label>Cambiar Imagen de Portada (Opcional)</label>
                        <input type="file" id="e-img-file" accept="image/*">
                        <div style="font-size:0.8rem;color:#aaa;margin-top:5px;">Actual: <a href="${item.img}" target="_blank" style="text-decoration:underline;">Ver imagen</a></div>
                    </div>

                    ${item.type === 'movie' ? `
                    <div id="video-field" style="margin-bottom:1rem;">
                        <label>Cambiar Archivo de Video (Opcional)</label>
                        <input type="file" id="e-video-file" accept="video/*">
                        ${item.video ? `<div style="font-size:0.8rem;color:#aaa;margin-top:5px;">Video actual cargado</div>` : ''}
                    </div>
                    ` : ''}

                    <button class="btn btn-primary" onclick="handleUpdateContent(${item.id})" id="btn-update">Guardar Cambios</button>
                    <div id="update-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                </div>
            `);
        }

        async function handleUpdateContent(id) {
            const btn = document.getElementById('btn-update');
            const status = document.getElementById('update-status');
            const item = allItems.find(i => i.id === id);
            
            if(!item) return;

            btn.disabled = true;
            status.innerText = "Guardando...";

            try {
                // Upload Image if changed
                const imgFile = document.getElementById('e-img-file').files[0];
                if(imgFile) {
                    status.innerText = "Subiendo nueva imagen...";
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) item.img = data.url;
                }

                // Upload Video if changed (Movie only)
                if(item.type === 'movie') {
                    const vidFile = document.getElementById('e-video-file').files[0];
                    if(vidFile) {
                        status.innerText = "Subiendo nuevo video (esto puede tardar)...";
                        const fd = new FormData();
                        fd.append('file', vidFile);
                        const res = await fetch('/upload/video', { method:'POST', body:fd });
                        const data = await res.json();
                        if(data.url) item.video = data.url;
                    }
                }

                // Update text fields
                item.title = document.getElementById('e-title').value;
                item.desc = document.getElementById('e-desc').value;
                item.year = document.getElementById('e-year').value;
                item.match = document.getElementById('e-match').value;
                item.genre = document.getElementById('e-genre').value;

                await app.saveDB({ items: allItems });
                
                closeModal();
                app.renderAdmin();

            } catch(e) {
                console.error(e);
                alert("Error actualizando contenido");
                btn.disabled = false;
                status.innerText = "";
            }
        }


        async function deleteFile(url) {
            if (!url) return;
            try {
                await fetch('/delete', {
                    method: 'POST',
                    body: JSON.stringify({ url })
                });
            } catch (e) {
                console.error("Error deleting file:", url, e);
            }
        }

        async function deleteItem(id) {
            app.confirmAction("¿Eliminar este contenido y todos sus archivos asociados?", async () => {
                const item = allItems.find(i => i.id === id);
            if (!item) return;

            // Delete from Downloads (Local)
            try {
                if (item.type === 'movie') {
                    if(await DownloadManager.has(id)) await DownloadManager.remove(id);
                } else if (item.type === 'series' && item.seasons) {
                    for(const s of item.seasons) {
                        if(s.episodes) {
                            for(const ep of s.episodes) {
                                if(await DownloadManager.has(ep.id)) await DownloadManager.remove(ep.id);
                            }
                        }
                    }
                }
            } catch(e) { console.error("Error removing local downloads", e); }

            // Delete Image
            if (item.img && item.img.startsWith('/media/')) {
                await deleteFile(item.img);
            }

            // Delete Video(s)
            if (item.type === 'movie' && item.video && item.video.startsWith('/media/')) {
                await deleteFile(item.video);
            } else if (item.type === 'series' && item.seasons) {
                for (const season of item.seasons) {
                    if (season.episodes) {
                        for (const ep of season.episodes) {
                            if (ep.video && ep.video.startsWith('/media/')) {
                                await deleteFile(ep.video);
                            }
                            if (ep.img && ep.img.startsWith('/media/')) {
                                await deleteFile(ep.img);
                            }
                        }
                    }
                }
            }

            allItems = allItems.filter(i => i.id !== id);
            await app.saveDB({ items: allItems });
            app.renderAdmin();
            app.showToast("Contenido eliminado");
            });
        }

        // --- Series Management ---
        function manageEpisodes(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            if(!item) return;

            openModal(`
                <div style="padding:2rem; width:100%;">
                    <h2>Gestionar: ${item.title}</h2>
                    <div style="margin:1rem 0; max-height:400px; overflow-y:auto;">
                        ${item.seasons.length === 0 ? '<p>No hay temporadas.</p>' : ''}
                        ${item.seasons.map((s, sIdx) => `
                            <div style="background:rgba(255,255,255,0.05); padding:1rem; margin-bottom:1rem; border-radius:8px;">
                                <h4 style="color:var(--color-brand-primary); margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                                    ${s.name}
                                    <button onclick="deleteSeason(${seriesId}, ${sIdx})" style="color:#ef4444; font-size:0.9rem; background:none; border:none; cursor:pointer;" title="Eliminar Temporada"><i class="ri-delete-bin-line"></i></button>
                                </h4>
                                <div style="margin-left:1rem;">
                                    ${s.episodes.map(ep => `
                                        <div style="font-size:0.9rem; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                                            <div style="display:flex; align-items:center; gap:10px;">
                                                <img src="${ep.img || item.img}" style="width:50px; height:30px; object-fit:cover; border-radius:2px; opacity:0.7;">
                                                <span>${ep.title}</span>
                                            </div>
                                            <button onclick="deleteEpisode(${seriesId}, ${sIdx}, ${ep.id})" style="color:#ef4444; font-size:1rem; background:none; border:none; cursor:pointer;" title="Eliminar Episodio"><i class="ri-close-circle-line"></i></button>
                                        </div>
                                    `).join('')}
                                    <button class="btn btn-secondary" style="margin-top:10px; font-size:0.8rem;" onclick="addEpisode(${seriesId}, ${sIdx})">+ Añadir Episodio</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="addSeason(${seriesId})">Nueva Temporada</button>
                </div>
            `);
        }

        async function deleteSeason(seriesId, seasonIdx) {
            app.confirmAction("¿Eliminar esta temporada y todos sus episodios? Esta acción no se puede deshacer.", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                
                if(season.episodes) {
                    for(const ep of season.episodes) {
                        try {
                            if(await DownloadManager.has(ep.id)) await DownloadManager.remove(ep.id);
                        } catch(e) {}

                        if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                        if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    }
                }
                
                item.seasons.splice(seasonIdx, 1);
                await app.saveDB({ items: allItems });
                manageEpisodes(seriesId);
                app.showToast("Temporada eliminada");
            });
        }

        async function deleteEpisode(seriesId, seasonIdx, episodeId) {
            app.confirmAction("¿Eliminar este episodio?", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                const ep = season.episodes.find(e => e.id === episodeId);
                
                if(ep) {
                    try {
                        if(await DownloadManager.has(episodeId)) await DownloadManager.remove(episodeId);
                    } catch(e) {}

                    if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                    if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    
                    season.episodes = season.episodes.filter(e => e.id !== episodeId);
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId);
                    app.showToast("Episodio eliminado");
                }
            });
        }

        async function addSeason(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            const nextSeasonNum = item.seasons.length + 1;
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Nueva Temporada</h3>
                    <div style="margin-bottom:1rem;">
                        <label>Nombre de la Temporada</label>
                        <input id="new-season-name" value="Temporada ${nextSeasonNum}" required>
                    </div>
                    <button class="btn btn-primary" onclick="handleCreateSeason(${seriesId})">Crear Temporada</button>
                </div>
            `);
        }

        async function handleCreateSeason(seriesId) {
            const name = document.getElementById('new-season-name').value;
            if(!name) return app.showToast("El nombre es obligatorio", "error");
            
            const item = allItems.find(i => i.id === seriesId);
            item.seasons.push({ id: Date.now(), name, episodes: [] });
            
            await app.saveDB({ items: allItems });
            app.showToast("Temporada creada");
            
            // Close the small modal and reopen the manage modal (a bit hacky but works for this structure)
            // Ideally we would have stacked modals or just re-render the content
            // effectively "closeModal()" closes the current one.
            // We need to reopen manageEpisodes.
            manageEpisodes(seriesId); 
        }

        async function addEpisode(seriesId, seasonIdx) {
            const item = allItems.find(i => i.id === seriesId);
            const season = item.seasons[seasonIdx];
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Añadir Episodio a ${season.name}</h3>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="ep-title" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="ep-desc" rows="2"></textarea></div>
                    <div style="margin-bottom:1rem;">
                        <label>Imagen del Episodio (Thumbnail)</label>
                        <input type="file" id="ep-img" accept="image/*">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Video del Episodio</label>
                        <input type="file" id="ep-video" accept="video/*">
                    </div>
                    <button class="btn btn-primary" id="btn-ep-upload" onclick="handleEpUpload(${seriesId}, ${seasonIdx})">Subir Episodio</button>
                    <div id="ep-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="manageEpisodes(${seriesId})">Cancelar</button>
                </div>
            `);
        }

        async function handleEpUpload(seriesId, seasonIdx) {
            const btn = document.getElementById('btn-ep-upload');
            const status = document.getElementById('ep-status');
            const title = document.getElementById('ep-title').value;
            const desc = document.getElementById('ep-desc').value;
            const vidFile = document.getElementById('ep-video').files[0];
            const imgFile = document.getElementById('ep-img').files[0];
            
            if(!title || !vidFile) return app.showToast("Faltan datos (título y video son obligatorios)", "error");

            btn.disabled = true;
            status.innerText = "Subiendo archivos...";

            try {
                // Upload Image
                let imgUrl = "";
                if(imgFile) {
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) imgUrl = data.url;
                }

                // Upload Video
                const fd = new FormData();
                fd.append('file', vidFile);
                const res = await fetch('/upload/video', { method:'POST', body:fd });
                const data = await res.json();
                
                if(data.url) {
                    const item = allItems.find(i => i.id === seriesId);
                    item.seasons[seasonIdx].episodes.push({
                        id: Date.now(),
                        title,
                        desc,
                        img: imgUrl,
                        video: data.url
                    });
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId); // Go back to list
                } else {
                    throw new Error("Upload failed");
                }
            } catch(e) {
                console.error(e);
                app.showToast("Error subiendo episodio", "error");
                btn.disabled = false;
                status.innerText = "";
            }
        }

        // --- Init ---
        app.init();

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered', reg))
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>
</body>
</html>
