<!DOCTYPE html>
<html lang="es">
<head>
    <!-- CRITICAL ERROR HANDLER -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.toLowerCase().indexOf('script error') > -1) return false;
            var extra = !col ? '' : '\nCol: ' + col;
            extra += !error ? '' : '\nErr: ' + error;
            console.error("Global Error: " + msg + "\nUrl: " + url + "\nLine: " + line + extra);
            
            setTimeout(function() {
                var mv = document.getElementById('main-view');
                if (!mv || mv.innerHTML.trim() === '') {
                     var errDiv = document.createElement('div');
                     errDiv.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:black;color:red;z-index:99999;padding:20px;overflow:auto;font-family:monospace;font-size:16px;white-space:pre-wrap;';
                     errDiv.innerHTML = '<h3>CRITICAL STARTUP ERROR</h3><p>' + msg + '</p><p>Line: ' + line + ' Col: ' + col + '</p><pre>' + (error && error.stack ? error.stack : '') + '</pre><button onclick="location.reload()" style="padding:15px;margin-top:20px;font-size:16px;">RELOAD APP</button>';
                     document.body.appendChild(errDiv);
                }
            }, 3000);
            return false;
        };
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NIRO</title>
    <meta name="description" content="La experiencia de streaming definitiva.">
    <meta name="theme-color" content="#0F0720">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NIRO">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="Niro_original.png">
    <link rel="apple-touch-icon" href="Niro_original.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    

    
    <script>
        console.log("VERSION: 2025-01-06-FIX-V3 - CACHE BUSTER");
        // Force reload if version mismatch (optional advanced technique, keeping simple for now)
    </script>

    <style>
        /* --- DESIGN TOKENS & RESET --- */
        :root {
            --bg-color: #050505;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary-accent: #e50914; 
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --gold-gradient: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            --metal-gradient: linear-gradient(135deg, #e0e0e0 0%, #ffffff 50%, #a0a0a0 100%);
            --color-brand-primary: #8B5CF6; /* Keep for functional compat */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-color); color: var(--text-primary); overflow-x: hidden; padding-bottom: 80px; }

        /* --- GLASSMORPHISM HEADER --- */
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 1000; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px); border-bottom: 1px solid var(--glass-border); transition: all 0.3s ease; }
        .logo { font-weight: 800; font-size: 24px; letter-spacing: -1px; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-icons i { font-size: 22px; margin-left: 20px; color: var(--text-secondary); }
        .system-status { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; color: #46d369; background: rgba(70, 211, 105, 0.1); padding: 4px 8px; border-radius: 12px; border: 1px solid rgba(70, 211, 105, 0.2); margin-right: 12px; }
        .status-dot { width: 6px; height: 6px; background-color: #46d369; border-radius: 50%; box-shadow: 0 0 8px #46d369; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { opacity: 1; box-shadow: 0 0 0 0 rgba(70, 211, 105, 0.7); } 70% { opacity: 1; box-shadow: 0 0 0 6px rgba(70, 211, 105, 0); } 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(70, 211, 105, 0); } }

        /* --- HERO SECTION --- */
        .hero { position: relative; height: 80vh; width: 100%; display: flex; align-items: flex-end; padding-bottom: 60px; background: url('https://images.unsplash.com/photo-1509248961158-e54f6934749c?q=80&w=2037&auto=format&fit=crop') center/cover no-repeat; mask-image: linear-gradient(to bottom, black 70%, transparent 100%); }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, var(--bg-color) 10%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.2) 100%); }
        .hero-content { position: relative; z-index: 10; padding: 0 24px; width: 100%; max-width: 800px; }
        .hero-tags { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; font-size: 13px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .match-score { color: #46d369; font-weight: 700; }
        .hero-title { font-size: clamp(3rem, 8vw, 5rem); font-weight: 800; line-height: 1.1; margin-bottom: 20px; text-shadow: 0 4px 20px rgba(0,0,0,0.8); background: linear-gradient(180deg, #fff 0%, #ccc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-desc { font-size: 16px; line-height: 1.5; color: rgba(255,255,255,0.9); margin-bottom: 24px; max-width: 500px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .hero-actions { display: flex; gap: 16px; align-items: center; }
        .btn-play { background: var(--metal-gradient); color: #000; border: none; padding: 14px 32px; border-radius: 8px; font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2); }
        .btn-play:active { transform: scale(0.95); }
        .btn-secondary { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); color: white; border: 1px solid rgba(255,255,255,0.1); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }

        /* --- MOOD UI --- */
        .mood-section { padding: 40px 24px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; letter-spacing: 0.5px; color: var(--text-secondary); }
        .mood-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .mood-card { height: 120px; border-radius: 16px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s ease; }
        .mood-card:active { transform: scale(0.98); }
        .mood-text { position: relative; z-index: 2; font-weight: 700; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .mood-chill { background: linear-gradient(45deg, #0093E9 0%, #80D0C7 100%); }
        .mood-intensity { background: linear-gradient(45deg, #850000 0%, #cc0000 100%); }
        .mood-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .mood-drama { background: #000; border: 1px solid #333; }

        /* --- LISTS --- */
        .content-list { padding: 0 0 40px 24px; }
        .list-header { margin-bottom: 16px; font-size: 18px; font-weight: 600; color: #eee; }
        .scroll-container { display: flex; gap: 16px; overflow-x: auto; padding-right: 24px; padding-bottom: 20px; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .media-card { flex: 0 0 140px; height: 210px; border-radius: 12px; position: relative; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: pointer; overflow: hidden; }
        .media-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        .media-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .media-card:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .media-card:hover .media-info { opacity: 1; transform: translateY(0); }
        .media-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .media-desc { font-size: 11px; color: #ccc; line-height: 1.2; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 65px; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 10px; gap: 4px; cursor: pointer; transition: color 0.3s; width: 60px; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: #fff; }
        .nav-item.active i { background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- FUNCTIONAL (TOAST, MODAL, VIDEO) --- */
        .toast-container { position: fixed; bottom: 90px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(30, 16, 53, 0.9); backdrop-filter: blur(10px); color: white; padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 12px; max-width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        /* Video Player Styles (Simplified) */
        .video-overlay-container { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; }
    </style>

</head>

<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">NIRO</div>
            <div class="nav-icons" style="display:flex; align-items:center;">
                <div class="system-status">
                    <div class="status-dot"></div>
                    <span>ONLINE</span>
                </div>
                <i class="ri-search-line"></i>
                <i class="ri-notification-3-line"></i>
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Niro" style="width: 28px; height: 28px; border-radius: 4px; vertical-align: middle; margin-left: 20px;">
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <div class="hero-tags">
                    <span class="match-score">90% MATCH</span>
                    <span>2025</span>
                    <span style="border: 1px solid #666; padding: 0 4px; border-radius: 2px;">16+</span>
                    <span>2h 15m</span>
                </div>
                <h1 class="hero-title">La Hermanastra<br>Fea</h1>
                <p class="hero-desc">En esta reimaginación gótica del clásico, la "villana" toma el control con sus propias botas. Un thriller psicológico donde la magia tiene un precio sangriento.</p>
                <div class="hero-actions">
                    <button class="btn-play" onclick="app.playItem(1)">
                        <i class="ri-play-fill"></i> Reproducir
                    </button>
                    <button class="btn-secondary" onclick="app.toggleMyList(1)">
                        <i class="ri-add-line"></i>
                    </button>
                    <button class="btn-secondary" onclick="app.openDetails(1)">
                        <i class="ri-information-line"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Mood Based UI -->
        <section class="mood-section">
            <h2 class="section-title">¿QUÉ VIBE TIENES HOY?</h2>
            <div class="mood-grid">
                <div class="mood-card mood-chill" onclick="app.filterByMood('chill')">
                    <span class="mood-text">Chill & Relax</span>
                </div>
                <div class="mood-card mood-intensity" onclick="app.filterByMood('intense')">
                    <span class="mood-text">Intensidad</span>
                </div>
                <div class="mood-card mood-magic" onclick="app.filterByMood('magic')">
                    <span class="mood-text">Magia & Sci-Fi</span>
                </div>
                <div class="mood-card mood-drama" onclick="app.filterByMood('drama')">
                    <span class="mood-text">Drama Puro</span>
                </div>
            </div>
        </section>

        <!-- Main View for Lists -->
        <main id="main-view">
            <!-- Dynamic Lists Go Here -->
        </main>

        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="app.router('home')">
                <i class="ri-home-5-fill"></i>
                <span>Inicio</span>
            </div>
            <div class="nav-item" onclick="app.router('movies')">
                <i class="ri-film-fill"></i>
                <span>Pelis</span>
            </div>
            <div class="nav-item" onclick="app.router('series')">
                <i class="ri-tv-2-line"></i>
                <span>Series</span>
            </div>
            <div class="nav-item" onclick="app.router('downloads')">
                <i class="ri-download-cloud-2-line"></i>
                <span>Descargas</span>
            </div>
        </nav>

        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>
        
        <!-- Modal -->
        <div class="modal-backdrop" id="generic-modal">
            <div class="modal-content" id="generic-modal-content"></div>
        </div>
    </div>
<script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg, url, line, col, error);
            const main = document.getElementById('main-view');
            if(main && main.innerHTML === '') { // Only if not already handled
                 main.innerHTML = `<div style="padding-top:100px;text-align:center;color:red;">Global Error: ${msg}<br>Line: ${line}</div>`;
            }
            return false;
        };

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(typeof app !== 'undefined' && app.renderHeader) app.renderHeader();
        });

        /* -------------------------------------------------------------------------- */
        /*                                  DATA STORE                                */
        /* -------------------------------------------------------------------------- */
        
        let allItems = [];
        let allUsers = [];

        const AVATARS = [
            'https://i.pinimg.com/736x/c4/88/34/c488340ad56e5454f4576f6c708b3482.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-qo9h82134t9nv0j0.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-88wkdmjrorckekha.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-dyrp6bw6adq4608w.jpg',
            'https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png',
            'https://pro2-bar-s3-cdn-cf1.myportfolio.com/dddb0c1b4ab8a8dcfa88288dcea3848f/a1322748-d3c4-4c07-b365-22d7d6f51c72_rw_1200.png?h=3e2f5b3a4f3b6c5f7f3f6e4a9c4a8f3b',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPfCfPLhwIpjvAbjJ8q3c7v2v5e7f2f6_0qA&usqp=CAU',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_j5_q6_q_q_q_q_q_q_q_q_q_q_q_q_q_q&usqp=CAU',
            'https://i.pinimg.com/originals/b6/77/cd/b677cd1cde292f261166533d6fe75872.png',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu99-u_G5hX_G4rA8E4r4r4r4r4r4r4r4r4r&usqp=CAU',
            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR-q_q_q_q_q_q_q_q_q_q_q_q_q_q_q_q_q&usqp=CAU',
            'https://ih0.redbubble.net/image.618427277.3222/flat,1000x1000,075,f.u2.jpg',
            'https://i.pinimg.com/originals/10/12/c0/1012c06c7e1b0f8f5e60611992785e5a.png',
            'https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-v3t2794158t8687a.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-6pv9612v2870428d.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-23456789.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-34567890.jpg',
            'https://wallpapers.com/images/hd/netflix-profile-pictures-1000-x-1000-45678901.jpg',
            'https://pbs.twimg.com/media/DmBraxlXcAAKB53.jpg',
            'https://i.pinimg.com/736x/db/70/dc/db70dc468af8c93749d1f587d74dcb08.jpg',
            'https://i.pinimg.com/736x/0d/dc/ca/0ddccaae71591af95020288820a40348.jpg',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/1bdc9a33850498.56ba69ac2ba5b.png',
            'https://mir-s3-cdn-cf.behance.net/project_modules/disp/64623a33850498.56ba69ac2a6f7.png',
            'https://i.pinimg.com/originals/2b/90/0d/2b900d5612554cd0b5ea796e87588726.png',
            'https://i.pinimg.com/originals/f6/13/46/f61346b9a8885b5420e60057f920d32f.png',
            'https://i.pinimg.com/originals/98/e4/20/98e420b982181518d09817924844335c.png',
            'https://i.pinimg.com/originals/55/79/f0/5579f0460c5a14d567c2957790757753.png',
            'https://i.pinimg.com/originals/1b/71/b8/1b71b85dd741ad27bffa5c834a7ed797.png',
            'https://i.pinimg.com/originals/e3/94/30/e39430434d2b8207188f880ac66c6411.png',
            'https://i.pinimg.com/originals/61/54/76/61547625e01d8daf941aae3ffb37f653.png',
            'https://i.pinimg.com/originals/34/62/d2/3462d27440aa255b1c314ff16f4032b4.png',
            'https://i.pinimg.com/originals/0c/3b/3a/0c3b3adb1a7530892e55ef36d3be6cb8.png',
            'https://i.pinimg.com/originals/f5/66/1b/f5661b1836154238e21016892697858d.png'
        ];

        /* -------------------------------------------------------------------------- */
        /*                              DOWNLOAD MANAGER                              */
        /* -------------------------------------------------------------------------- */
        const DownloadManager = {
            dbName: 'niro_offline_db',
            version: 1,
            db: null,
            
            async init() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, this.version);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                        if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'id' });
                    };
                    req.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    req.onerror = (e) => reject(e);
                });
            },

            async save(id, url, metaData, onProgress) {
                await this.init();
                try {
                    const response = await fetch(url);
                    if(!response.ok) throw new Error("Network error");
                    
                    const reader = response.body.getReader();
                    const contentLength = +response.headers.get('Content-Length');
                    let receivedLength = 0;
                    const chunks = [];
                    
                    while(true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        receivedLength += value.length;
                        if(onProgress && contentLength) onProgress(receivedLength / contentLength);
                    }
                    
                    const blob = new Blob(chunks);
                    const tx = this.db.transaction(['files', 'meta'], 'readwrite');
                    tx.objectStore('files').put(blob, id);
                    tx.objectStore('meta').put({ ...metaData, id, date: Date.now(), size: blob.size });
                    
                    return new Promise((resolve, reject) => {
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    });
                } catch(e) {
                    console.error("Download failed", e);
                    throw e;
                }
            },

            async get(id) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['files'], 'readonly');
                    const req = tx.objectStore('files').get(id);
                    req.onsuccess = () => {
                        if(req.result) resolve(URL.createObjectURL(req.result));
                        else resolve(null);
                    };
                    req.onerror = () => reject(req.error);
                });
            },
            
            async has(id) {
                await this.init();
                return new Promise(resolve => {
                    const tx = this.db.transaction(['meta'], 'readonly');
                    const req = tx.objectStore('meta').get(id);
                    req.onsuccess = () => resolve(!!req.result);
                    req.onerror = () => resolve(false);
                });
            },

            async remove(id) {
                await this.init();
                const tx = this.db.transaction(['files', 'meta'], 'readwrite');
                tx.objectStore('files').delete(id);
                tx.objectStore('meta').delete(id);
                return new Promise(resolve => tx.oncomplete = () => resolve());
            },

            async list() {
                await this.init();
                return new Promise(resolve => {
                    const tx = this.db.transaction(['meta'], 'readonly');
                    const req = tx.objectStore('meta').getAll();
                    req.onsuccess = () => resolve(req.result || []);
                });
            }
        };

        /* -------------------------------------------------------------------------- */
        /*                                 APPLICATION                                */
        /* -------------------------------------------------------------------------- */
        const app = {
            state: {
                user: null,
                currentProfile: null,
                route: 'home',
                adminTab: 'content' // 'content' or 'users'
            },

            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="${type === 'success' ? 'ri-checkbox-circle-fill' : 'ri-error-warning-fill'}" style="font-size:1.2rem; color:${type === 'success' ? '#46d369' : '#ef4444'}"></i>
                    <span>${msg}</span>
                `;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            debounce: (func, wait) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },

            confirmAction: (msg, onConfirm) => {
                const m = document.createElement('div');
                m.className = 'modal-backdrop';
                m.style.display = 'flex';
                m.style.zIndex = '4000'; // Top level
                m.innerHTML = `
                    <div class="modal-content" style="max-width:400px; text-align:center; padding:2rem;">
                        <h3 style="margin-bottom:1rem;">¿Estás seguro?</h3>
                        <p style="margin-bottom:2rem; color:#ccc;">${msg}</p>
                        <div style="display:flex; justify-content:center; gap:1rem;">
                            <button class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
                            <button class="btn btn-danger" id="confirm-ok">Confirmar</button>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

                document.body.appendChild(m);
                
                const close = () => m.remove();
                m.querySelector('#confirm-cancel').onclick = close;
                m.querySelector('#confirm-ok').onclick = () => {
                    close();
                    onConfirm();
                };
            },

            
            installPWA: async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                }
            },

            renderInstallArea: () => {
                const area = document.getElementById('install-area');
                if(!area) return;
                
                const isMobile = window.innerWidth <= 1024; // Tablet/Mobile
                
                if(isMobile) {
                    if(deferredPrompt) {
                        area.innerHTML = `<button class="btn btn-primary" onclick="app.installPWA()" style="width:100%;justify-content:center;"><i class="ri-download-cloud-fill"></i> Instalar Aplicación</button>`;
                    } else {
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        if(isIOS) {
                            area.innerHTML = `<div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;font-size:0.85rem;color:#ccc;">
                                <p style="margin-bottom:5px;color:white;font-weight:bold;">Instalar en iOS/iPad:</p>
                                <p>1. Pulsa el botón "Compartir" <i class="ri-share-up-line"></i></p>
                                <p>2. Selecciona "Agregar a Inicio" <i class="ri-add-box-line"></i></p>
                            </div>`;
                        } else {
                            // Android but no prompt available (already installed or not supported)
                             area.innerHTML = `<p style="color:#8B5CF6;font-size:0.9rem;">Instala la App desde el menú de tu navegador para mejor experiencia.</p>`;
                        }
                    }
                } else {
                    // Desktop
                    area.innerHTML = `<a href="/static/NIRO_App.exe" download style="display:inline-flex;align-items:center;gap:8px;color:#C4B5FD;text-decoration:none;font-size:0.9rem;transition:color 0.3s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#C4B5FD'">
                                    <i class="ri-windows-fill"></i> Descargar App para Windows
                                </a>`;
                }
            },

            
            openMobileProfileMenu: () => {
                const sheet = document.getElementById('mobile-profile-sheet');
                const overlay = document.getElementById('mobile-profile-overlay');
                const user = app.state.user;
                const profile = app.state.currentProfile;

                if(!user || !profile) {
                    app.router('login');
                    return;
                }

                const content = document.getElementById('mobile-profile-content');
                content.innerHTML = `
                    <div class="sheet-header">
                        <div class="sheet-avatar" style="background-image:url('${profile.avatar}')"></div>
                        <div class="sheet-user-info">
                            <h3>${profile.name}</h3>
                            <div class="sheet-change-btn" onclick="app.closeMobileProfileMenu(); app.router('profiles')">
                                <i class="ri-arrow-left-right-line"></i> Cambiar perfil
                            </div>
                        </div>
                        <div onclick="app.closeMobileProfileMenu()">
                            <i class="ri-close-circle-fill" style="font-size:2rem;color:rgba(255,255,255,0.2);"></i>
                        </div>
                    </div>
                    
                    <div class="sheet-item" onclick="app.closeMobileProfileMenu(); app.router('account')">
                        <i class="ri-settings-4-line"></i>
                        <span>Cuenta</span>
                    </div>
                    
                    <div class="sheet-item" onclick="app.closeMobileProfileMenu(); app.router('mylist')">
                        <i class="ri-heart-3-line"></i>
                        <span>Mi Lista</span>
                    </div>
                    
                    ${user.role === 'admin' ? `
                    <div class="sheet-item" onclick="app.closeMobileProfileMenu(); app.router('admin')">
                        <i class="ri-shield-keyhole-line"></i>
                        <span>Panel de Admin</span>
                    </div>
                    ` : ''}

                     <div class="sheet-item" onclick="app.closeMobileProfileMenu(); app.installPWA()" id="sheet-install-btn" style="display:none;">
                        <i class="ri-download-cloud-2-line"></i>
                        <span>Instalar App</span>
                    </div>
                    
                    <div class="sheet-item danger" onclick="app.closeMobileProfileMenu(); app.logout()">
                        <i class="ri-logout-box-r-line"></i>
                        <span>Cerrar Sesión</span>
                    </div>
                `;
                
                // Show install button if available
                if(deferredPrompt) {
                     document.getElementById('sheet-install-btn').style.display = 'flex';
                }

                sheet.classList.add('active');
                overlay.classList.add('active');
            },

            closeMobileProfileMenu: () => {
                document.getElementById('mobile-profile-sheet').classList.remove('active');
                document.getElementById('mobile-profile-overlay').classList.remove('active');
            },

            init: async () => {
                var debugStep = "Inicio";
                try {
                    // 1. Compatibilidad
                    debugStep = "Chequeo Compatibilidad";
                    if (!window.fetch) throw new Error("Falta Fetch API");
                    if (!window.Promise) throw new Error("Falta Promise API");

                    console.log("Init starting...");

                    // 2. Debounce
                    debugStep = "Configurando Buscador (Debounce)";
                    if (typeof app.debounce !== 'function') throw new Error("app.debounce no es funcion");
                    app.debouncedSearch = app.debounce(app.handleSearch, 300);
                    
                    // 3. Base de Datos
                    debugStep = "Cargando Base de Datos (fetchDB)";
                    if (typeof app.fetchDB !== 'function') throw new Error("app.fetchDB no es funcion");
                    await app.fetchDB();
                    
                    // 4. Sesión
                    debugStep = "Verificando Sesión (checkSession)";
                    if (typeof app.checkSession !== 'function') throw new Error("app.checkSession no es funcion");
                    await app.checkSession();
                    
                    // 5. Header
                    debugStep = "Renderizando Cabecera (renderHeader)";
                    if (typeof app.renderHeader !== 'function') throw new Error("app.renderHeader no es funcion");
                    app.renderHeader();
                    
                    // 6. Router / Home
                    debugStep = "Renderizando Contenido Principal";
                    if (app.state.route === 'home') {
                        debugStep = "Ejecutando renderHome";
                        if (typeof app.renderHome !== 'function') throw new Error("app.renderHome no es funcion");
                        await app.renderHome();
                    } else {
                        debugStep = "Ejecutando Router para " + app.state.route;
                        if (typeof app.router !== 'function') throw new Error("app.router no es funcion");
                        app.router(app.state.route);
                    }
                    
                    // 7. Scroll
                    debugStep = "Eventos de Scroll";
                    window.addEventListener('scroll', () => {
                        const h = document.getElementById('main-header');
                        if(h) {
                             if(window.scrollY > 50) h.classList.add('scrolled');
                             else h.classList.remove('scrolled');
                        }
                    });

                } catch(e) {
                    console.error("Init Error at " + debugStep, e);
                    document.getElementById('main-view').innerHTML = `<div style="padding-top:100px;text-align:center;color:white;padding:20px;">
                        <h3 style="color:red">Error cargando la aplicación</h3>
                        <div style="background:#222; padding:15px; margin:20px auto; border-radius:8px; max-width:600px; text-align:left;">
                            <p style="color:#ff6b6b; font-weight:bold; margin-bottom:10px;">Fallo en: ${debugStep}</p>
                            <p style="color:white; font-family:monospace;">${e.message}</p>
                            <hr style="border-color:#444; margin:10px 0;">
                            <small style="color:#aaa;">${e.stack || 'No stack trace'}</small>
                        </div>
                        <button onclick="location.reload()" class="btn btn-secondary" style="margin-top:20px;">Reintentar</button>
                        <button onclick="localStorage.clear(); location.reload()" class="btn btn-danger" style="margin-top:20px;">Restablecer App</button>
                    </div>`;
                }
            },

            /* --- Data Logic --- */
            fetchDB: async () => {
                try {
                    const res = await fetch('/db');
                    if(res.ok) {
                        const data = await res.json();
                        allItems = data.items || [];
                        allUsers = data.users || [];
                        app.state.notifications = data.notifications || [];
                    }
                } catch(e) { console.error("Error DB", e); }
            },

            saveDB: async (updates) => {
                try {
                    // Fetch current to merge
                    const res = await fetch('/db');
                    const current = await res.json();
                    
                    const newData = { ...current, ...updates };
                    
                    await fetch('/db', {
                        method: 'POST',
                        body: JSON.stringify(newData)
                    });
                    
                    // Update local
                    if(updates.items) allItems = updates.items;
                    if(updates.users) allUsers = updates.users;
                    return true;
                } catch(e) {
                    console.error("Save failed", e);
                    app.showToast("Error guardando datos", "error");
                    return false;
                }
            },

            checkSession: async () => {
                const u = localStorage.getItem('niro_user');
                if(u) {
                    const parsedUser = JSON.parse(u);
                    // Re-validate with DB
                    const freshUser = allUsers.find(user => user.email === parsedUser.email);
                    if(freshUser) {
                        app.state.user = freshUser;
                        
                        // Ensure profiles exist (Migration)
                        if(!app.state.user.profiles) {
                            app.state.user.profiles = [{
                                id: Date.now(),
                                name: app.state.user.name,
                                avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)]
                            }];
                            await app.saveDB({ users: allUsers });
                        }

                        // Check stored profile
                        const storedProfile = localStorage.getItem('niro_profile');
                        if (storedProfile) {
                            const pId = JSON.parse(storedProfile).id;
                            const validProfile = app.state.user.profiles.find(p => p.id === pId);
                            if(validProfile) {
                                app.state.currentProfile = validProfile;
                            } else {
                                app.state.route = 'profiles';
                            }
                        } else {
                            app.state.route = 'profiles';
                        }
                    } else {
                        localStorage.removeItem('niro_user');
                        localStorage.removeItem('niro_profile');
                    }
                }
            },

            login: async (email, password) => {
                await app.fetchDB(); // Refresh data
                const user = allUsers.find(u => u.email === email && u.password === password);
                if(user) {
                    if(user.banned) { app.showToast("Usuario bloqueado.", "error"); return false; }
                    if(user.status === 'pending') { app.showToast("Tu cuenta está pendiente de aprobación por un administrador.", "error"); return false; }
                    app.state.user = user;
                    localStorage.setItem('niro_user', JSON.stringify(user));
                    
                    // Ensure profiles exist
                    if(!user.profiles) {
                        user.profiles = [{ id: Date.now(), name: user.name, avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)] }];
                        await app.saveDB({ users: allUsers });
                    }

                    app.router('profiles');
                    return true;
                }
                app.showToast("Credenciales inválidas", "error");
                return false;
            },

            register: async (name, email, password) => {
                await app.fetchDB();
                if(allUsers.find(u => u.email === email)) {
                    app.showToast("El email ya está registrado.", "error");
                    return false;
                }
                
                const newUser = {
                    name,
                    email,
                    password,
                    role: 'user',
                    status: 'pending', // Pending approval
                    banned: false,
                    profiles: [{ id: Date.now(), name: name, avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)] }]
                };
                
                allUsers.push(newUser);
                if(await app.saveDB({ users: allUsers })) {
                    app.showToast("Registro exitoso. Tu cuenta debe ser aprobada por un administrador antes de poder iniciar sesión.");
                    app.router('login');
                }
            },

            logout: () => {
                app.state.user = null;
                app.state.currentProfile = null;
                localStorage.removeItem('niro_user');
                localStorage.removeItem('niro_profile');
                app.renderHeader();
                app.router('home');
            },

            /* --- Router & Rendering --- */
            router: (route) => {
                // Clear search query on navigation
                if (app.state.searchQuery) {
                    app.state.searchQuery = null;
                    const searchInput = document.querySelector('.search-input');
                    if(searchInput) searchInput.value = '';
                }

                app.state.route = route;
                window.scrollTo(0,0);
                
                // Update active nav (Desktop)
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                // Update active nav (Mobile)
                document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
                const navId = route === 'home' ? 'nav-home' : 
                              route === 'series' ? 'nav-series' : 
                              route === 'movies' ? 'nav-movies' : 
                              route === 'mylist' ? 'nav-mylist' : 
                              route === 'admin' ? 'nav-admin' : '';
                if(navId) document.getElementById(navId)?.classList.add('active');

                if(route === 'home') app.renderHome();
                else if(route === 'movies') app.renderHome('movie');
                else if(route === 'series') app.renderHome('series');
                else if(route === 'mylist') app.renderHome('mylist');
                else if(route === 'downloads') app.renderDownloads();
                else if(route === 'admin') {
                    if(!app.state.user || app.state.user.role !== 'admin') {
                        app.router('home');
                        return;
                    }
                    app.renderAdmin();
                }
                else if(route === 'login') app.renderLogin();
                else if(route === 'register') app.renderRegister();
                else if(route === 'profiles') app.renderProfiles();
                else if(route === 'profile') app.renderProfile();
                else if(route === 'account') app.renderProfile();
            },

            renderProfiles: () => {
                const main = document.getElementById('main-view');
                const user = app.state.user;
                if(!user) { app.router('login'); return; }

                main.innerHTML = `
                    <div class="profile-gate">
                        <h1 style="font-size:3rem; margin-bottom:1rem;">¿Quién está viendo ahora?</h1>
                        <div class="profile-list">
                            ${(user.profiles || []).map(p => `
                                <div class="profile-item" onclick="app.selectProfile(${p.id})" style="cursor:pointer;">
                                    <div class="profile-avatar" style="background-image:url('${p.avatar}')"></div>
                                    <span class="profile-name">${p.name}</span>
                                </div>
                            `).join('')}
                            <div class="profile-item" onclick="app.promptAddProfile()">
                                <div class="add-profile-btn"><i class="ri-add-line"></i></div>
                                <span class="profile-name">Agregar perfil</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="margin-top:3rem; border:1px solid white; color:#808080;" onclick="app.manageProfiles()">Administrar perfiles</button>
                    </div>
                `;
                document.getElementById('main-header').style.display = 'none';
                document.body.classList.add('in-profile-gate');
            },

            selectProfile: (id) => {
                console.log("Selecting profile:", id);
                const profile = app.state.user.profiles.find(p => p.id === id);
                if(profile) {
                    if(profile.pin) {
                        // Prompt for PIN
                        openModal(`
                            <div style="padding:3rem; text-align:center;">
                                <h3 style="margin-bottom:2rem;">Introduce el PIN de perfil</h3>
                                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:2rem;">
                                    <input type="password" id="profile-pin-input" maxlength="4" 
                                        style="width:150px; text-align:center; font-size:2rem; letter-spacing:10px; background:transparent; border:none; border-bottom:2px solid white; border-radius:0;"
                                        onkeyup="if(this.value.length === 4) app.verifyProfilePin(${id})">
                                </div>
                                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                            </div>
                        `);
                        setTimeout(() => document.getElementById('profile-pin-input').focus(), 100);
                        return;
                    }
                    app.activateProfile(profile);
                } else {
                    console.error("Profile not found:", id);
                    app.showToast("Error al seleccionar perfil", "error");
                }
            },

            verifyProfilePin: (id) => {
                const input = document.getElementById('profile-pin-input');
                const pin = input.value;
                const profile = app.state.user.profiles.find(p => p.id === id);
                
                if(profile && profile.pin === pin) {
                    closeModal();
                    app.activateProfile(profile);
                } else {
                    input.value = '';
                    input.style.borderColor = 'red';
                    app.showToast("PIN Incorrecto", "error");
                }
            },

            activateProfile: (profile) => {
                console.log("Activating profile:", profile.name);
                try {
                    app.state.currentProfile = profile;
                    localStorage.setItem('niro_profile', JSON.stringify(profile));
                    
                    const header = document.getElementById('main-header');
                    if(header) header.style.display = 'block';
                    
                    document.body.classList.remove('in-profile-gate');
                    
                    app.renderHeader();
                    
                    // Force navigation to home even if route seems same
                    console.log("Routing to home...");
                    app.router('home');
                } catch(e) {
                    console.error("Error activating profile:", e);
                    app.showToast("Error al activar perfil: " + e.message, "error");
                }
            },

            selectAvatar: (el, url) => {
                document.querySelectorAll('.avatar-option').forEach(img => img.style.borderColor = 'transparent');
                el.style.borderColor = 'var(--color-brand-primary)';
                const input = document.getElementById('new-profile-avatar') || document.getElementById('edit-profile-avatar');
                if(input) input.value = url;
            },

            promptAddProfile: async () => {
                const defaultAvatar = AVATARS[0];
                openModal(`
                    <div style="padding:2rem;">
                        <h3 style="margin-bottom:1.5rem;">Nuevo Perfil</h3>
                        
                        <div style="margin-bottom:1.5rem;">
                            <label style="margin-bottom:0.5rem; display:block; color:#ccc;">Elige un avatar:</label>
                            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; scrollbar-width:thin;">
                                ${AVATARS.map((url, i) => `
                                    <img src="${url}" alt="Avatar Option" class="avatar-option" 
                                        style="width:60px; height:60px; border-radius:4px; cursor:pointer; border:3px solid ${i===0 ? 'var(--color-brand-primary)' : 'transparent'}; object-fit:cover;"
                                        onclick="app.selectAvatar(this, '${url}')">
                                `).join('')}
                            </div>
                            <input type="hidden" id="new-profile-avatar" value="${defaultAvatar}">
                        </div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input id="new-profile-name" placeholder="Nombre del perfil" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:4px;">
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.handleAddProfile()">Guardar</button>
                        </div>
                    </div>
                `);
            },

            handleAddProfile: async () => {
                const name = document.getElementById('new-profile-name').value;
                const avatar = document.getElementById('new-profile-avatar').value;
                
                if(!name) {
                    app.showToast("El nombre es requerido", "error");
                    return;
                }
                
                const newProfile = {
                    id: Date.now(),
                    name,
                    avatar
                };
                
                if(!app.state.user.profiles) app.state.user.profiles = [];
                app.state.user.profiles.push(newProfile);
                await app.saveDB({ users: allUsers });
                closeModal();
                app.renderProfiles();
            },

            editProfile: (id) => {
                const p = app.state.user.profiles.find(x => x.id === id);
                if(!p) return;
                
                // Default settings if undefined
                if(p.autoplayNext === undefined) p.autoplayNext = true;
                if(p.autoplayPreviews === undefined) p.autoplayPreviews = true;
                if(!p.maturity) p.maturity = 'all';
                if(!p.language) p.language = 'es';

                openModal(`
                    <div class="edit-profile-modal-container">
                        <h2 style="margin-bottom:2rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem; font-size:2rem;">Editar Perfil</h2>
                        
                        <div class="edit-profile-layout">
                            <div class="edit-profile-avatar-section">
                                <img src="${p.avatar}" alt="${p.name}" class="edit-profile-avatar-img" style="width:120px; height:120px; border-radius:8px; object-fit:cover; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
                            </div>
                            
                            <div class="edit-profile-form-section">
                                <div class="form-group">
                                    <label>Nombre del Perfil</label>
                                    <input id="edit-profile-name" value="${p.name}" style="background:#333; font-size:1.1rem;">
                                </div>
                                
                                <div class="form-group">
                                    <label>Idioma</label>
                                    <select id="edit-profile-language" style="background:#333;">
                                        <option value="es" ${p.language === 'es' ? 'selected' : ''}>Español</option>
                                        <option value="en" ${p.language === 'en' ? 'selected' : ''}>English</option>
                                        <option value="pt" ${p.language === 'pt' ? 'selected' : ''}>Português</option>
                                    </select>
                                </div>

                                <div style="margin-bottom:1.5rem;">
                                    <label style="margin-bottom:0.5rem; display:block; color:#ccc;">Avatar</label>
                                    <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; scrollbar-width:thin;">
                                        ${AVATARS.map((url) => `
                                            <img src="${url}" alt="Avatar Option" class="avatar-option" 
                                                style="width:50px; height:50px; border-radius:4px; cursor:pointer; border:2px solid ${url===p.avatar ? 'var(--color-brand-primary)' : 'transparent'}; object-fit:cover;"
                                                onclick="app.selectAvatar(this, '${url}')">
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="edit-profile-avatar" value="${p.avatar}">
                                </div>

                                <div style="margin-bottom:2rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1.5rem;">
                                    <h4 style="margin-bottom:1rem; color:var(--color-text-secondary); text-transform:uppercase; font-size:0.8rem; letter-spacing:1px;">Configuración de Reproducción</h4>
                                    
                                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:10px; background:rgba(255,255,255,0.05); border-radius:4px;">
                                        <span>Reproducción automática del siguiente episodio</span>
                                        <input type="checkbox" id="edit-profile-autoplay-next" ${p.autoplayNext ? 'checked' : ''} style="width:auto;">
                                    </div>
                                    
                                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding:10px; background:rgba(255,255,255,0.05); border-radius:4px;">
                                        <span>Reproducción automática de avances</span>
                                        <input type="checkbox" id="edit-profile-autoplay-previews" ${p.autoplayPreviews ? 'checked' : ''} style="width:auto;">
                                    </div>

                                    <div class="form-group">
                                        <label>Clasificación por edad</label>
                                        <select id="edit-profile-maturity" style="background:#333;">
                                            <option value="all" ${p.maturity === 'all' ? 'selected' : ''}>Todo público</option>
                                            <option value="7+" ${p.maturity === '7+' ? 'selected' : ''}>7+</option>
                                            <option value="13+" ${p.maturity === '13+' ? 'selected' : ''}>13+</option>
                                            <option value="16+" ${p.maturity === '16+' ? 'selected' : ''}>16+</option>
                                            <option value="18+" ${p.maturity === '18+' ? 'selected' : ''}>18+</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Bloqueo de Perfil (PIN)</label>
                                        <input type="text" id="edit-profile-pin" value="${p.pin || ''}" maxlength="4" placeholder="4 dígitos (opcional)" style="background:#333; letter-spacing: 2px;" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                                        <small style="color:#888;">Deja en blanco para desactivar.</small>
                                    </div>
                                    
                                    <div style="margin-top:2rem;">
                                        <button class="btn btn-secondary" onclick="app.viewHistory(${p.id})" style="width:100%; justify-content:space-between;">
                                            <span>Historial de visualización</span>
                                            <i class="ri-arrow-right-s-line"></i>
                                        </button>
                                    </div>

                                    <div style="margin-top:1rem;">
                                        <button class="btn btn-secondary" onclick="app.showToast('Configuración de subtítulos próximamente')" style="width:100%; justify-content:space-between;">
                                            <span>Aspecto de los subtítulos</span>
                                            <i class="ri-arrow-right-s-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="edit-profile-actions" style="display:flex; justify-content:space-between; align-items:center; margin-top:2rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1.5rem;">
                            <button class="btn btn-danger" onclick="app.deleteProfile(${p.id})">Eliminar Perfil</button>
                            <div style="display:flex; gap:1rem;">
                                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                <button class="btn btn-primary" onclick="app.handleEditProfile(${p.id})">Guardar</button>
                            </div>
                        </div>
                    </div>
                `);
            },

            viewHistory: (profileId) => {
                const p = app.state.user.profiles.find(x => x.id === profileId);
                if(!p) return;
                
                const history = p.continueWatching || [];
                
                openModal(`
                    <div style="padding:2rem; max-width:800px; margin:0 auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem;">
                            <h2 style="font-size:2rem;">Historial de ${p.name}</h2>
                            <button class="btn btn-secondary" onclick="app.editProfile(${p.id})">Volver</button>
                        </div>
                        
                        ${history.length === 0 ? '<p style="color:#ccc;">No hay historial de visualización.</p>' : `
                            <div style="display:flex; flex-direction:column; gap:1rem; max-height:60vh; overflow-y:auto;">
                                ${history.map(h => {
                                    const item = allItems.find(i => i.id === (h.seriesId || h.itemId));
                                    if(!item) return '';
                                    return `
                                      <div style="display:flex; gap:1rem; align-items:center; background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px;">
                                          <img src="${item.img}" alt="${item.title}" style="width:100px; aspect-ratio:16/9; object-fit:cover; border-radius:4px;">
                                          <div style="flex:1;">
                                              <h4 style="font-size:1.1rem; margin-bottom:0.5rem;">${item.title}</h4>
                                                <div style="font-size:0.9rem; color:#aaa;">
                                                    Visto el ${new Date(h.timestamp || Date.now()).toLocaleDateString()}
                                                </div>
                                                <div style="height:4px; background:rgba(255,255,255,0.1); margin-top:0.5rem; border-radius:2px; overflow:hidden;">
                                                    <div style="height:100%; width:${Math.min(100, (h.time/h.duration)*100)}%; background:var(--color-brand-primary);"></div>
                                                </div>
                                            </div>
                                            <button class="btn btn-icon" onclick="app.removeFromHistory(${p.id}, ${h.itemId}, ${h.seriesId || 'null'})"><i class="ri-delete-bin-line"></i></button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `);
            },
            
            removeFromHistory: async (pId, itemId, seriesId) => {
                const pIndex = app.state.user.profiles.findIndex(x => x.id === pId);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex].continueWatching = (app.state.user.profiles[pIndex].continueWatching || []).filter(h => 
                        !((h.itemId === itemId) && (seriesId === null ? !h.seriesId : h.seriesId === seriesId))
                    );
                    await app.saveDB({ users: allUsers });
                    app.viewHistory(pId);
                }
            },

            configureSubtitles: (id) => {
                const p = app.state.user.profiles.find(x => x.id === id);
                if(!p) return;
                
                // Default settings
                const settings = p.subtitleSettings || {
                    font: 'sans-serif',
                    size: 'medium', // small, medium, large
                    color: 'white',
                    shadow: 'drop-shadow'
                };
                
                openModal(`
                    <div style="padding:2rem; max-width:600px; margin:0 auto;">
                        <h2 style="margin-bottom:1.5rem;">Aspecto de los subtítulos</h2>
                        
                        <div style="background:#333; height:200px; display:flex; align-items:flex-end; justify-content:center; margin-bottom:2rem; border-radius:8px; overflow:hidden; position:relative; background-image:url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80'); background-size:cover;">
                            <div style="padding:20px; text-align:center;">
                                <span id="sub-preview" style="
                                    font-family: ${settings.font}; 
                                    font-size: ${settings.size === 'small' ? '1rem' : settings.size === 'large' ? '2rem' : '1.5rem'}; 
                                    color: ${settings.color}; 
                                    text-shadow: ${settings.shadow === 'drop-shadow' ? '2px 2px 4px rgba(0,0,0,0.8)' : settings.shadow === 'outline' ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none'};
                                    background: ${settings.shadow === 'box' ? 'rgba(0,0,0,0.5)' : 'transparent'};
                                    padding: 5px 10px;
                                    transition: all 0.3s;
                                ">
                                    Así se verán los subtítulos en tus dispositivos.
                                </span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Fuente</label>
                            <select id="sub-font" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="sans-serif" ${settings.font==='sans-serif'?'selected':''}>Sans Serif</option>
                                <option value="serif" ${settings.font==='serif'?'selected':''}>Serif</option>
                                <option value="monospace" ${settings.font==='monospace'?'selected':''}>Monospace</option>
                                <option value="cursive" ${settings.font==='cursive'?'selected':''}>Manuscrita</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Tamaño</label>
                            <select id="sub-size" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="small" ${settings.size==='small'?'selected':''}>Pequeño</option>
                                <option value="medium" ${settings.size==='medium'?'selected':''}>Mediano</option>
                                <option value="large" ${settings.size==='large'?'selected':''}>Grande</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Sombra / Fondo</label>
                            <select id="sub-shadow" onchange="app.updateSubPreview()" style="background:#333;">
                                <option value="drop-shadow" ${settings.shadow==='drop-shadow'?'selected':''}>Sombra paralela</option>
                                <option value="outline" ${settings.shadow==='outline'?'selected':''}>Contorno</option>
                                <option value="box" ${settings.shadow==='box'?'selected':''}>Caja oscura</option>
                                <option value="none" ${settings.shadow==='none'?'selected':''}>Ninguno</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Color de Texto</label>
                            <div style="display:flex; gap:10px;">
                                ${['white', 'yellow', 'cyan', 'lime'].map(c => `
                                    <div onclick="document.getElementById('sub-color').value='${c}'; app.updateSubPreview(); document.querySelectorAll('.color-opt').forEach(el=>el.style.borderColor='transparent'); this.style.borderColor='white';" 
                                        class="color-opt"
                                        style="width:30px; height:30px; background:${c}; border-radius:50%; cursor:pointer; border:2px solid ${settings.color===c?'white':'transparent'};"></div>
                                `).join('')}
                                <input type="hidden" id="sub-color" value="${settings.color}">
                            </div>
                        </div>
                        
                        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:2rem;">
                            <button class="btn btn-secondary" onclick="app.editProfile(${p.id})">Cancelar</button>
                            <button class="btn btn-primary" onclick="app.saveSubtitles(${p.id})">Guardar</button>
                        </div>
                    </div>
                `);
            },

            updateSubPreview: () => {
                const font = document.getElementById('sub-font').value;
                const size = document.getElementById('sub-size').value;
                const shadow = document.getElementById('sub-shadow').value;
                const color = document.getElementById('sub-color').value;
                
                const el = document.getElementById('sub-preview');
                if(!el) return;
                
                el.style.fontFamily = font;
                el.style.fontSize = size === 'small' ? '1rem' : size === 'large' ? '2rem' : '1.5rem';
                el.style.color = color;
                
                el.style.textShadow = shadow === 'drop-shadow' ? '2px 2px 4px rgba(0,0,0,0.8)' : shadow === 'outline' ? '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000' : 'none';
                el.style.background = shadow === 'box' ? 'rgba(0,0,0,0.5)' : 'transparent';
            },

            saveSubtitles: async (id) => {
                const font = document.getElementById('sub-font').value;
                const size = document.getElementById('sub-size').value;
                const shadow = document.getElementById('sub-shadow').value;
                const color = document.getElementById('sub-color').value;
                
                const pIndex = app.state.user.profiles.findIndex(x => x.id === id);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex].subtitleSettings = { font, size, shadow, color };
                    await app.saveDB({ users: allUsers });
                    
                    // Update current if needed
                    if(app.state.currentProfile && app.state.currentProfile.id === id) {
                        app.state.currentProfile = app.state.user.profiles[pIndex];
                        localStorage.setItem('niro_profile', JSON.stringify(app.state.currentProfile));
                    }
                    
                    app.editProfile(id); // Go back
                    app.showToast("Subtítulos guardados");
                }
            },

            handleEditProfile: async (id) => {
                const name = document.getElementById('edit-profile-name').value;
                const avatar = document.getElementById('edit-profile-avatar').value;
                const autoplayNext = document.getElementById('edit-profile-autoplay-next').checked;
                const autoplayPreviews = document.getElementById('edit-profile-autoplay-previews').checked;
                const maturity = document.getElementById('edit-profile-maturity').value;
                const language = document.getElementById('edit-profile-language').value;
                const pin = document.getElementById('edit-profile-pin').value;
                
                if(!name) {
                    app.showToast("El nombre es requerido", "error");
                    return;
                }
                
                const pIndex = app.state.user.profiles.findIndex(x => x.id === id);
                if(pIndex > -1) {
                    app.state.user.profiles[pIndex] = {
                        ...app.state.user.profiles[pIndex],
                        name,
                        avatar,
                        autoplayNext,
                        autoplayPreviews,
                        maturity,
                        language,
                        pin
                    };
                    
                    await app.saveDB({ users: allUsers });
                    
                    // Update current profile if it's the one being edited
                    if(app.state.currentProfile && app.state.currentProfile.id === id) {
                        app.state.currentProfile = app.state.user.profiles[pIndex];
                        localStorage.setItem('niro_profile', JSON.stringify(app.state.currentProfile));
                        app.renderHeader();
                    }
                    
                    closeModal();
                    app.manageProfiles();
                }
            },

            manageProfiles: () => {
                const user = app.state.user;
                if(!user || !user.profiles) return;

                document.getElementById('main-header').style.display = 'none';
                document.body.classList.add('in-profile-gate');
                
                const main = document.getElementById('main-view');
                main.innerHTML = `
                    <div class="manage-profiles-container"> padding:100px 20px; display:flex; flex-direction:column; align-items:center; animation:fadeIn 0.5s;">
                        <h1 class="manage-profiles-title">Administrar Perfiles</h1>
                        
                        <div class="manage-profiles-grid">
                            ${user.profiles.map(p => `
                                <div class="profile-item" style="text-align:center; position:relative; cursor:pointer;" onclick="app.editProfile(${p.id})">
                                    <div class="profile-avatar-wrapper manage-profile-avatar-wrapper">
                                        <img src="${p.avatar}" alt="${p.name}" style="width:100%; height:100%; object-fit:cover; opacity:0.6; transition:opacity 0.3s;">
                                        <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
                                            <div style="width:50px; height:50px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; color:white;">
                                                <i class="ri-pencil-fill" style="font-size:1.5rem;"></i>
                                            </div>
                                        </div>
                                        ${p.pin ? '<div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:4px; border-radius:50%;"><i class="ri-lock-fill" style="color:white;"></i></div>' : ''}
                                    </div>
                                    <span style="font-size:1.2rem; color:#808080;">${p.name}</span>
                                </div>
                            `).join('')}
                            
                            <div class="profile-item" onclick="app.promptAddProfile()" style="text-align:center; cursor:pointer;">
                                <div class="profile-avatar-wrapper manage-profile-avatar-wrapper" style="display:flex; align-items:center; justify-content:center; background:transparent; border:1px solid #808080; color:#808080;">
                                    <i class="ri-add-line" style="font-size:3rem;"></i>
                                </div>
                                <span style="font-size:1.2rem; color:#808080;">Agregar Perfil</span>
                            </div>
                        </div>
                        
                        <button onclick="app.renderProfiles()" class="btn" style="background:white; color:black; padding:10px 40px; letter-spacing:1px; font-size:1.1rem; font-weight:bold; border-radius:4px;">LISTO</button>
                    </div>
                `;
            },

            deleteProfile: async (id) => {
                if(app.state.user.profiles.length <= 1) {
                    app.showToast("Debe haber al menos un perfil.", "error");
                    return;
                }
                
                app.confirmAction("¿Eliminar este perfil y todo su historial?", async () => {
                    app.state.user.profiles = app.state.user.profiles.filter(p => p.id !== id);
                    await app.saveDB({ users: allUsers });
                    app.manageProfiles(); // Refresh modal
                });
            },

            toggleMyList: async (itemId) => {
                if(!app.state.user) return app.router('login');
                const user = app.state.user;
                if(!user.myList) user.myList = [];
                
                // Use loose equality to handle string/number ID mismatch
                const idx = user.myList.findIndex(id => id == itemId);
                if(idx > -1) {
                    user.myList.splice(idx, 1);
                    app.showToast("Eliminado de Mi Lista");
                } else {
                    user.myList.push(itemId);
                    app.showToast("Agregado a Mi Lista");
                    
                    // Confetti Effect
                    setTimeout(() => {
                        const btn = document.getElementById(`btn-mylist-${itemId}`);
                        if(btn) {
                            const rect = btn.getBoundingClientRect();
                            runConfetti(rect.left + rect.width/2, rect.top + rect.height/2);
                        } else {
                            // Fallback to center if button not found (e.g. hero button)
                            runConfetti(window.innerWidth/2, window.innerHeight/2);
                        }
                    }, 100);
                }
                
                // Update button if exists
                const btn = document.getElementById(`btn-mylist-${itemId}`);
                if(btn) {
                    const inList = idx === -1; // We just added it
                    btn.className = `btn ${inList ? 'btn-primary' : 'btn-secondary'}`;
                    btn.innerHTML = `<i class="${inList ? 'ri-check-line' : 'ri-add-line'}"></i> ${inList ? 'En mi lista' : 'Mi Lista'}`;
                }
                
                // Refresh if on My List view to prevent stale items - Optimized to avoid full re-render
                if(app.state.route === 'mylist') {
                     const card = document.getElementById(`card-${itemId}`);
                     if(card) {
                         // Animate removal if we are removing
                         if(idx > -1) {
                             card.style.transition = 'all 0.3s ease';
                             card.style.opacity = '0';
                             card.style.transform = 'scale(0.9)';
                             setTimeout(() => {
                                 card.remove();
                                 // Check if empty
                                 if(!user.myList || user.myList.length === 0) {
                                    app.renderHome('mylist'); // Show empty state
                                 }
                             }, 300);
                         }
                     } else if (idx === -1) {
                         // We added an item while on my list view? (Rare, but possible if undoing)
                         // In this case, a full refresh is safer to put it in correct order
                         setTimeout(() => app.renderHome('mylist'), 100);
                     }
                }

                // Persist
                const uIdx = allUsers.findIndex(u => u.email === user.email);
                if(uIdx > -1) {
                    allUsers[uIdx] = user;
                    await app.saveDB({ users: allUsers });
                    localStorage.setItem('niro_user', JSON.stringify(user));
                }
            },

            shareItem: (itemId) => {
                const item = allItems.find(i => i.id === itemId);
                if(!item) return;
                
                const shareData = {
                    title: 'NIRO: ' + item.title,
                    text: `Mira "${item.title}" en NIRO Streaming.`,
                    url: window.location.origin + '/?item=' + itemId
                };

                if (navigator.share) {
                    navigator.share(shareData).catch(console.error);
                } else {
                    navigator.clipboard.writeText(shareData.text + ' ' + shareData.url).then(() => {
                        app.showToast("Enlace copiado al portapapeles");
                    });
                }
            },

            setSearch: (query) => {
                app.state.searchQuery = query;
                const input = document.getElementById('search-input');
                if(input) {
                    input.value = query;
                    input.focus();
                }
                app.renderHome();
            },

            playTrailer: (url) => {
                const modal = document.getElementById('generic-modal');
                const content = document.getElementById('generic-modal-content');
                
                // Check if it's a YouTube URL to embed or a direct video file
                let videoHtml = '';
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    // Extract ID (simple regex)
                    let videoId = '';
                    if(url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                    else if(url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1];
                    
                    videoHtml = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else {
                    videoHtml = `<video src="${url}" controls autoplay style="width:100%; height:100%; max-height:80vh;"></video>`;
                }

                content.innerHTML = `
                    <div style="position:relative; width:90vw; max-width:1000px; aspect-ratio:16/9; background:black; border-radius:8px; overflow:hidden; box-shadow:0 0 50px rgba(0,0,0,0.5);">
                        <button onclick="document.getElementById('generic-modal').style.display='none'; document.getElementById('generic-modal-content').innerHTML='';" style="position:absolute; top:10px; right:10px; z-index:100; background:rgba(0,0,0,0.5); border:none; color:white; font-size:1.5rem; cursor:pointer; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="ri-close-line"></i></button>
                        ${videoHtml}
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                // Close on click outside
                modal.onclick = (e) => {
                    if(e.target === modal) {
                        modal.style.display = 'none';
                        content.innerHTML = '';
                    }
                };
            },

            // --- Card Interactivity (Hover Preview) ---
            previewTimeout: null,
            startCardPreview: (cardElement, trailerUrl) => {
                if(!trailerUrl || app.isMobile()) return;
                
                app.previewTimeout = setTimeout(() => {
                    const previewContainer = cardElement.querySelector('.card-preview-container');
                    if(previewContainer) {
                        // For YouTube trailers
                        if(trailerUrl.includes('youtube.com') || trailerUrl.includes('youtu.be')) {
                             let videoId = '';
                             if(trailerUrl.includes('v=')) videoId = trailerUrl.split('v=')[1].split('&')[0];
                             else if(trailerUrl.includes('youtu.be/')) videoId = trailerUrl.split('youtu.be/')[1];
                             
                             if(videoId) {
                                 previewContainer.innerHTML = `
                                    <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&start=10&end=30&modestbranding=1&loop=1&playlist=${videoId}" 
                                        style="position:absolute; inset:0; width:100%; height:100%; border:none; object-fit:cover; pointer-events:none;" 
                                        allow="autoplay; encrypted-media"></iframe>
                                 `;
                                 previewContainer.style.opacity = '1';
                             }
                        } else {
                            // Direct video file
                            previewContainer.innerHTML = `
                                <video src="${trailerUrl}" autoplay muted loop playsinline 
                                    style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;">
                                </video>
                            `;
                            previewContainer.style.opacity = '1';
                        }
                    }
                }, 800); // 800ms delay to prevent accidental triggers
            },

            stopCardPreview: (cardElement) => {
                if(app.previewTimeout) clearTimeout(app.previewTimeout);
                const previewContainer = cardElement.querySelector('.card-preview-container');
                if(previewContainer) {
                    previewContainer.style.opacity = '0';
                    setTimeout(() => {
                         previewContainer.innerHTML = '';
                    }, 300);
                }
            },
            
            isMobile: () => {
                return window.innerWidth <= 768;
            },

            downloadItem: async (id, parentId = null) => {
                if(!app.state.user) return app.showToast("Debes iniciar sesión para descargar contenido.", "error");

                let item, videoUrl, title, poster, type, downloadId;

                if (parentId) {
                    // It's an episode
                    const parent = allItems.find(i => i.id === parentId);
                    if (!parent) return;
                    
                    let episode;
                    for (const s of parent.seasons) {
                        episode = s.episodes.find(e => e.id === id);
                        if (episode) break;
                    }
                    if (!episode) return;

                    item = { ...episode, type: 'episode', parentId: parent.id };
                    videoUrl = episode.video;
                    title = `${parent.title} - ${episode.title}`;
                    poster = episode.img || parent.img;
                    type = 'series';
                    downloadId = episode.id;
                } else {
                    // Movie
                    item = allItems.find(i => i.id === id);
                    if (!item) return;
                    
                    if (item.type === 'series') {
                        const epsContainer = document.getElementById('episodes-container');
                        if(epsContainer) {
                            epsContainer.scrollIntoView({behavior: 'smooth'});
                            app.showToast("Selecciona un episodio de la lista para descargar.", "info");
                        } else {
                            app.showToast("No hay episodios disponibles para descargar.", "error");
                        }
                        return;
                    }

                    if (item.type !== 'movie' || !item.video) {
                        app.showToast("Contenido no disponible para descarga.", "info");
                        return;
                    }
                    
                    videoUrl = item.video;
                    title = item.title;
                    poster = item.img;
                    type = item.type;
                    downloadId = item.id;
                }

                if (await DownloadManager.has(downloadId)) {
                     app.confirmAction("¿Eliminar descarga de este dispositivo?", async () => {
                         await DownloadManager.remove(downloadId);
                         app.showToast("Descarga eliminada");
                         openDetails(parentId || downloadId); // Refresh UI
                     });
                     return;
                }

                app.showToast("Iniciando descarga...", "info");
                
                // Update active downloads state
                app.state.activeDownloads = (app.state.activeDownloads || 0) + 1;
                app.renderHeader();

                const btn = document.getElementById(`btn-download-${downloadId}`);
                let originalContent = '';
                if(btn) {
                    originalContent = btn.innerHTML;
                    btn.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> 0%`;
                    btn.disabled = true;
                }

                try {
                    await DownloadManager.save(downloadId, videoUrl, {
                        title: title,
                        poster: poster,
                        type: type,
                        desc: item.desc || '',
                        year: item.year || '',
                        genre: item.genre || '',
                        rating: item.rating || '',
                        parentId: parentId
                    }, (progress) => {
                        if(btn) btn.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> ${(progress*100).toFixed(0)}%`;
                    });
                    
                    app.showToast("Descarga completada", "success");
                    app.state.activeDownloads = Math.max(0, (app.state.activeDownloads || 1) - 1);
                    app.renderHeader();
                    openDetails(parentId || downloadId); // Refresh UI
                } catch(e) {
                    console.error(e);
                    app.showToast("Error en la descarga. Verifica tu conexión.", "error");
                    app.state.activeDownloads = Math.max(0, (app.state.activeDownloads || 1) - 1);
                    app.renderHeader();
                    if(btn) {
                        btn.innerHTML = originalContent || `<i class="ri-download-line"></i>`;
                        btn.disabled = false;
                    }
                }
            },

            installApp: async () => {
                const ua = navigator.userAgent.toLowerCase();
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
                const isMac = /macintosh|mac os x/i.test(ua);
                
                // Logic: Mobile -> PWA, Mac -> PWA Instructions, PC -> EXE
                
                if (isMobile) {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            deferredPrompt = null;
                            app.renderHeader();
                        }
                    } else {
                        if (/iphone|ipad|ipod/.test(ua)) {
                            app.showToast("En iOS: Pulsa el botón 'Compartir' y elige 'Agregar a Inicio'.", "info");
                        } else {
                            app.showToast("Usa el menú de tu navegador y selecciona 'Instalar aplicación'.", "info");
                        }
                    }
                } else if (isMac) {
                    // Mac PWA instructions with visual feedback
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                    } else {
                        // Create modal for Mac instructions
                        const modalHtml = `
                            <div style="text-align:center; padding:20px;">
                                <i class="ri-apple-fill" style="font-size:3rem; margin-bottom:15px;"></i>
                                <h3 style="margin-bottom:15px;">Instalar en Mac</h3>
                                <p style="margin-bottom:20px; color:#ccc;">Para instalar NIRO en tu Mac:</p>
                                <ol style="text-align:left; display:inline-block; color:#ccc; line-height:1.6;">
                                    <li>1. Abre <strong>Safari</strong> o <strong>Chrome</strong></li>
                                    <li>2. Ve al menú del navegador o botón compartir</li>
                                    <li>3. Selecciona <strong>"Agregar al Dock"</strong> o <strong>"Crear acceso directo"</strong></li>
                                </ol>
                                <button class="btn btn-primary" onclick="closeModal()" style="margin-top:20px; width:100%;">Entendido</button>
                            </div>
                        `;
                        openModal(modalHtml);
                    }
                } else {
                    // PC / Windows -> Download EXE directly
                    const a = document.createElement('a');
                    a.href = '/NIRO_App.exe';
                    a.download = 'NIRO.exe';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    app.showToast("Descargando aplicación NIRO...", "success");
                }
            },

            toggleNotifications: () => {
                const menu = document.getElementById('notification-dropdown');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },

            toggleContinueMenu: () => {
                const menu = document.getElementById('continue-dropdown-menu');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },
            
            toggleProfileMenu: () => {
                const menu = document.getElementById('profile-dropdown-menu');
                if(menu) {
                    const isHidden = menu.style.display === 'none';
                    // Hide other menus
                    document.querySelectorAll('[id$="-dropdown-menu"], [id$="-dropdown"]').forEach(el => el.style.display = 'none');
                    // Toggle current
                    menu.style.display = isHidden ? 'block' : 'none';
                }
            },

            markNotificationsRead: async () => {
                if(!app.state.notifications || app.state.notifications.length === 0) return;
                
                // Update local state
                app.state.notifications = [];
                
                // Update DB
                await app.saveDB({ notifications: [] });
                
                app.renderHeader();
                app.showToast("Notificaciones marcadas como leídas");
            },

            deleteNotification: async (index) => {
                if(!app.state.notifications) return;
                
                const notifs = [...app.state.notifications];
                notifs.splice(index, 1);
                app.state.notifications = notifs;
                
                await app.saveDB({ notifications: notifs });
                app.renderHeader();
                app.toggleNotifications(); // Re-open to show update
            },

            handleSearch: (query) => {
                const resultsContainer = document.getElementById('search-results-dropdown');
                
                // Show Suggestions if query is empty (Search inteligente)
                if (!query || query.trim().length === 0) {
                    if (resultsContainer) {
                        // Suggest top items based on match score or just popular ones
                        const suggestions = [...allItems].sort((a,b) => (b.match||0) - (a.match||0)).slice(0, 5);
                        
                        let html = `<div style="padding:10px 15px; font-size:0.8rem; color:var(--color-brand-primary); font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.05); text-transform:uppercase; letter-spacing:1px;">Tendencias</div>`;
                        
                        if(suggestions.length > 0) {
                            html += suggestions.map((item, idx) => `
                                <div onclick="openDetails(${item.id}); document.getElementById('search-results-dropdown').style.display='none';" 
                                     style="padding:10px 15px; display:flex; gap:12px; cursor:pointer; align-items:center; transition:0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                    <div style="font-size:1.2rem; font-weight:800; color:rgba(255,255,255,0.2); width:20px; text-align:center;">${idx+1}</div>
                                    <div style="font-size:0.9rem; color:white; font-weight:500;">${item.title}</div>
                                    ${item.year ? `<div style="font-size:0.75rem; color:#666; margin-left:auto;">${item.year}</div>` : ''}
                                </div>
                            `).join('');
                        } else {
                            html += `<div style="padding:15px; color:#666; font-size:0.9rem;">Explora nuestro catálogo...</div>`;
                        }
                        
                        resultsContainer.innerHTML = html;
                        resultsContainer.style.display = 'block';
                    }
                    return;
                }

                const q = query.toLowerCase();
                
                // Weighted search
                const scoredItems = allItems.map(item => {
                    let score = 0;
                    if (item.title.toLowerCase() === q) score += 100; // Exact match
                    else if (item.title.toLowerCase().startsWith(q)) score += 50; // Starts with
                    else if (item.title.toLowerCase().includes(q)) score += 20; // Contains
                    
                    if (item.genre && item.genre.toLowerCase().includes(q)) score += 10;
                    if (item.cast && item.cast.toLowerCase().includes(q)) score += 5;
                    if (item.director && item.director.toLowerCase().includes(q)) score += 5;
                    
                    return { item, score };
                }).filter(x => x.score > 0).sort((a,b) => b.score - a.score);

                const matches = scoredItems.slice(0, 8).map(x => x.item);

                if (resultsContainer) {
                    if (matches.length > 0) {
                        const movies = matches.filter(m => m.type === 'movie');
                        const series = matches.filter(m => m.type === 'series');
                        
                        let html = '';
                        
                        if(movies.length > 0) {
                            html += `<div style="padding:8px 15px; font-size:0.7rem; color:var(--color-text-secondary); text-transform:uppercase; font-weight:bold; letter-spacing:1px; background:rgba(255,255,255,0.02);">Películas</div>`;
                            html += movies.map(item => app.renderSearchItem(item)).join('');
                        }
                        
                        if(series.length > 0) {
                            html += `<div style="padding:8px 15px; font-size:0.7rem; color:var(--color-text-secondary); text-transform:uppercase; font-weight:bold; letter-spacing:1px; background:rgba(255,255,255,0.02); margin-top:5px;">Series</div>`;
                            html += series.map(item => app.renderSearchItem(item)).join('');
                        }
                        
                        // 'View all' option if more results might exist
                        if(scoredItems.length > 8) {
                             html += `
                                <div onclick="app.setSearch('${query}')" style="padding:12px; text-align:center; font-size:0.9rem; color:var(--color-brand-primary); cursor:pointer; border-top:1px solid rgba(255,255,255,0.1); font-weight:bold; transition:0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                    Ver todos los resultados (${scoredItems.length})
                                </div>
                             `;
                        }
                        
                        resultsContainer.innerHTML = html;
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = `<div style="padding:20px; text-align:center; color:#888; font-style:italic;">No se encontraron resultados para "${query}"</div>`;
                        resultsContainer.style.display = 'block';
                    }
                }
            },

            renderSearchItem: (item) => {
                return `
                    <div onclick="openDetails(${item.id}); document.getElementById('search-results-dropdown').style.display='none';" 
                         style="padding:10px 15px; display:flex; gap:12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.03); align-items:center; transition:0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='transparent'">
                        <img src="${item.poster || item.img}" style="width:45px; height:68px; object-fit:cover; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.5);">
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:0.95rem; color:white; margin-bottom:3px;">${item.title}</div>
                            <div style="font-size:0.75rem; color:#aaa; display:flex; gap:8px; align-items:center;">
                                <span>${item.year || 'N/A'}</span>
                                <span style="width:3px; height:3px; background:#666; border-radius:50%;"></span>
                                <span style="color:var(--color-brand-accent);">${item.rating || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="opacity:0; transform:translateX(10px); transition:0.2s;" class="search-item-arrow">
                            <i class="ri-arrow-right-s-line" style="color:var(--color-brand-primary);"></i>
                        </div>
                    </div>
                `;
            },

            isApp: () => {
                try {
                    const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
                    return isStandalone || 
                           (window.navigator && window.navigator.standalone) || 
                           (window.pywebview !== undefined) ||
                           /NIRO_App/.test(navigator.userAgent);
                } catch(e) { return false; }
            },

            
            renderHeader: () => {
                // Update Mobile Nav Avatar
                const user = app.state.user;
                const profile = app.state.currentProfile;
                const navAvatar = document.getElementById('mobile-nav-avatar');
                if(navAvatar) {
                    if(profile && profile.avatar) {
                        navAvatar.src = profile.avatar;
                    } else {
                        // Default/Placeholder
                        navAvatar.src = "https://ui-avatars.com/api/?name=User&background=random"; 
                    }
                }
                
                // Highlight active mobile nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const route = app.state.route;
                if(route === 'home') document.getElementById('nav-home')?.classList.add('active');
                if(route === 'series') document.getElementById('nav-series')?.classList.add('active');
                if(route === 'movies') document.getElementById('nav-movies')?.classList.add('active');
                if(route === 'mylist') document.getElementById('nav-mylist')?.classList.add('active');
                if(route === 'profile') document.getElementById('nav-profile')?.classList.add('active');
                
                const h = document.getElementById('main-header');
                const showInstall = !app.isApp();
                
                const notifCount = (app.state.notifications || []).length;
                const myListCount = (profile && profile.myList) ? profile.myList.length : 0;
                h.innerHTML = `
                    <div class="header-content">
                        <a href="#" class="logo" onclick="app.router('home')" style="display:flex;align-items:center;">
                            <img src="Niro_original.png" alt="NIRO" style="height:40px; width:auto;">
                        </a>
                        <nav class="nav-menu">
                            <a class="nav-link ${app.state.route==='home'?'active':''}" onclick="app.router('home')">Inicio</a>
                            <a class="nav-link ${app.state.route==='series'?'active':''}" onclick="app.router('series')">Series</a>
                            <a class="nav-link ${app.state.route==='movies'?'active':''}" onclick="app.router('movies')">Películas</a>
                            <a class="nav-link ${app.state.route==='downloads'?'active':''}" onclick="app.router('downloads')">Descargas</a>
                        </nav>
                        
                        <div style="margin-left:auto; display:flex; align-items:center; gap:20px;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <!-- Watchlist Indicator -->
                                ${user && profile ? `
                                <div style="position:relative; cursor:pointer;" onclick="app.router('mylist')" title="Mi Lista">
                                    <i class="ri-bookmark-line" style="font-size:1.2rem; color:var(--color-text-secondary); transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--color-text-secondary)'"></i>
                                    ${myListCount > 0 ? `<span style="position:absolute; top:-6px; right:-6px; min-width:16px; height:16px; background:var(--color-brand-primary); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:bold; padding:0 3px; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.5);">${myListCount}</span>` : ''}
                                </div>
                                ` : ''}

                                <!-- Download Status -->
                                <div style="position:relative; cursor:pointer;" onclick="app.router('downloads')" title="Descargas">
                                     <i class="ri-download-cloud-2-line" style="font-size:1.2rem; color:var(--color-text-secondary); transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--color-text-secondary)'"></i>
                                     <span id="header-download-badge" style="display:none; position:absolute; top:-6px; right:-6px; min-width:16px; height:16px; background:var(--color-brand-accent); border-radius:8px; align-items:center; justify-content:center; font-size:0.65rem; font-weight:bold; padding:0 3px; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.5);"></span>
                                </div>

                                <div class="search-bar" style="position:relative;">
                                    <i class="ri-search-line" style="color:var(--color-text-secondary);"></i>
                                    <input type="text" class="search-input" placeholder="Buscar..." oninput="app.debouncedSearch(this.value)" onfocus="app.handleSearch(this.value)" onblur="setTimeout(() => { if(document.getElementById('search-results-dropdown')) document.getElementById('search-results-dropdown').style.display='none' }, 200)">
                                    <div id="search-results-dropdown" style="display:none; position:absolute; top:110%; left:0; right:0; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; max-height:400px; overflow-y:auto; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.8);"></div>
                                </div>
                                ${user ? `
                                    <div style="position:relative;">
                                        <div style="cursor:pointer; position:relative;" onclick="app.toggleNotifications()">
                                            <i class="ri-notification-3-line" style="font-size:1.2rem; color:var(--color-text-secondary);"></i>
                                            ${notifCount > 0 ? `<span style="position:absolute; top:-6px; right:-6px; min-width:16px; height:16px; background:#e50914; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:bold; padding:0 3px; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.5);">${notifCount}</span>` : ''}
                                        </div>
                                        <div id="notification-dropdown" style="display:none; position:absolute; top:120%; right:0; width:300px; background:rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:0; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            <div style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:bold; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center;">
                                                <span>Notificaciones</span>
                                                <span style="font-size:0.7rem; color:var(--color-brand-primary); cursor:pointer;" onclick="app.markNotificationsRead()">Marcar todo leído</span>
                                            </div>
                                            <div style="max-height:300px; overflow-y:auto;">
                                                ${((app.state.notifications||[]).length === 0) ? `<div style="padding:15px; color:#aaa;">Sin notificaciones</div>` : (app.state.notifications||[]).map((n,i)=>`
                                                    <div style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; gap:10px; align-items:center; transition:0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                                        <div style="width:40px; height:60px; background:rgba(255,255,255,0.1); border-radius:4px; display:flex; align-items:center; justify-content:center;"><i class="ri-notification-3-line"></i></div>
                                                        <div style="flex:1;">
                                                            <div style="font-size:0.85rem; color:white;">${n.title || 'Aviso'}</div>
                                                            <div style="font-size:0.7rem; color:#aaa;">${n.message || ''}</div>
                                                        </div>
                                                        <button onclick="app.deleteNotification(${i})" style="background:none; border:none; color:#aaa; cursor:pointer;">
                                                            <i class="ri-close-line"></i>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="header-actions" style="margin-left:0;">
                                ${!user ? `
                                    <button class="btn btn-primary" onclick="app.router('login')">Iniciar Sesión</button>
                                ` : `
                                    <!-- Continue Watching Dropdown Trigger -->
                                    <div style="position:relative; margin-right:15px;">
                                        <div onclick="app.toggleContinueMenu()" style="cursor:pointer; width:32px; height:32px; display:flex; align-items:center; justify-content:center; position:relative;">
                                            <i class="ri-time-line" style="font-size:1.4rem; color:var(--color-text-secondary); transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--color-text-secondary)'"></i>
                                            ${(profile?.continueWatching?.length > 0) ? `<div style="position:absolute; top:2px; right:2px; width:8px; height:8px; background:var(--color-brand-primary); border-radius:50%; border:1px solid #000;"></div>` : ''}
                                        </div>

                                        <div id="continue-dropdown-menu" style="display:none; position:absolute; top:120%; right:-50px; width:320px; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:15px; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            <h4 style="margin-bottom:12px; font-size:0.9rem; color:#aaa; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                                                Continuar Viendo
                                                <span style="font-size:0.7rem; color:var(--color-brand-primary); cursor:pointer;" onclick="app.router('continue')">Ver Todo</span>
                                            </h4>
                                            
                                            <div style="display:flex; flex-direction:column; gap:10px;">
                                            ${(profile?.continueWatching || []).slice(0, 3).map(cw => {
                                                const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                                                if(!realItem) return '';
                                                const pct = (cw.time / cw.duration) * 100;
                                                // If series, get ep title
                                                let subTitle = cw.title || 'Continuar';
                                                
                                                return `
                                                    <div onclick="playItem(${realItem.id})" style="display:flex; gap:12px; cursor:pointer; group:hover; padding:5px; border-radius:6px; transition:0.2s; background:rgba(255,255,255,0.02);" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                                                        <div style="position:relative; width:110px; height:62px; flex-shrink:0; border-radius:4px; overflow:hidden;">
                                                            <img src="${realItem.img}" style="width:100%; height:100%; object-fit:cover;">
                                                            <div style="position:absolute; bottom:0; left:0; right:0; height:3px; background:rgba(255,255,255,0.3);">
                                                                <div style="width:${pct}%; height:100%; background:var(--color-brand-primary);"></div>
                                                            </div>
                                                            <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
                                                                <i class="ri-play-fill" style="color:white;"></i>
                                                            </div>
                                                        </div>
                                                        <div style="flex:1; overflow:hidden; display:flex; flex-direction:column; justify-content:center;">
                                                            <div style="font-size:0.9rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white;">${realItem.title}</div>
                                                            <div style="font-size:0.75rem; color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${subTitle}</div>
                                                            <div style="font-size:0.7rem; color:var(--color-brand-primary); margin-top:2px;">Restante: ${Math.floor((cw.duration - cw.time)/60)} min</div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                            </div>

                                            ${(!profile?.continueWatching || profile.continueWatching.length === 0) ? '<div style="color:#666; font-size:0.85rem; text-align:center; padding:20px 0;">No tienes contenido pendiente</div>' : ''}
                                        </div>
                                    </div>

                                    <div style="position:relative;">
                                        <div class="profile-dropdown-trigger" onclick="app.toggleProfileMenu()" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                            <div class="profile-avatar" style="width:32px; height:32px; border-radius:4px; background-image:url('${profile ? profile.avatar : ''}'); background-size:cover;"></div>
                                            <i class="ri-arrow-down-s-fill" style="color:white; font-size:0.8rem;"></i>
                                        </div>
                                        
                                        <div id="profile-dropdown-menu" style="display:none; position:absolute; top:120%; right:0; width:200px; background:rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:10px 0; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                            ${user.profiles.map(p => `
                                                <div onclick="app.selectProfile(${p.id})" style="padding:10px 20px; display:flex; align-items:center; gap:10px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05);">
                                                    <img src="${p.avatar}" alt="${p.name}" style="width:32px; height:32px; border-radius:4px; object-fit:cover;">
                                                    <span style="font-size:0.9rem; ${p.id === profile?.id ? 'font-weight:bold;' : 'color:#aaa;'}">${p.name}</span>
                                                </div>
                                            `).join('')}
                                            
                                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>

                                            <div onclick="app.router('account')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px; transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#ccc'">
                                                <i class="ri-user-settings-line"></i> Cuenta
                                            </div>
                                            <div onclick="app.showToast('Configuración próximamente')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px; transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#ccc'">
                                                <i class="ri-settings-3-line"></i> Configuración
                                            </div>
                                            <div onclick="app.showToast('Ayuda próximamente')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px; transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#ccc'">
                                                <i class="ri-question-line"></i> Ayuda
                                            </div>
                                            
                                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>

                                            <div onclick="app.router('profiles')" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:10px; transition:0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#ccc'">
                                                <i class="ri-arrow-left-right-line"></i> Cambiar de perfil
                                            </div>
                                            
                                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                                    
                            ${showInstall ? `
                                <div onclick="app.installApp()" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:var(--color-brand-accent); font-weight:bold; display:flex; align-items:center; gap:8px;">
                                    <i class="ri-download-cloud-2-line"></i> Instalar App
                                </div>
                            ` : ''}
                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                            <a href="/NIRO_App.exe" download style="text-decoration:none;">
                                <div style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:var(--color-text-secondary); display:flex; align-items:center; gap:8px;">
                                    <i class="ri-windows-fill"></i> Descargar App PC
                                </div>
                            </a>
                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
                            <div onclick="app.logout()" style="padding:10px 20px; cursor:pointer; font-size:0.9rem; color:#ccc;">Cerrar sesión</div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

                // Check downloads status
                DownloadManager.list().then(list => {
                    const badge = document.getElementById('header-download-badge');
                    if(badge) {
                        const count = list.length;
                        const active = app.state.activeDownloads > 0;
                        
                        if(count > 0 || active) {
                            badge.style.display = 'flex';
                            badge.innerText = count + (active ? '+' : '');
                            badge.style.background = active ? 'var(--color-brand-accent)' : 'var(--color-brand-primary)';
                            badge.title = active ? 'Descargas activas...' : 'Descargas completadas';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });

            },

            deleteDownload: async (id, isFolder=false) => {
                app.confirmAction(isFolder ? "¿Eliminar toda la serie de descargas?" : "¿Eliminar esta descarga?", async () => {
                    if(isFolder) {
                        const downloads = await DownloadManager.list();
                        const toDelete = downloads.filter(d => d.parentId == id || d.seriesId == id);
                        for(const d of toDelete) {
                            await DownloadManager.remove(d.id);
                        }
                    } else {
                        await DownloadManager.remove(id);
                    }
                    app.showToast("Contenido eliminado");
                    app.renderDownloads();
                });
            },

            renderDownloads: async () => {
                if(!app.state.user) { app.router('login'); app.showToast("Debes iniciar sesión para ver descargas", "error"); return; }
                const main = document.getElementById('main-view');
                const viewingSeriesId = app.state.viewingDownloadSeriesId;
                
                main.innerHTML = `
                    <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto; text-align:center;">
                        <i class="ri-download-cloud-2-line" style="font-size:4rem; color:var(--color-text-secondary);"></i>
                        <h2 style="margin:1rem 0 2rem;">Mis Descargas</h2>
                        ${viewingSeriesId ? `<button onclick="app.state.viewingDownloadSeriesId=null; app.renderDownloads()" class="btn btn-secondary" style="margin-bottom:1rem;"><i class="ri-arrow-left-line"></i> Volver</button>` : ''}
                        <div id="downloads-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:1.5rem; text-align:left;">
                            <div style="grid-column:1/-1; text-align:center;">Cargando...</div>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

                
                try {
                    const downloads = await DownloadManager.list();
                    const grid = document.getElementById('downloads-grid');
                    
                    if (downloads.length === 0) {
                        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#888;">No tienes contenido descargado.</p>';
                        return;
                    }

                    if (viewingSeriesId) {
                        // Render episodes of specific series
                        const episodes = downloads.filter(d => d.parentId == viewingSeriesId || d.seriesId == viewingSeriesId);
                        if(episodes.length === 0) {
                             app.state.viewingDownloadSeriesId = null;
                             app.renderDownloads();
                             return;
                        }
                        
                        grid.innerHTML = episodes.map(d => `
                            <div class="card" onclick="playItem(${d.id})" style="flex:auto; aspect-ratio:16/9; position:relative;">
                                <button onclick="event.stopPropagation(); app.deleteDownload(${d.id})" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                    ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-movie-2-line" style="font-size:2rem;"></i>'}
                                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;">
                                        <i class="ri-play-circle-line" style="font-size:3rem; color:white; opacity:0.8;"></i>
                                    </div>
                                </div>
                                <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                    <h4 style="font-size:0.9rem;">${d.title}</h4>
                                    <span style="font-size:0.7rem; color:#ccc;">${(d.size / (1024*1024)).toFixed(1)} MB</span>
                                </div>
                            </div>
                        `).join('');

                    } else {
                        // Group by Series
                        const groups = {};
                        const items = [];
                        
                        for(const d of downloads) {
                            if(d.type === 'series' || d.parentId) {
                                const pId = d.parentId || 'unknown';
                                if(!groups[pId]) {
                                    const realSeries = allItems.find(i => i.id == pId);
                                    groups[pId] = {
                                        id: pId,
                                        title: realSeries ? realSeries.title : (d.title.split(' - ')[0] || 'Serie'),
                                        poster: realSeries ? realSeries.img : d.poster,
                                        type: 'series-folder',
                                        count: 0
                                    };
                                }
                                groups[pId].count++;
                            } else {
                                items.push(d);
                            }
                        }
                        
                        const finalItems = [...items, ...Object.values(groups)];
                        
                        grid.innerHTML = finalItems.map(d => {
                            if(d.type === 'series-folder') {
                                return `
                                    <div class="card" onclick="app.state.viewingDownloadSeriesId='${d.id}'; app.renderDownloads()" style="flex:auto; aspect-ratio:2/3; position:relative;">
                                        <button onclick="event.stopPropagation(); app.deleteDownload('${d.id}', true)" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar Serie">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                        <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                            ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-tv-line" style="font-size:2rem;"></i>'}
                                        </div>
                                        <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                            <h4 style="font-size:0.9rem;">${d.title}</h4>
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <span style="font-size:0.7rem; background:var(--color-brand-primary); padding:2px 6px; border-radius:4px;">SERIE</span>
                                                <span style="font-size:0.7rem; color:#ccc;">${d.count} EPS</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="card" onclick="playItem(${d.id})" style="flex:auto; aspect-ratio:2/3; position:relative;">
                                        <button onclick="event.stopPropagation(); app.deleteDownload(${d.id})" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:#ff4444; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); transition:0.2s;" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                        <div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#555; overflow:hidden; border-radius:6px;">
                                            ${d.poster ? `<img src="${d.poster}" class="card-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="ri-movie-2-line" style="font-size:2rem;"></i>'}
                                        </div>
                                        <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                            <h4 style="font-size:0.9rem;">${d.title}</h4>
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <span style="font-size:0.7rem; background:var(--color-brand-primary); padding:2px 6px; border-radius:4px;">PELÍCULA</span>
                                                <span style="font-size:0.7rem; color:#ccc;">${(d.size / (1024*1024)).toFixed(1)} MB</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('');
                    }
                } catch(e) {
                    console.error(e);
                    document.getElementById('downloads-grid').innerText = "Error cargando descargas.";
                }
            },

            renderHome: async (filterType = null) => {
                // PATCH: Robust check for globals
                if(typeof allItems === 'undefined' || !Array.isArray(allItems)) allItems = [];
                if(typeof allUsers === 'undefined' || !Array.isArray(allUsers)) allUsers = [];

                const main = document.getElementById('main-view');
                const isOffline = !navigator.onLine;

                if (isOffline) {
                    app.renderDownloads();
                    return;
                }

                if(allItems.length === 0) {
                    main.innerHTML = `
                        <div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;">
                            <h1 style="font-size:3rem;margin-bottom:1rem;">Bienvenido a NIRO</h1>
                            <p style="color:var(--color-text-secondary);max-width:500px;margin-bottom:2rem;">La plataforma está lista. Inicia sesión como administrador para comenzar a agregar contenido.</p>
                            ${!app.state.user ? `<button class="btn btn-primary" onclick="app.router('login')">Iniciar Sesión Admin</button>` : ''}
                        </div>
                    `;
                    return;
                }

                // --- Search View ---
                if(app.state.searchQuery) {
                    const q = app.state.searchQuery;
                    const results = allItems.filter(i => i.title.toLowerCase().includes(q) || i.genre?.toLowerCase().includes(q));
                    
                    main.innerHTML = `
                        <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto;">
                            <h2 style="margin-bottom:2rem;">Resultados para "${q}"</h2>
                            ${results.length === 0 ? '<p>No se encontraron resultados.</p>' : `
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:1.5rem;">
                                    ${results.map(item => `
                                        <div class="card" onclick="openDetails(${item.id})" style="flex:auto; aspect-ratio:2/3;">
                                            <img src="${item.img}" class="card-img" loading="lazy">
                                            <div style="position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(to top, black, transparent);">
                                                <h4 style="font-size:0.9rem;">${item.title}</h4>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    `;
                    return;
                }

                // --- Continue Watching View ---
                if(filterType === 'continue') {
                     if(!app.state.currentProfile) { app.router('profiles'); return; }
                     
                     const continueItems = (app.state.currentProfile.continueWatching || []).map(cw => {
                         const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                         if(!realItem) return null;
                         
                         let playParams = {};
                         if(cw.seriesId) {
                             if(realItem.seasons) {
                                for(const s of realItem.seasons) {
                                    const ep = s.episodes.find(e => e.id === cw.itemId);
                                    if(ep) {
                                        playParams = { video: ep.video, title: ep.title, itemId: ep.id, seriesId: realItem.id };
                                        break;
                                    }
                                }
                             }
                         } else {
                             playParams = { video: realItem.video, title: realItem.title, itemId: realItem.id, seriesId: null };
                         }
                         
                         if(!playParams.video) return null;
                         return { ...realItem, ...cw, playParams }; 
                     }).filter(i => i);

                     if(continueItems.length === 0) {
                        main.innerHTML = `
                            <div style="padding-top:150px;text-align:center;">
                                <i class="ri-time-line" style="font-size:4rem; color:var(--color-text-secondary); margin-bottom:1rem;"></i>
                                <h2>No tienes contenido pendiente.</h2>
                                <p style="color:var(--color-text-secondary);">Empieza a ver algo y aparecerá aquí.</p>
                            </div>
                        `;
                        return;
                     }

                     main.innerHTML = `
                        <div style="padding-top:120px; width:var(--container-width); max-width:var(--max-width); margin:0 auto;">
                            <h2 style="margin-bottom:2rem; display:flex; align-items:center; gap:10px;">
                                <i class="ri-time-line" style="color:var(--color-brand-primary);"></i> Continuar Viendo
                            </h2>
                            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:1.5rem;">
                                ${continueItems.map(item => `
                                    <div class="card" onclick="playItem(${item.id})" style="aspect-ratio:16/9;">
                                        <div style="position:relative; width:100%; height:100%;">
                                            <img src="${item.img}" class="card-img" style="object-fit:cover; width:100%; height:100%;" loading="lazy">
                                            <div style="position:absolute; inset:0; background:linear-gradient(to top, black, transparent 80%);"></div>
                                            
                                            <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.3);">
                                                <div style="height:100%;width:${(item.time/item.duration)*100}%;background:var(--color-brand-primary);"></div>
                                            </div>
                                            
                                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border:2px solid white; transition:transform 0.2s;" onmouseover="this.style.transform='translate(-50%,-50%) scale(1.1)'" onmouseout="this.style.transform='translate(-50%,-50%) scale(1)'">
                                                <i class="ri-play-fill" style="color:white;font-size:2rem;margin-left:4px;"></i>
                                            </div>

                                            <div style="position:absolute;bottom:10px;left:10px;right:10px;">
                                                <h4 style="font-size:1rem; text-shadow:0 2px 4px black;">${item.title}</h4>
                                                ${item.seriesId ? `<p style="font-size:0.8rem;color:#ccc; text-shadow:0 1px 2px black;">${item.playParams.title}</p>` : ''}
                                                <p style="font-size:0.7rem; color:var(--color-brand-primary); margin-top:2px;">Restante: ${Math.floor((item.duration - item.time)/60)} min</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                     `;
                     return;
                }

                // Filter items based on route & mood
                let displayItems = allItems;
                app.state.currentFilter = filterType; // Store for refresh

                if(filterType === 'mylist') {
                    if(!app.state.user) { app.router('login'); return; }
                    const list = app.state.user.myList || [];
                    displayItems = allItems.filter(i => list.includes(i.id));
                } else if(filterType) {
                    displayItems = allItems.filter(i => i.type === filterType);
                }
                
                if(app.state.currentMood) {
                    // Mock mood filtering logic mapping
                    const moodMap = {
                        'chill': ['Comedia', 'Documental', 'Romance'],
                        'intense': ['Acción', 'Terror', 'Suspenso'],
                        'magic': ['Fantasía', 'Ciencia Ficción', 'Aventura'],
                        'drama': ['Drama']
                    };
                    const allowedGenres = moodMap[app.state.currentMood] || [];
                    displayItems = displayItems.filter(i => allowedGenres.includes(i.genre));
                }

                if(displayItems.length === 0) {
                    main.innerHTML = `
                        <div style="padding-top:150px;text-align:center;">
                            <h2>No hay contenido en esta categoría/mood.</h2>
                            ${app.state.currentMood ? `<button class="btn btn-secondary" onclick="app.filterByMood(null)" style="margin-top:1rem;">Borrar Filtro de Mood</button>` : ''}
                        </div>
                    `;
                    return;
                }

                // Pick a hero (random or first from filtered)
                const heroItem = displayItems[Math.floor(Math.random() * displayItems.length)];
                const inList = app.state.user && app.state.user.myList && app.state.user.myList.includes(heroItem.id);
                
                let html = `
                    <div class="hero">
                        <div class="hero-aura" style="background-image: url('${heroItem.img}')"></div>
                        <div class="hero-bg" style="background-image: url('${heroItem.img}')">
                             ${heroItem.trailer ? `
                                <video id="hero-video" src="${heroItem.trailer}" autoplay muted loop playsinline style="width:100%; height:100%; object-fit:cover; opacity:0.6;"></video>
                                <button onclick="const v=document.getElementById('hero-video'); v.muted=!v.muted; this.innerHTML=v.muted?'<i class=\'ri-volume-mute-line\'></i>':'<i class=\'ri-volume-up-line\'></i>'" style="position:absolute; bottom:20px; right:20px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.3); border-radius:50%; width:40px; height:40px; color:white; cursor:pointer; z-index:20; display:flex; align-items:center; justify-content:center; transition:0.2s;" onmouseover="this.style.background='white'; this.style.color='black'" onmouseout="this.style.background='rgba(0,0,0,0.5)'; this.style.color='white'">
                                    <i class="ri-volume-mute-line"></i>
                                </button>
                             ` : ''}
                        </div>
                        <div class="hero-overlay"></div>
                        <div class="hero-content">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:1rem;">
                                <span style="background:rgba(255,255,255,0.2);backdrop-filter:blur(5px);padding:4px 10px;border-radius:4px;font-size:0.8rem;border:1px solid rgba(255,255,255,0.1);">DESTACADO</span>
                            </div>
                            
                            <h1 class="hero-title">${heroItem.title}</h1>
                            
                            <div class="hero-meta">
                                <span class="match-score">${heroItem.match || 98}% Match</span>
                                <span>${heroItem.year}</span>
                                <span style="border:1px solid rgba(255,255,255,0.3);padding:0 5px;border-radius:2px;">${heroItem.rating || '16+'}</span>
                                <span>${heroItem.duration ? Math.floor(heroItem.duration/60) + 'h ' + (heroItem.duration%60) + 'm' : '2h 15m'}</span>
                                ${heroItem.quality ? `<span style="border:1px solid rgba(255,255,255,0.3);padding:0 5px;border-radius:2px;font-size:0.7rem;">${heroItem.quality}</span>` : `<span style="border:1px solid rgba(255,255,255,0.3);padding:0 5px;border-radius:2px;font-size:0.7rem;">HD</span>`}
                            </div>
                            
                            <div class="hero-details" style="margin-bottom:1rem; font-size:0.9rem; color:#ccc; display:flex; flex-wrap:wrap; gap:15px; align-items:center;">
                                ${heroItem.genre ? `<div><span style="color:#777;">Géneros:</span> ${heroItem.genre.split(',').map(g => `<span class="meta-tag" onclick="event.stopPropagation(); app.setSearch('${g.trim()}')" style="color:white; cursor:pointer; text-decoration:underline; margin-right:3px;">${g.trim()}</span>`).join(', ')}</div>` : ''}
                                ${heroItem.cast ? `<div><span style="color:#777;">Elenco:</span> ${heroItem.cast.split(',').map(c => `<span class="meta-tag" onclick="event.stopPropagation(); app.setSearch('${c.trim()}')" style="color:white; cursor:pointer; text-decoration:underline; margin-right:3px;">${c.trim()}</span>`).join(', ')}</div>` : ''}
                                ${heroItem.director ? `<div><span style="color:#777;">Director:</span> <span class="meta-tag" onclick="event.stopPropagation(); app.setSearch('${heroItem.director.trim()}')" style="color:white; cursor:pointer; text-decoration:underline;">${heroItem.director}</span></div>` : ''}
                            </div>

                            <p class="hero-desc">${heroItem.desc}</p>
                            
                            <div class="hero-actions">
                                <button class="btn btn-primary" onclick="playItem(${heroItem.id})">
                                    <i class="ri-play-fill"></i> Reproducir
                                </button>
                                <button class="btn btn-secondary" onclick="openDetails(${heroItem.id})">
                                    <i class="ri-information-line"></i> Info
                                </button>
                                ${heroItem.trailer ? `
                                <button class="btn btn-secondary" onclick="app.playTrailer('${heroItem.trailer}')" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
                                    <i class="ri-movie-line"></i> Trailer
                                </button>
                                ` : ''}
                                ${app.state.user ? `
                                <button class="btn" onclick="app.toggleMyList(${heroItem.id}); const icon = this.querySelector('i'); if(icon.classList.contains('ri-add-line')){ icon.classList.replace('ri-add-line','ri-check-line'); } else { icon.classList.replace('ri-check-line','ri-add-line'); }" title="Mi Lista" style="width:48px; height:48px; border-radius:50%; border:1px solid rgba(255,255,255,0.3); background:rgba(0,0,0,0.3); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1.2rem; transition:0.2s;" onmouseover="this.style.background='white'; this.style.color='black'" onmouseout="this.style.background='rgba(0,0,0,0.3)'; this.style.color='white'">
                                    <i class="${inList ? 'ri-check-line' : 'ri-add-line'}"></i>
                                </button>
                                <button class="btn" onclick="app.shareItem(${heroItem.id})" title="Compartir" style="width:48px; height:48px; border-radius:50%; border:1px solid rgba(255,255,255,0.3); background:rgba(0,0,0,0.3); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1.2rem; transition:0.2s;" onmouseover="this.style.background='white'; this.style.color='black'" onmouseout="this.style.background='rgba(0,0,0,0.3)'; this.style.color='white'">
                                    <i class="ri-share-forward-line"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding-bottom:100px; margin-top:-50px; position:relative; z-index:10;">
                        <!-- Mood Section -->
                        <div class="mood-section">
                            <p style="color:var(--color-text-secondary); text-transform:uppercase; letter-spacing:2px; font-size:0.8rem;">¿Qué vibe tienes hoy?</p>
                            <div class="mood-grid">
                                <div class="mood-chip ${app.state.currentMood==='chill'?'active':''}" onclick="app.filterByMood('chill')">☕ Chill & Relax</div>
                                <div class="mood-chip ${app.state.currentMood==='intense'?'active':''}" onclick="app.filterByMood('intense')">🔥 Intensidad</div>
                                <div class="mood-chip ${app.state.currentMood==='magic'?'active':''}" onclick="app.filterByMood('magic')">✨ Magia & Sci-Fi</div>
                                <div class="mood-chip ${app.state.currentMood==='drama'?'active':''}" onclick="app.filterByMood('drama')">🎭 Drama Puro</div>
                            </div>
                        </div>
                `;

                // Categories logic
                let categories = [];
                
                // 1. Continue Watching
                if(!filterType && app.state.currentProfile && app.state.currentProfile.continueWatching && app.state.currentProfile.continueWatching.length > 0) {
                     const continueItems = app.state.currentProfile.continueWatching.map(cw => {
                         const realItem = allItems.find(i => i.id === (cw.seriesId || cw.itemId));
                         if(!realItem) return null;
                         
                         let playParams = {};
                         if(cw.seriesId) {
                             if(realItem.seasons) {
                                for(const s of realItem.seasons) {
                                    const ep = s.episodes.find(e => e.id === cw.itemId);
                                    if(ep) {
                                        playParams = { video: ep.video, title: ep.title, itemId: ep.id, seriesId: realItem.id };
                                        break;
                                    }
                                }
                             }
                         } else {
                             playParams = { video: realItem.video, title: realItem.title, itemId: realItem.id, seriesId: null };
                         }
                         if(!playParams.video) return null;
                         return { ...realItem, ...cw, playParams }; 
                     }).filter(i => i);

                     if(continueItems.length > 0) {
                        categories.push({
                            title: `Continuar viendo de ${app.state.currentProfile.name}`,
                            isContinueWatching: true,
                            items: continueItems
                        });
                     }
                }

                // 2. Because you watched [X] (Smart Recommendation)
                if(!filterType && app.state.currentProfile && app.state.currentProfile.continueWatching && app.state.currentProfile.continueWatching.length > 0) {
                    // Get most recent watched
                    const lastWatched = app.state.currentProfile.continueWatching.sort((a,b) => b.lastWatched - a.lastWatched)[0];
                    if(lastWatched) {
                        const lastItem = allItems.find(i => i.id === (lastWatched.seriesId || lastWatched.itemId));
                        if(lastItem && lastItem.genre) {
                            const mainGenre = lastItem.genre.split(',')[0].trim();
                            categories.push({
                                title: `Porque viste "${lastItem.title}"`,
                                filter: i => i.id !== lastItem.id && i.genre && i.genre.includes(mainGenre)
                            });
                        }
                    }
                }

                // 3. Trending Now (Simulated with high match score/recent year)
                if(!filterType) {
                    categories.push({
                        title: "Tendencias Ahora",
                        filter: i => i.year >= 2023 || (i.match && i.match > 95)
                    });
                }

                // 4. Friends are watching (Real Social Integration)
                if(!filterType && allUsers.length > 1) {
                    const friendActivity = {}; // itemId -> Set(names)
                    const currentUserEmail = app.state.user ? app.state.user.email : '';

                    allUsers.forEach(u => {
                        if (u.email === currentUserEmail) return; // Skip self
                        if (u.profiles) {
                            u.profiles.forEach(p => {
                                if (p.continueWatching) {
                                    p.continueWatching.forEach(cw => {
                                        const id = cw.seriesId || cw.itemId;
                                        if (!friendActivity[id]) friendActivity[id] = new Set();
                                        friendActivity[id].add(p.name);
                                    });
                                }
                            });
                        }
                    });

                    const socialItems = [];
                    Object.keys(friendActivity).forEach(k => {
                        const item = allItems.find(i => i.id == k);
                        if (item) {
                            // Clone item to avoid mutating original
                            const itemWithFriends = { ...item };
                            itemWithFriends.friendNames = Array.from(friendActivity[k]);
                            socialItems.push(itemWithFriends);
                        }
                    });

                    if (socialItems.length > 0) {
                        categories.push({
                            title: "Tus amigos están viendo",
                            isSocial: true,
                            items: socialItems
                        });
                    }
                }

                // 5. Top 10 Global (Simulated)
                if(!filterType) {
                     categories.push({
                        title: "Top 10 en Tu País",
                        isRanked: true,
                        filter: i => true, // We'll slice top 10 later
                        sort: (a,b) => (b.match || 0) - (a.match || 0)
                    });
                }

                // 6. Upcoming Releases (Real)
                if(!filterType) {
                     categories.push({
                        title: "Próximamente",
                        isUpcoming: true,
                        filter: i => i.isUpcoming === true,
                        sort: (a,b) => {
                            if(a.releaseDate && b.releaseDate) return new Date(a.releaseDate) - new Date(b.releaseDate);
                            return 0;
                        }
                    });
                }

                // 7. Award Winners
                if(!filterType) {
                    categories.push({
                        title: "Ganadores de Premios",
                        filter: i => i.awards && i.awards.length > 0
                    });
                }

                // 8. My List
                if(filterType !== 'mylist' && app.state.user && app.state.user.myList && app.state.user.myList.length > 0) {
                    categories.push({ 
                        title: "Mi Lista", 
                        filter: i => app.state.user.myList.includes(i.id) 
                    });
                }

                // Standard Categories
                if(!filterType || filterType === 'mylist') {
                    categories.push(
                        { title: "Nuevos Lanzamientos", filter: i => i.year >= 2024 },
                        { title: "Solo Películas", filter: i => i.type === 'movie' },
                        { title: "Series para maratonear", filter: i => i.type === 'series' },
                        { title: "Acción y Aventura", filter: i => i.genre && (i.genre.includes('Acción') || i.genre.includes('Aventura')) },
                        { title: "Comedia", filter: i => i.genre && i.genre.includes('Comedia') }
                    );
                } else {
                    categories.push(
                        { title: filterType === 'movie' ? "Películas Populares" : "Series Populares", filter: i => i.type === filterType },
                        { title: "Recientes", filter: i => i.type === filterType && i.year >= 2023 },
                        { title: "Acción", filter: i => i.type === filterType && i.genre && i.genre.includes('Acción') },
                        { title: "Drama", filter: i => i.type === filterType && i.genre && i.genre.includes('Drama') }
                    );
                }

                categories.forEach(cat => {
                    let items = [];
                    if(cat.isContinueWatching) {
                        items = cat.items || [];
                    } else {
                        // FIX: Safe filter execution
                        if (Array.isArray(allItems) && typeof cat.filter === 'function') {
                             try {
                                 items = allItems.filter(cat.filter);
                             } catch(err) {
                                 console.warn('Category filter failed for', cat.title, err);
                                 items = [];
                             }
                        }
                        
                        if(app.state.currentMood && items.length > 0) {
                             // Mood filtering (simplified for brevity)
                            const moodMap = {
                                'chill': ['Comedia', 'Documental', 'Romance', 'Animación'],
                                'intense': ['Acción', 'Terror', 'Suspenso', 'Crimen'],
                                'magic': ['Fantasía', 'Ciencia Ficción', 'Aventura'],
                                'drama': ['Drama', 'Misterio']
                            };
                            const allowedGenres = moodMap[app.state.currentMood] || [];
                            items = items.filter(i => allowedGenres.some(g => i.genre && i.genre.includes(g)));
                        }
                    }

                    if(cat.sort) items.sort(cat.sort);
                    if(cat.isRanked) items = items.slice(0, 10);
                    if(items.length === 0) return;
                    
                    // Shuffle standard categories slightly for variety if not ranked/sorted
                    if(!cat.isContinueWatching && !cat.isRanked && !cat.sort) {
                        items.sort(() => Math.random() - 0.5);
                    }

                    html += `
                        <section class="section">
                            <div class="section-header">
                                <h2 class="section-title">${cat.title}</h2>
                            </div>
                            <div class="slider-container">
                                <div class="slider-track" ${cat.isRanked ? 'style="gap:40px; padding-left:20px;"' : ''}>
                                    ${items.map((item, index) => {
                                        const onclick = cat.isContinueWatching 
                                            ? `playItem(${item.id})`
                                            : `openDetails(${item.id})`;
                                        
                                        const rankNumber = cat.isRanked ? `<div class="rank-number">${index + 1}</div>` : '';
                                        
                                        // Social Badge
                                        let socialBadge = '';
                                        if (cat.isSocial && item.friendNames && item.friendNames.length > 0) {
                                            const friend = item.friendNames[Math.floor(Math.random() * item.friendNames.length)];
                                            socialBadge = `
                                                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); padding:4px 8px; border-radius:20px; display:flex; align-items:center; gap:5px; font-size:0.7rem; border:1px solid rgba(255,255,255,0.2); z-index:5;">
                                                    <div style="width:16px; height:16px; background:#ddd; border-radius:50%;"></div>
                                                    <span>Visto por ${friend}</span>
                                                </div>
                                            `;
                                        }

                                        // Upcoming Badge
                                        let upcomingBadge = '';
                                        if (cat.isUpcoming) {
                                            upcomingBadge = `
                                                <div style="position:absolute; top:10px; left:10px; background:var(--color-brand-accent); color:white; padding:4px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold; z-index:5; box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                                                    PRÓXIMAMENTE
                                                </div>
                                            `;
                                        }

                                        // Card Template
                                        return `
                                        <div class="card ${cat.isRanked ? 'ranked-card' : ''}" 
                                             onclick="${onclick}" 
                                             onmouseenter="app.startCardPreview(this, '${item.trailer || ''}')" 
                                             onmouseleave="app.stopCardPreview(this)">
                                            
                                            ${rankNumber}
                                            ${socialBadge}
                                            ${upcomingBadge}
                                            
                                            <div class="card-media-wrapper" style="position:relative; width:100%; height:100%; overflow:hidden; border-radius:4px;">
                                                <img src="${item.img}" alt="${item.title}" class="card-img" loading="lazy">
                                                
                                                <div class="card-preview-container"></div>
                                                
                                                ${cat.isContinueWatching && item.duration ? `
                                                    <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.3); z-index:5;">
                                                        <div style="height:100%;width:${(item.time/item.duration)*100}%;background:var(--color-brand-primary);"></div>
                                                    </div>
                                                    <div class="play-icon-overlay">
                                                        <i class="ri-play-fill"></i>
                                                    </div>
                                                ` : ''}

                                                <!-- Hover Overlay with Quick Actions -->
                                                <div class="card-hover-overlay">
                                                    <div class="card-actions">
                                                        <button class="action-btn play-btn" onclick="event.stopPropagation(); playItem(${item.id})"><i class="ri-play-fill"></i></button>
                                                        <button class="action-btn" onclick="event.stopPropagation(); app.toggleMyList(${item.id})"><i class="ri-add-line"></i></button>
                                                        <button class="action-btn" onclick="event.stopPropagation(); openDetails(${item.id})"><i class="ri-arrow-down-s-line"></i></button>
                                                    </div>
                                                    <div class="card-info">
                                                        <h4 class="card-title">${item.title}</h4>
                                                        <div class="card-meta">
                                                            <span class="match">${item.match || 90}% Match</span>
                                                            <span class="age">${item.rating || '16+'}</span>
                                                            <span class="duration">${item.duration ? Math.floor(item.duration/60)+'h' : '2h'}</span>
                                                        </div>
                                                        <div class="card-genres">
                                                            ${item.genre ? item.genre.split(',').slice(0,3).join(' • ') : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </section>
                    `;
                });

                html += `</div>`; // Closed container
                main.innerHTML = html;
            },

            renderLogin: () => {
                document.getElementById('main-view').innerHTML = `
                    <div style="height:100vh;display:flex;align-items:center;justify-content:center;background: url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80') center/cover;">
                        <div style="position:absolute;inset:0;background:rgba(15,7,32,0.85);backdrop-filter:blur(5px);"></div>
                        
                        <div class="auth-card">
                            <h2 style="text-align:center;margin-bottom:0.5rem;font-size:2.2rem;font-family:var(--font-display);">NIRO</h2>
                            <p style="text-align:center;color:var(--color-text-secondary);margin-bottom:2rem;">Bienvenido de nuevo</p>
                            
                            <form onsubmit="event.preventDefault(); app.login(this.email.value, this.pass.value)">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" required placeholder="tu@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Contraseña</label>
                                    <input type="password" name="pass" required placeholder="******">
                                </div>
                                
                                <div style="text-align:center; margin-top:2rem;">
                                    <button class="btn btn-primary" style="padding:0.8rem 3rem; min-width:150px;">Entrar</button>
                                </div>
                            </form>
                            <div style="margin-top:2rem;text-align:center;font-size:0.9rem;color:var(--color-text-secondary);">
                                ¿No tienes cuenta? <a onclick="app.router('register')" style="color:var(--color-brand-primary);font-weight:600;cursor:pointer;">Regístrate</a>
                            </div>
                            <div id="install-area" style="margin-top:1.5rem;text-align:center;border-top:1px solid rgba(255,255,255,0.1);padding-top:1rem;"></div>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

            },

            renderRegister: () => {
                document.getElementById('main-view').innerHTML = `
                    <div style="height:100vh;display:flex;align-items:center;justify-content:center;background: url('https://images.unsplash.com/photo-1574375927938-d5a98e8efe30?q=80') center/cover;">
                        <div style="position:absolute;inset:0;background:rgba(15,7,32,0.85);backdrop-filter:blur(5px);"></div>
                        
                        <div class="auth-card">
                            <h2 style="text-align:center;margin-bottom:0.5rem;font-size:2rem;font-family:var(--font-display);">Crear Cuenta</h2>
                            <p style="text-align:center;color:var(--color-text-secondary);margin-bottom:2rem;">Únete a la experiencia</p>
                            
                            <form onsubmit="event.preventDefault(); app.register(this.name.value, this.email.value, this.pass.value)">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" name="name" required placeholder="Tu nombre">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" required placeholder="tu@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Contraseña</label>
                                    <input type="password" name="pass" required placeholder="******">
                                </div>
                                
                                <div style="text-align:center; margin-top:2rem;">
                                    <button class="btn btn-primary" style="padding:0.8rem 3rem; min-width:150px;">Crear Cuenta</button>
                                </div>
                            </form>
                            <div style="margin-top:2rem;text-align:center;font-size:0.9rem;color:var(--color-text-secondary);">
                                ¿Ya tienes cuenta? <a onclick="app.router('login')" style="color:var(--color-brand-primary);font-weight:600;cursor:pointer;">Inicia sesión</a>
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

            },

            renderProfile: async () => {
                const user = app.state.user;
                if(!user) { app.router('login'); return; }
                
                const profile = app.state.currentProfile;
                const nameToDisplay = profile ? profile.name : user.name;
                const avatarToDisplay = profile ? profile.avatar : (user.avatar || AVATARS[0]);

                // Get download stats
                const downloads = await DownloadManager.list();
                const totalSize = downloads.reduce((acc, curr) => acc + curr.size, 0);
                const sizeStr = (totalSize / (1024*1024)).toFixed(1) + ' MB';

                document.getElementById('main-view').innerHTML = `
                    <div style="padding-top:100px; width:var(--container-width); max-width:800px; margin:0 auto; padding-bottom: 80px;">
                        
                        <div style="display:flex; align-items:center; gap:2rem; margin-bottom:3rem; flex-wrap:wrap;">
                            <div style="position:relative; group:hover cursor:pointer;" onclick="${profile ? `app.editProfile(${profile.id})` : ''}">
                                <img src="${avatarToDisplay}" style="width:120px; height:120px; border-radius:12px; object-fit:cover; border:3px solid var(--color-brand-primary); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                                <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.2s; border-radius:12px; pointer-events:none;">
                                    <i class="ri-edit-line" style="font-size:2rem;"></i>
                                </div>
                            </div>
                            <div>
                                <h1 style="font-size:2.5rem; margin-bottom:0.5rem;">${nameToDisplay}</h1>
                                <div style="color:var(--color-text-secondary); font-size:1.1rem;">${user.email}</div>
                                <div style="margin-top:1rem; display:flex; gap:10px;">
                                    <span class="badge" style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:4px;">Miembro desde 2024</span>
                                    ${user.role === 'admin' ? '<span class="badge" style="background:var(--color-brand-primary); padding:5px 10px; border-radius:4px; color:black; font-weight:bold;">ADMIN</span>' : ''}
                                </div>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.5rem; margin-bottom:3rem;">
                            <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-list-check" style="font-size:2rem; color:var(--color-brand-primary); margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${user.myList?.length || 0}</div>
                                <div style="color:var(--color-text-secondary);">En Mi Lista</div>
                            </div>
                            <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-download-cloud-line" style="font-size:2rem; color:#60a5fa; margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${downloads.length}</div>
                                <div style="color:var(--color-text-secondary);">Descargas (${sizeStr})</div>
                            </div>
                             <div class="stat-card" style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <i class="ri-time-line" style="font-size:2rem; color:#f472b6; margin-bottom:1rem; display:block;"></i>
                                <div style="font-size:2rem; font-weight:bold;">${profile?.continueWatching?.length || 0}</div>
                                <div style="color:var(--color-text-secondary);">Viendo</div>
                            </div>
                        </div>

                        <div style="background:var(--color-bg-surface); padding:2rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin-bottom:1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem;">Configuración</h3>
                            <form onsubmit="event.preventDefault(); app.updateProfile(this)">
                                <div class="form-group">
                                    <label>Nombre de Usuario</label>
                                    <input type="text" name="name" value="${user.name}" required style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:10px; width:100%; color:white; border-radius:4px;">
                                </div>
                                <div class="form-group" style="margin-top:1rem;">
                                    <label>Cambiar Contraseña</label>
                                    <input type="password" name="password" placeholder="Nueva contraseña (opcional)" style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:10px; width:100%; color:white; border-radius:4px;">
                                </div>
                                <div style="margin-top:2rem; text-align:right;">
                                    <button class="btn btn-primary">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>

                        <div style="margin-top:2rem; text-align:center;">
                            <button onclick="app.logout()" style="background:none; border:1px solid #ef4444; color:#ef4444; padding:10px 20px; border-radius:4px; cursor:pointer; transition:0.2s;">
                                <i class="ri-logout-box-line"></i> Cerrar Sesión
                            </button>
                        </div>
                    </div>
                `;
                setTimeout(() => app.renderInstallArea(), 100);

            },
            
            updateProfile: async (form) => {
                const name = form.name.value;
                const password = form.password.value;
                
                const user = app.state.user;
                const userIdx = allUsers.findIndex(u => u.email === user.email);
                
                if(userIdx === -1) return;
                
                allUsers[userIdx].name = name;
                if(password) allUsers[userIdx].password = password;
                
                const success = await app.saveDB({ users: allUsers });
                if(success) {
                    app.state.user = allUsers[userIdx];
                    localStorage.setItem('niro_user', JSON.stringify(app.state.user));
                    app.renderHeader();
                    app.showToast("Perfil actualizado correctamente");
                }
            },

            /* --- Admin Panel --- */
            renderAdmin: () => {
                // Security Check
                if (!app.state.user || app.state.user.role !== 'admin') {
                    app.router('home');
                    app.showToast("Acceso denegado", "error");
                    return;
                }

                const main = document.getElementById('main-view');
                const tab = app.state.adminTab;
                
                // Calculate Stats
                const totalContent = allItems.length;
                const totalMovies = allItems.filter(i => i.type === 'movie').length;
                const totalSeries = allItems.filter(i => i.type === 'series').length;
                const totalUsers = allUsers.length;
                const pendingUsers = allUsers.filter(u => u.status === 'pending').length;

                let content = `
                    <div class="admin-container">
                        <div class="admin-header">
                            <h1 style="font-size:2rem;">Panel de Administración</h1>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="openAddContentModal()">
                                    <i class="ri-add-line"></i> Contenido
                                </button>
                                <button class="btn btn-primary" onclick="openAddUserModal()">
                                    <i class="ri-user-add-line"></i> Usuario
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-tabs">
                            <div class="admin-tab ${tab==='dashboard'?'active':''}" onclick="app.state.adminTab='dashboard';app.renderAdmin()">Dashboard</div>
                            <div class="admin-tab ${tab==='content'?'active':''}" onclick="app.state.adminTab='content';app.renderAdmin()">Contenido</div>
                            <div class="admin-tab ${tab==='users'?'active':''}" onclick="app.state.adminTab='users';app.renderAdmin()">Usuarios</div>
                            <div class="admin-tab ${tab==='notifications'?'active':''}" onclick="app.state.adminTab='notifications';app.renderAdmin()">Notificaciones</div>
                            <div class="admin-tab ${tab==='requests'?'active':''}" onclick="app.state.adminTab='requests';app.renderAdmin()">Solicitudes ${pendingUsers > 0 ? `<span style="background:red;padding:0 6px;border-radius:10px;font-size:0.7rem;margin-left:5px;">${pendingUsers}</span>` : ''}</div>
                        </div>
                `;

                if (tab === 'dashboard') {
                    content += `
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.5rem; margin-bottom:2rem;">
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Total Contenido</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:white;">${totalContent}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Películas</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:var(--color-brand-accent);">${totalMovies}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Series</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:var(--color-brand-primary);">${totalSeries}</div>
                            </div>
                            <div style="background:var(--color-bg-surface); padding:1.5rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                                <h3 style="color:var(--color-text-secondary); font-size:0.9rem; margin-bottom:0.5rem;">Usuarios</h3>
                                <div style="font-size:2.5rem; font-weight:800; color:white;">${totalUsers}</div>
                            </div>
                        </div>
                        
                        <div style="background:var(--color-bg-surface); padding:2rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin-bottom:1rem;">Acciones Rápidas</h3>
                            <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                                <button class="btn btn-secondary" onclick="app.state.adminTab='content';app.renderAdmin()">Gestionar Contenido</button>
                                <button class="btn btn-secondary" onclick="app.state.adminTab='users';app.renderAdmin()">Gestionar Usuarios</button>
                                <button class="btn btn-secondary" onclick="openAddContentModal()">Subir Nuevo</button>
                            </div>
                        </div>
                    `;
                } else if(tab === 'content') {
                    content += `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Título</th>
                                    <th>Tipo</th>
                                    <th>Año</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allItems.map(item => `
                                    <tr>
                                        <td><img src="${item.img}" style="width:40px;height:60px;object-fit:cover;border-radius:4px;"></td>
                                        <td>${item.title}</td>
                                        <td><span style="background:${item.type==='series'?'var(--color-brand-primary)':'#2563eb'};padding:2px 8px;border-radius:4px;font-size:0.75rem;">${item.type==='series'?'Serie':'Película'}</span></td>
                                        <td>${item.year}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="openEditContentModal(${item.id})">Editar</button>
                                            ${item.type==='series' ? `<button class="btn btn-secondary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="manageEpisodes(${item.id})">Episodios</button>` : ''}
                                            <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="deleteItem(${item.id})">Eliminar</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${allItems.length===0 ? '<tr><td colspan="5" style="text-align:center;padding:2rem;">No hay contenido aún</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'users') {
                    const activeUsers = allUsers.filter(u => u.status !== 'pending');
                    content += `
                        <table class="data-table">
                            <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody>
                                ${activeUsers.map(u => `
                                    <tr style="${u.banned ? 'opacity:0.6; background:rgba(255,0,0,0.1);' : ''}">
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>${u.role}</td>
                                        <td>
                                            ${u.banned ? '<span style="color:red; font-weight:bold;">BANEADO</span>' : (u.status || 'Activo')}
                                        </td>
                                        <td>
                                            ${u.email !== 'admin@niro.com' ? `
                                                <button class="btn btn-${u.banned ? 'primary' : 'warning'}" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="toggleBanUser('${u.email}')">${u.banned ? 'Desbanear' : 'Banear'}</button>
                                                <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="deleteUser('${u.email}')">Eliminar</button>
                                            ` : '<span style="opacity:0.5;font-size:0.8rem">Sistema</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (tab === 'notifications') {
                    content += `
                        <div style="background:var(--color-bg-surface); padding:2rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin-bottom:1.5rem;">Enviar Notificación Global</h3>
                            <form onsubmit="handleSendNotification(event)">
                                <div class="form-group" style="margin-bottom:1rem;">
                                    <label>Título</label>
                                    <input type="text" name="title" required placeholder="Ej: Nuevo estreno..." style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:4px;">
                                </div>
                                <div class="form-group" style="margin-bottom:1rem;">
                                    <label>Mensaje</label>
                                    <textarea name="message" required placeholder="Escribe el mensaje aquí..." style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:4px; min-height:100px;"></textarea>
                                </div>
                                <button class="btn btn-primary">Enviar a Todos</button>
                            </form>
                        </div>
                    `;
                } else if (tab === 'requests') {
                    const pendingUsers = allUsers.filter(u => u.status === 'pending');
                    content += `
                        <h3 style="margin-bottom:1rem;">Solicitudes de Registro</h3>
                        <table class="data-table">
                            <thead><tr><th>Nombre</th><th>Email</th><th>Acciones</th></tr></thead>
                            <tbody>
                                ${pendingUsers.map(u => `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding:4px 10px;font-size:0.8rem;margin-right:5px;" onclick="approveUser('${u.email}', true)">Aceptar</button>
                                            <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem;" onclick="approveUser('${u.email}', false)">Denegar</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${pendingUsers.length===0 ? '<tr><td colspan="3" style="text-align:center;padding:2rem;">No hay solicitudes pendientes</td></tr>' : ''}
                            </tbody>
                        </table>
                    `;
                }

                content += `</div>`;
                main.innerHTML = content;
            }
        };

        /* -------------------------------------------------------------------------- */
        /*                               HELPER FUNCTIONS                             */
        
        // --- Admin Helpers ---
        async function toggleBanUser(email) {
            const user = allUsers.find(u => u.email === email);
            if(!user) return;
            
            user.banned = !user.banned;
            await app.saveDB({ users: allUsers });
            app.renderAdmin();
            app.showToast(user.banned ? "Usuario baneado" : "Usuario desbaneado");
        }

        async function deleteUser(email) {
             app.confirmAction(`¿Eliminar al usuario ${email}?`, async () => {
                const idx = allUsers.findIndex(u => u.email === email);
                if(idx > -1) {
                    allUsers.splice(idx, 1);
                    await app.saveDB({ users: allUsers });
                    app.renderAdmin();
                    app.showToast("Usuario eliminado");
                }
            });
        }

        async function approveUser(email, approve) {
            const user = allUsers.find(u => u.email === email);
            if(!user) return;
            
            if(approve) {
                user.status = 'active';
                // Assign a default role if needed, e.g., 'user'
                if(!user.role) user.role = 'user';
                await app.saveDB({ users: allUsers });
                app.showToast("Usuario aprobado");
            } else {
                allUsers = allUsers.filter(u => u.email !== email);
                await app.saveDB({ users: allUsers });
                app.showToast("Solicitud denegada y usuario eliminado");
            }
            app.renderAdmin();
        }

        async function handleSendNotification(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const message = form.message.value;
            
            if(!title || !message) return;
            
            const newNotif = {
                id: Date.now(),
                title,
                message,
                date: new Date().toISOString(),
                read: false,
                type: 'system' // global notification
            };
            
            // Add to all users
            allUsers.forEach(u => {
                if(!u.notifications) u.notifications = [];
                u.notifications.unshift({...newNotif});
            });
            
            await app.saveDB({ users: allUsers });
            app.showToast("Notificación enviada a todos los usuarios");
            form.reset();
        }

        // --- Series Management (Enhanced) ---
        function manageEpisodes(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            if(!item) return;

            openModal(`
                <div style="padding:2rem; width:100%;">
                    <h2>Gestionar: ${item.title}</h2>
                    <div style="margin:1rem 0; max-height:400px; overflow-y:auto;">
                        ${item.seasons.length === 0 ? '<p>No hay temporadas.</p>' : ''}
                        ${item.seasons.map((s, sIdx) => `
                            <div style="background:rgba(255,255,255,0.05); padding:1rem; margin-bottom:1rem; border-radius:8px;">
                                <h4 style="color:var(--color-brand-primary); margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                                    ${s.name}
                                    <button onclick="deleteSeason(${seriesId}, ${sIdx})" style="color:#ef4444; font-size:0.9rem; background:none; border:none; cursor:pointer;" title="Eliminar Temporada"><i class="ri-delete-bin-line"></i></button>
                                </h4>
                                <div style="margin-left:1rem;">
                                    ${s.episodes.map(ep => `
                                        <div style="font-size:0.9rem; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                                            <div style="display:flex; align-items:center; gap:10px;">
                                                <img src="${ep.img || item.img}" style="width:50px; height:30px; object-fit:cover; border-radius:2px; opacity:0.7;">
                                                <span>${ep.title}</span>
                                            </div>
                                            <button onclick="deleteEpisode(${seriesId}, ${sIdx}, ${ep.id})" style="color:#ef4444; font-size:1rem; background:none; border:none; cursor:pointer;" title="Eliminar Episodio"><i class="ri-close-circle-line"></i></button>
                                        </div>
                                    `).join('')}
                                    <button class="btn btn-secondary" style="margin-top:10px; font-size:0.8rem;" onclick="addEpisode(${seriesId}, ${sIdx})">+ Añadir Episodio</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="addSeason(${seriesId})">Nueva Temporada</button>
                </div>
            `);
        }

        async function deleteSeason(seriesId, seasonIdx) {
            app.confirmAction("¿Eliminar esta temporada y todos sus episodios? Esta acción no se puede deshacer.", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                
                if(season.episodes) {
                    for(const ep of season.episodes) {
                        try {
                            if(await DownloadManager.has(ep.id)) await DownloadManager.remove(ep.id);
                        } catch(e) {}

                        if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                        if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    }
                }
                
                item.seasons.splice(seasonIdx, 1);
                await app.saveDB({ items: allItems });
                manageEpisodes(seriesId);
                app.showToast("Temporada eliminada");
            });
        }

        async function deleteEpisode(seriesId, seasonIdx, episodeId) {
            app.confirmAction("¿Eliminar este episodio?", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                const ep = season.episodes.find(e => e.id === episodeId);
                
                if(ep) {
                    try {
                        if(await DownloadManager.has(episodeId)) await DownloadManager.remove(episodeId);
                    } catch(e) {}

                    if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                    if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    
                    season.episodes = season.episodes.filter(e => e.id !== episodeId);
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId);
                    app.showToast("Episodio eliminado");
                }
            });
        }

        async function addSeason(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            const nextSeasonNum = item.seasons.length + 1;
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Nueva Temporada</h3>
                    <div style="margin-bottom:1rem;">
                        <label>Nombre de la Temporada</label>
                        <input id="new-season-name" value="Temporada ${nextSeasonNum}" required>
                    </div>
                    <button class="btn btn-primary" onclick="handleCreateSeason(${seriesId})">Crear Temporada</button>
                </div>
            `);
        }

        async function handleCreateSeason(seriesId) {
            const name = document.getElementById('new-season-name').value;
            if(!name) return app.showToast("El nombre es obligatorio", "error");
            
            const item = allItems.find(i => i.id === seriesId);
            item.seasons.push({ id: Date.now(), name, episodes: [] });
            
            await app.saveDB({ items: allItems });
            app.showToast("Temporada creada");
            manageEpisodes(seriesId); 
        }

        async function addEpisode(seriesId, seasonIdx) {
            const item = allItems.find(i => i.id === seriesId);
            const season = item.seasons[seasonIdx];
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Añadir Episodio a ${season.name}</h3>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="ep-title" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="ep-desc" rows="2"></textarea></div>
                    <div style="margin-bottom:1rem;">
                        <label>Imagen del Episodio (Thumbnail)</label>
                        <input type="file" id="ep-img" accept="image/*">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Video del Episodio</label>
                        <input type="file" id="ep-video" accept="video/*">
                    </div>
                    <button class="btn btn-primary" id="btn-ep-upload" onclick="handleEpUpload(${seriesId}, ${seasonIdx})">Subir Episodio</button>
                    <div id="ep-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="manageEpisodes(${seriesId})">Cancelar</button>
                </div>
            `);
        }

        async function handleEpUpload(seriesId, seasonIdx) {
            const btn = document.getElementById('btn-ep-upload');
            const status = document.getElementById('ep-status');
            const title = document.getElementById('ep-title').value;
            const desc = document.getElementById('ep-desc').value;
            const vidFile = document.getElementById('ep-video').files[0];
            const imgFile = document.getElementById('ep-img').files[0];
            
            if(!title || !vidFile) return app.showToast("Faltan datos (título y video son obligatorios)", "error");

            btn.disabled = true;
            status.innerHTML = 'Subiendo video: <span id="ep-upload-pct">0%</span><div style="width:100%; height:4px; background:#333; margin-top:5px; border-radius:2px;"><div id="ep-upload-bar" style="width:0%; height:100%; background:var(--color-brand-primary); transition:width 0.2s;"></div></div>';

            try {
                // Upload Image
                let imgUrl = "";
                if(imgFile) {
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) imgUrl = data.url;
                }

                // Upload Video (Chunked)
                const data = await uploadChunkedFile(vidFile, (pct) => {
                    const p = Math.floor(pct);
                    const pctEl = document.getElementById('ep-upload-pct');
                    const barEl = document.getElementById('ep-upload-bar');
                    if(pctEl) pctEl.innerText = p + '%';
                    if(barEl) barEl.style.width = p + '%';
                    if(p >= 100) status.innerHTML = "Procesando video... <i class='ri-loader-4-line spin'></i>";
                });
                
                if(data.url) {
                    const item = allItems.find(i => i.id === seriesId);
                    item.seasons[seasonIdx].episodes.push({
                        id: Date.now(),
                        title,
                        desc,
                        img: imgUrl,
                        video: data.url
                    });
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId); // Go back to list
                } else {
                    throw new Error("Upload failed");
                }
            } catch(e) {
                console.error(e);
                app.showToast("Error subiendo episodio", "error");
                btn.disabled = false;
                status.innerText = "";
            }
        }

        function openMobileProfileMenu() {
            if(!app.state.user) {
                app.router('login');
                return;
            }
            
            const p = app.state.currentProfile;
            const u = app.state.user;
            
            openModal(`
                <div style="padding: 1rem; text-align: center;">
                    <div style="margin-bottom: 1.5rem;">
                        <img src="${p ? p.avatar : (u.avatar||'')}" style="width:80px;height:80px;border-radius:8px;margin-bottom:10px;object-fit:cover;">
                        <h3 style="margin:0;">${p ? p.name : u.name}</h3>
                        <p style="color:#aaa;font-size:0.9rem;margin:0;">${u.email}</p>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <button class="btn btn-secondary" onclick="closeModal(); app.router('account')" style="width:100%;justify-content:start;padding:15px;"><i class="ri-settings-3-line" style="margin-right:10px;"></i> Cuenta</button>
                        <button class="btn btn-secondary" onclick="closeModal(); app.router('profiles')" style="width:100%;justify-content:start;padding:15px;"><i class="ri-user-settings-line" style="margin-right:10px;"></i> Cambiar Perfil</button>
                        <button class="btn btn-secondary" onclick="closeModal(); openStatusPage()" style="width:100%;justify-content:start;padding:15px;"><i class="ri-server-line" style="margin-right:10px;"></i> Estado del Sistema</button>
                        <button class="btn btn-danger" onclick="closeModal(); app.logout()" style="width:100%;justify-content:start;padding:15px;margin-top:10px;"><i class="ri-logout-box-line" style="margin-right:10px;"></i> Cerrar Sesión</button>
                    </div>
                </div>
            `);
        }
        
        // Update avatar in mobile nav when profile changes
        // We can hook this into app.router or app.selectProfile
        // Or just update it in renderHeader (which is called often)

        /* -------------------------------------------------------------------------- */
        
        // --- Modals ---
        function openModal(html) {
            const m = document.getElementById('generic-modal');
            const c = document.getElementById('generic-modal-content');
            c.innerHTML = `<div class="modal-close" onclick="closeModal()"><i class="ri-close-line"></i></div>` + html;
            m.style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('generic-modal').style.display = 'none';
        }

        // --- Content Details ---
        async function openDetails(id) {
            const item = allItems.find(i => i.id === id);
            if(!item) return;
            
            const user = app.state.user;
            const inList = user && user.myList && user.myList.includes(id);
            const isDownloaded = await DownloadManager.has(id);
            
            // Get all downloads to check episodes efficiently
            const allDownloads = await DownloadManager.list();
            const downloadIds = new Set(allDownloads.map(d => d.id));

            let html = `
                <div style="display:flex; flex-direction:column;">
                    <div style="height:350px; background:url('${item.img}') center/cover; position:relative;">
                        <div style="position:absolute;inset:0;background:linear-gradient(to top, var(--color-bg-surface), transparent);"></div>
                        <div style="position:absolute;bottom:20px;left:20px;right:20px;">
                            <h2 style="font-size:2.5rem; line-height:1; margin-bottom:10px; text-shadow:0 2px 10px rgba(0,0,0,0.8);">${item.title}</h2>
                            <div style="display:flex;gap:10px;">
                                <button class="btn ${item.isUpcoming ? 'btn-secondary' : 'btn-primary'}" onclick="playItem(${item.id})" ${item.isUpcoming && !item.trailer ? 'disabled' : ''}>
                                    <i class="${item.isUpcoming ? (item.trailer ? 'ri-movie-line' : 'ri-calendar-event-line') : 'ri-play-fill'}"></i> 
                                    ${item.isUpcoming ? (item.trailer ? 'Ver Trailer' : (item.releaseDate ? 'Estreno: '+item.releaseDate : 'Próximamente')) : 'Reproducir'}
                                </button>
                                
                                ${item.trailer && !item.isUpcoming ? `
                                    <button class="btn btn-secondary" onclick="app.playTrailer('${item.trailer}')">
                                        <i class="ri-movie-line"></i> Trailer
                                    </button>
                                ` : ''}

                                ${user ? `
                                    <button id="btn-mylist-${item.id}" class="btn ${inList ? 'btn-primary' : 'btn-secondary'}" onclick="app.toggleMyList(${item.id})">
                                        <i class="${inList ? 'ri-check-line' : 'ri-add-line'}"></i> ${inList ? 'En mi lista' : 'Mi Lista'
                                    }
                                    </button>
                                ` : ''}
                                ${(user && ((item.type === 'movie' && item.video) || item.type === 'series')) ? `
                                    <button id="btn-download-${item.id}" class="btn ${isDownloaded ? 'btn-primary' : 'btn-secondary'}" onclick="app.downloadItem(${item.id})">
                                        <i class="${isDownloaded ? 'ri-delete-bin-line' : 'ri-download-line'}"></i> ${isDownloaded ? 'Borrar Descarga' : 'Descargar'}
                                    </button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="app.shareItem(${item.id})">
                                    <i class="ri-share-forward-line"></i> Compartir
                                </button>
                            </div>
                        </div>
                    </div>
                    <div style="padding:2rem;">
                        <p style="margin-bottom:1rem;color:#ddd;line-height:1.6;">${item.desc}</p>
                        
                        <div style="margin-bottom:2rem; font-size:0.9rem; color:#ccc; display:flex; flex-direction:column; gap:10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="color:#46d369; font-weight:bold; font-size:1.1rem;">${item.match}% Match</span>
                                <span style="color:white;">${item.year}</span>
                                <span style="border:1px solid rgba(255,255,255,0.3); padding:0 5px; border-radius:2px; font-size:0.8rem;">${item.rating || '16+'}</span>
                                <span style="border:1px solid rgba(255,255,255,0.3); padding:0 5px; border-radius:2px; font-size:0.8rem;">HD</span>
                            </div>
                            
                            ${item.genre ? `<div><span style="color:#777;">Géneros:</span> ${item.genre.split(',').map(g => `<span class="meta-tag" onclick="closeModal(); app.setSearch('${g.trim()}')" style="color:white; cursor:pointer; text-decoration:underline; margin-right:3px;">${g.trim()}</span>`).join(', ')}</div>` : ''}
                            ${item.cast ? `<div><span style="color:#777;">Elenco:</span> ${item.cast.split(',').map(c => `<span class="meta-tag" onclick="closeModal(); app.setSearch('${c.trim()}')" style="color:white; cursor:pointer; text-decoration:underline; margin-right:3px;">${c.trim()}</span>`).join(', ')}</div>` : ''}
                            ${item.director ? `<div><span style="color:#777;">Director:</span> <span class="meta-tag" onclick="closeModal(); app.setSearch('${item.director.trim()}')" style="color:white; cursor:pointer; text-decoration:underline;">${item.director}</span></div>` : ''}
                        </div>
            `;

            if(item.type === 'series' && item.seasons) {
                // Season Selector - Custom Dropdown
                html += `
                    <div class="season-selector-container" style="margin-bottom:1.5rem; position:relative; width:fit-content; min-width:200px;">
                        <button onclick="toggleSeasonDropdown()" id="season-dropdown-btn" 
                            style="display:flex; align-items:center; gap:10px; background:transparent; border:1px solid rgba(255,255,255,0.3); padding:8px 15px; border-radius:4px; font-weight:600; font-size:1.1rem; cursor:pointer; color:white;">
                            <span id="current-season-name">${item.seasons[0].name}</span>
                            <i class="ri-arrow-down-s-fill" style="font-size:0.8em;"></i>
                        </button>
                        
                        <div id="season-dropdown-list" style="display:none; position:absolute; top:110%; left:0; min-width:100%; background:var(--color-bg-surface); border:1px solid rgba(255,255,255,0.1); border-radius:4px; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                            ${item.seasons.map((s, idx) => `
                                <div onclick="switchSeason(${idx}, '${s.name}')" class="season-option" style="padding:10px 15px; cursor:pointer; white-space:nowrap; transition:background 0.2s; border-bottom:1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    ${s.name} (${s.episodes.length} episodios)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="episodes-container">
                        ${item.seasons.map((s, sIdx) => `
                            <div id="season-content-${sIdx}" style="display:${sIdx===0?'block':'none'};">
                                ${s.episodes.length === 0 ? '<div style="padding:20px; color:#666;">No hay episodios disponibles.</div>' : ''}
                                ${s.episodes.map((ep, eIdx) => {
                                    const isEpDownloaded = downloadIds.has(ep.id);
                                    return `
                                    <div class="episode-row" onclick="playVideo('${ep.video}', '${ep.title}', ${ep.id}, ${item.id})" style="display:flex; gap:15px; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; align-items:center; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="font-size:1.2rem; color:#666; width:30px; text-align:center;">${eIdx+1}</div>
                                        <div style="width:130px; height:74px; background:url('${ep.img || item.img}') center/cover; border-radius:4px; flex-shrink:0; position:relative;">
                                            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3);">
                                                <i class="ri-play-circle-line" style="font-size:2rem; color:white;"></i>
                                            </div>
                                            ${(() => {
                                                const p = app.state.currentProfile;
                                                if(p && p.continueWatching) {
                                                    const cw = p.continueWatching.find(i => i.itemId === ep.id);
                                                    if(cw) {
                                                        return `<div style="position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,0.3);"><div style="height:100%;width:${(cw.time/cw.duration)*100}%;background:var(--color-brand-primary);"></div></div>`;
                                                    }
                                                }
                                                return '';
                                            })()}
                                        </div>
                                        <div style="flex:1;">
                                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                                <span style="font-weight:bold; font-size:1rem;">${ep.title}</span>
                                                <span style="font-size:0.8rem; color:#aaa;">${Math.floor(Math.random() * 20 + 20)} min</span>
                                            </div>
                                            <div style="font-size:0.85rem; color:#aaa; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.4;">${ep.desc || 'Sin descripción disponible para este episodio.'}</div>
                                        </div>
                                        <div style="margin-left:10px;">
                                            <button id="btn-download-${ep.id}" 
                                                class="btn btn-icon ${isEpDownloaded ? 'btn-primary' : 'btn-secondary'}" 
                                                style="width:40px; height:40px; border-radius:50%; padding:0; display:flex; align-items:center; justify-content:center;"
                                                onclick="event.stopPropagation(); app.downloadItem(${ep.id}, ${item.id})">
                                                <i class="${isEpDownloaded ? 'ri-delete-bin-line' : 'ri-download-line'}"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += `</div></div>`;
            openModal(html);
        }

        function toggleSeasonDropdown() {
            const list = document.getElementById('season-dropdown-list');
            if(list) list.style.display = list.style.display === 'none' ? 'block' : 'none';
        }

        function switchSeason(idx, name) {
            if(name) document.getElementById('current-season-name').innerText = name;
            document.querySelectorAll('[id^="season-content-"]').forEach(el => el.style.display = 'none');
            const target = document.getElementById('season-content-'+idx);
            if(target) target.style.display = 'block';
            toggleSeasonDropdown();
        }

        // --- Playback ---
        async function playItem(id) {
            if(!app.state.user) return app.showToast("Debes iniciar sesión para ver contenido.", "error");
            if(!app.state.currentProfile) return app.router('profiles');
            
            const item = allItems.find(i => i.id === id);

            // Check if it's a direct download item (offline object)
            // The item object from downloads list might be different than allItems
            // But here we are passing ID.
            
            // Try to find in downloads first if item is not in allItems (offline mode)
            let offlineItem = null;
            if (!item) {
                const downloads = await DownloadManager.list();
                offlineItem = downloads.find(d => d.id === id);
                if (offlineItem) {
                     // It's a downloaded item (movie or episode)
                     const blobUrl = await DownloadManager.get(id);
                     if (blobUrl) {
                         playVideo(blobUrl, offlineItem.title, offlineItem.id, offlineItem.parentId, offlineItem.poster);
                         return;
                     }
                }
            }

            if (!item && !offlineItem) return; // Not found anywhere

            // Offline check for online items
            if (!navigator.onLine) {
                 const offlineUrl = await DownloadManager.get(id);
                 if (offlineUrl) {
                     // Determine title/poster from item if available, or fetch from meta
                     const meta = await DownloadManager.list();
                     const metaItem = meta.find(m => m.id === id);
                     playVideo(offlineUrl, metaItem ? metaItem.title : item.title, id, item.type==='series'?id:null, item.img);
                     return;
                 } else {
                     return app.showToast("Este contenido no está disponible sin conexión.", "error");
                 }
            }
            
            // Upcoming Check
            if(item.isUpcoming) {
                if(item.trailer) {
                    app.playTrailer(item.trailer);
                    return;
                }
                return app.showToast(`Estreno: ${item.releaseDate || 'Próximamente'}`, "info");
            }
            
            if(item.type === 'movie') {
                if(!item.video) return app.showToast("Película aún no disponible.", "error");
                // Check if downloaded to play offline version even if online?
                // Prefer online for quality? Or offline to save bandwidth?
                // Let's check if downloaded exists to save bandwidth
                if (await DownloadManager.has(id)) {
                     const blobUrl = await DownloadManager.get(id);
                     if(blobUrl) {
                         playVideo(blobUrl, item.title, item.id, null, item.img);
                         return;
                     }
                }

                playVideo(item.video, item.title, item.id, null, item.img);
            } else if (item.type === 'series') {
                // ... (series logic remains same for continue watching) ...
                
                // But check if we are trying to play a downloaded EPISODE directly?
                // Usually playItem(id) is called on the SERIES ID, not episode ID.
                // But from Downloads view, it calls playItem(downloadId) which IS the episode ID.
                
                // If item found in allItems is a SERIES, then we do the Continue Watching logic.
                // If the ID passed was actually an EPISODE ID (which won't be in allItems as a top level item),
                // we need to handle that.
                
                // NOTE: allItems contains ONLY top level movies and series.
                // Episodes are nested.
                // So if playItem(id) is called with an episode ID, item will be undefined above!
                
                // So the "offlineItem" check at the top handles the case where we pass an episode ID that is downloaded.
                
                // Logic for Series Parent Object
                const profile = app.state.currentProfile;
                let lastEpisode = null;

                if (profile.continueWatching) {
                    // ... (existing continue watching logic) ...
                    // Find the most recently watched episode for this series
                    // We need to iterate through all continueWatching items and check if they belong to this series
                    // However, current continueWatching structure only has itemId. 
                    // If itemId matches an episode ID of this series.
                    
                    // Let's first flatten all episodes to find their IDs
                    const allSeriesEpisodeIds = [];
                    if(item.seasons) {
                        item.seasons.forEach(s => {
                            if(s.episodes) {
                                s.episodes.forEach(ep => allSeriesEpisodeIds.push(ep));
                            }
                        });
                    }

                    // Find the last watched episode from this series
                    // We assume continueWatching is ordered or we take the one with most progress?
                    // Usually continueWatching is a list. Let's find the one matching any episode of this series.
                    
                    const watched = profile.continueWatching.filter(w => allSeriesEpisodeIds.find(ep => ep.id === w.itemId));
                    if (watched.length > 0) {
                        // Sort by lastUpdated if available, or just take the first one found (assuming latest pushed)
                        // For now, let's take the first one found.
                        const lastWatched = watched[0]; 
                        lastEpisode = allSeriesEpisodeIds.find(ep => ep.id === lastWatched.itemId);
                    }
                }

                if (lastEpisode) {
                    // Show menu: Continue Watching or Season Menu
                    const menuHtml = `
                        <div style="padding:20px; text-align:center;">
                            <h3 style="margin-bottom:20px;">Estás viendo: ${item.title}</h3>
                            <p style="margin-bottom:30px; color:#aaa;">Continuar episodio: <br><strong style="color:white; font-size:1.1rem;">${lastEpisode.title}</strong></p>
                            
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button class="btn btn-primary" onclick="closeModal(); playVideo('${lastEpisode.video}', '${lastEpisode.title}', ${lastEpisode.id}, ${item.id})">
                                    <i class="ri-play-fill"></i> Reanudar Episodio
                                </button>
                                <button class="btn btn-secondary" onclick="closeModal(); openDetails(${item.id})">
                                    <i class="ri-play-list-add-line"></i> Ver Temporadas
                                </button>
                            </div>
                        </div>
                    `;
                    // Use a small modal for this
                    openModal(menuHtml);
                } else {
                    // No history, try to play S1 E1 directly or open details?
                    // User asked for "play" to work.
                    // If no history, let's play S1 E1 if available, or open details.
                    // Playing S1 E1 directly is better UX for "Play".
                    
                    if (item.seasons && item.seasons.length > 0 && item.seasons[0].episodes.length > 0) {
                        const firstEp = item.seasons[0].episodes[0];
                        // Just play it? Or ask?
                        // Let's play it directly, assuming that's what "Play" means for a new series.
                        playVideo(firstEp.video, firstEp.title, firstEp.id, item.id);
                    } else {
                        openDetails(id);
                    }
                }
            }
        }

        function playVideo(url, title, itemId, seriesId = null, poster = null) {
            if(!app.state.user) return app.showToast("Debes iniciar sesión.", "error");
            if(!app.state.currentProfile) return app.router('profiles');
            if(!url) return app.showToast("Error: No se encontró el video.", "error");
            
            const overlay = document.createElement('div');
            overlay.id = 'video-overlay';
            overlay.className = 'video-overlay-container';
            
            overlay.innerHTML = `
                <div class="video-ui-header">
                    <button onclick="closeVideoPlayer()" class="video-btn"><i class="ri-arrow-left-line"></i></button>
                    <h2 class="video-title">${title}</h2>
                </div>
                
                <video id="main-video-player" src="${url}" poster="${poster || ''}" autoplay playsinline webkit-playsinline style="width:100%; height:100%; object-fit:contain; outline:none; background:black;"></video>
                
                <div class="video-click-area" onclick="togglePlay()"></div>
                
                <div class="video-controls-bar">
                    <input type="range" class="video-slider" id="video-slider" min="0" max="100" value="0" step="0.01" oninput="seekVideo(this.value)" onchange="seekVideo(this.value, true)">
                    
                    <div class="video-controls-row">
                        <div class="video-controls-left">
                            <button onclick="togglePlay()" id="play-btn" class="video-btn"><i class="ri-pause-fill"></i></button>
                            <button onclick="skipTime(-10)" ontouchend="event.preventDefault(); skipTime(-10)" class="video-btn" style="padding:10px;"><i class="ri-replay-10-line"></i></button>
                            <button onclick="skipTime(10)" ontouchend="event.preventDefault(); skipTime(10)" class="video-btn" style="padding:10px;"><i class="ri-forward-10-line"></i></button>
                            <span id="time-display" style="color:white; font-size:0.9rem; font-variant-numeric:tabular-nums;">0:00 / 0:00</span>
                        </div>
                        
                        <div class="video-controls-right">
                            <button onclick="toggleMute()" id="mute-btn" class="video-btn"><i class="ri-volume-up-line"></i></button>
                            <input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)">
                            <button onclick="toggleFullscreen()" class="video-btn"><i class="ri-fullscreen-line"></i></button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.classList.add('video-active');

            const video = document.getElementById('main-video-player');
            const profile = app.state.currentProfile;

            // Handle error
            video.onerror = () => {
                app.showToast("Error al reproducir el video.", "error");
                console.error("Video Error:", video.error);
            };

            // Restore progress
            if(profile.continueWatching) {
                const saved = profile.continueWatching.find(i => i.itemId === itemId);
                if(saved && saved.time) {
                    video.currentTime = saved.time;
                }
            }

            // Global Helpers for this session
            window.togglePlay = () => {
                if(video.paused) {
                    video.play().catch(e => console.error(e));
                    document.getElementById('play-btn').innerHTML = '<i class="ri-pause-fill"></i>';
                } else {
                    video.pause();
                    document.getElementById('play-btn').innerHTML = '<i class="ri-play-fill"></i>';
                }
            };

            window.skipTime = (sec) => {
                let t = video.currentTime + sec;
                if (t < 0) t = 0;
                if (t > video.duration) t = video.duration;
                video.currentTime = t;
            };

            window.seekVideo = (val, commit=false) => {
                if(video.duration) {
                    const time = (val / 100) * video.duration;
                    if(commit) video.currentTime = time;
                    // Update time display while dragging
                    document.getElementById('time-display').innerText = `${fmt(time)} / ${fmt(video.duration)}`;
                }
            };

            window.setVolume = (val) => {
                video.volume = val;
                video.muted = false;
                updateMuteIcon();
            };

            window.toggleMute = () => {
                video.muted = !video.muted;
                updateMuteIcon();
            };

            function updateMuteIcon() {
                const btn = document.getElementById('mute-btn');
                if(video.muted || video.volume === 0) btn.innerHTML = '<i class="ri-volume-mute-line"></i>';
                else if(video.volume < 0.5) btn.innerHTML = '<i class="ri-volume-down-line"></i>';
                else btn.innerHTML = '<i class="ri-volume-up-line"></i>';
            }

            window.toggleFullscreen = () => {
                if(!document.fullscreenElement && !document.webkitFullscreenElement) {
                    if(overlay.requestFullscreen) {
                        overlay.requestFullscreen().catch(err => console.log(err));
                    } else if(overlay.webkitRequestFullscreen) {
                        overlay.webkitRequestFullscreen();
                    } else if(video.webkitEnterFullscreen) {
                        video.webkitEnterFullscreen();
                    }
                } else {
                    if(document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if(document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                }
            };

            window.closeVideoPlayer = () => {
                if(document.getElementById('video-overlay')) {
                    document.getElementById('video-overlay').remove();
                }
                document.body.classList.remove('video-active');
            };

            // Format Time
            const fmt = (s) => {
                if(isNaN(s)) return "0:00";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec<10?'0':''}${sec}`;
            };

            // Time Update Loop
            video.addEventListener('timeupdate', () => {
                if(!video.duration) return;
                const pct = (video.currentTime / video.duration) * 100;
                const slider = document.getElementById('video-slider');
                // Only update if not currently being dragged (simple check: if focused?)
                // Actually, standard range inputs update fine if we don't block it. 
                // But to avoid jumping while dragging, we might want to check document.activeElement
                if(document.activeElement !== slider) {
                    slider.value = pct;
                    document.getElementById('time-display').innerText = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
                }
            });

            // Idle Detection
            let idleTimer;
            function resetIdle() {
                overlay.classList.remove('user-idle');
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => overlay.classList.add('user-idle'), 3000);
            }
            overlay.addEventListener('mousemove', resetIdle);
            overlay.addEventListener('click', resetIdle);
            overlay.addEventListener('touchstart', resetIdle);
            resetIdle();

            // Save Progress Logic
            const saveInterval = setInterval(() => {
                if(video.paused || video.ended) return;
                saveProgress(itemId, seriesId, video.currentTime, video.duration, title, url);
            }, 5000);

            video.addEventListener('ended', () => {
                clearInterval(saveInterval);
                removeFromContinueWatching(itemId);

                // Confetti on Series Completion
                if (seriesId) {
                    const seriesItem = allItems.find(i => i.id === seriesId);
                    if (seriesItem && seriesItem.seasons) {
                        // Find current episode
                        let isLast = false;
                        // Check if this is the absolute last episode
                        const lastSeason = seriesItem.seasons[seriesItem.seasons.length - 1];
                        if (lastSeason) {
                            const lastEp = lastSeason.episodes[lastSeason.episodes.length - 1];
                            if (lastEp && lastEp.id === itemId) {
                                isLast = true;
                            }
                        }
                        
                        if (isLast) {
                             if(typeof window.runConfetti === 'function') window.runConfetti();
                             else if(typeof runConfetti === 'function') runConfetti();
                             app.showToast("¡Has completado la serie! 🎉", "success");
                        }
                    }
                }

                closeVideoPlayer();
            });

            // Cleanup
            const observer = new MutationObserver((mutations) => {
                if(!document.getElementById('video-overlay')) {
                    clearInterval(saveInterval);
                    if(video && !video.ended && video.currentTime > 0) {
                        saveProgress(itemId, seriesId, video.currentTime, video.duration, title, url);
                    }
                    // Cleanup globals
                    delete window.togglePlay;
                    delete window.skipTime;
                    delete window.seekVideo;
                    delete window.setVolume;
                    delete window.toggleMute;
                    delete window.toggleFullscreen;
                    delete window.closeVideoPlayer;
                    observer.disconnect();
                }
            });
            observer.observe(document.body, { childList: true });
        }

        function saveProgress(itemId, seriesId, time, duration, title, img) {
            if(!app.state.currentProfile) return;
            const p = app.state.currentProfile;
            if(!p.continueWatching) p.continueWatching = [];
            
            // Remove existing entry for this item
            // Clean up previous entries for this series/movie to avoid duplicates
            if(seriesId) {
                p.continueWatching = p.continueWatching.filter(i => i.seriesId !== seriesId);
            } else {
                p.continueWatching = p.continueWatching.filter(i => i.itemId !== itemId);
            }

            // Add new entry to top
            p.continueWatching.unshift({
                itemId,
                seriesId, // null for movies
                time,
                duration,
                title,
                lastWatched: Date.now()
            });

            // Persist locally
            localStorage.setItem('niro_profile', JSON.stringify(p));
            // Sync to user object in memory
             const u = app.state.user;
             const pIdx = u.profiles.findIndex(pr => pr.id === p.id);
             if(pIdx > -1) u.profiles[pIdx] = p;
             localStorage.setItem('niro_user', JSON.stringify(u));
             
             // Update allUsers to ensure persistence on reload
             const uGlobalIdx = allUsers.findIndex(usr => usr.email === u.email);
             if(uGlobalIdx > -1) {
                 allUsers[uGlobalIdx] = u;
                 app.saveDB({ users: allUsers });
             }
        }

        function removeFromContinueWatching(itemId) {
            if(!app.state.currentProfile) return;
            const p = app.state.currentProfile;
            if(!p.continueWatching) return;
            p.continueWatching = p.continueWatching.filter(i => i.itemId !== itemId);
             localStorage.setItem('niro_profile', JSON.stringify(p));
             const u = app.state.user;
             const pIdx = u.profiles.findIndex(pr => pr.id === p.id);
             if(pIdx > -1) u.profiles[pIdx] = p;
             localStorage.setItem('niro_user', JSON.stringify(u));
             
             // Update allUsers to ensure persistence on reload
             const uGlobalIdx = allUsers.findIndex(usr => usr.email === u.email);
             if(uGlobalIdx > -1) {
                 allUsers[uGlobalIdx] = u;
                 app.saveDB({ users: allUsers });
             }
        }

        // --- Admin Actions ---
        function openAddUserModal() {
            openModal(`
                <div style="padding:2rem;">
                    <h2>Agregar Usuario</h2>
                    <form onsubmit="handleAddUser(event)" style="margin-top:1rem;">
                        <div style="margin-bottom:1rem;"><label>Nombre</label><input id="new-u-name" required></div>
                        <div style="margin-bottom:1rem;"><label>Email</label><input id="new-u-email" type="email" required></div>
                        <div style="margin-bottom:1rem;"><label>Contraseña</label><input id="new-u-pass" required></div>
                        <div style="margin-bottom:1rem;"><label>Rol</label>
                            <select id="new-u-role"><option value="user">Usuario</option><option value="admin">Admin</option></select>
                        </div>
                        <button class="btn btn-primary">Crear Usuario</button>
                    </form>
                </div>
            `);
        }
        
        async function approveUser(email, approved) {
            const u = allUsers.find(u => u.email === email);
            if(u) {
                if(approved) {
                    u.status = 'active';
                } else {
                    allUsers = allUsers.filter(user => user.email !== email);
                }
                await app.saveDB({ users: allUsers });
                app.renderAdmin();
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const name = document.getElementById('new-u-name').value;
            const newUser = {
                name,
                email: document.getElementById('new-u-email').value,
                password: document.getElementById('new-u-pass').value,
                role: document.getElementById('new-u-role').value,
                status: 'active', // Admin created users are active
                banned: false,
                profiles: [{ id: Date.now(), name, avatar: 'https://i.pinimg.com/736x/c4/88/34/c488340ad56e5454f4576f6c708b3482.jpg' }]
            };
            allUsers.push(newUser);
            await app.saveDB({ users: allUsers });
            closeModal();
            app.renderAdmin();
        }

        async function deleteUser(email) {
            app.confirmAction("¿Eliminar usuario?", async () => {
                allUsers = allUsers.filter(u => u.email !== email);
                await app.saveDB({ users: allUsers });
                app.renderAdmin();
                app.showToast("Usuario eliminado");
            });
        }

        // --- Add Content Wizard ---
        function openAddContentModal() {
            openModal(`
                <div style="padding:2rem;">
                    <h2>Agregar Contenido</h2>
                    <div style="margin-bottom:1rem;">
                        <label>Tipo</label>
                        <select id="c-type" onchange="toggleVideoField(this.value)">
                            <option value="movie">Película</option>
                            <option value="series">Serie</option>
                        </select>
                    </div>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="c-title" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="c-desc" rows="3"></textarea></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
                        <div><label>Año</label><input id="c-year" type="number" value="2024"></div>
                        <div><label>Match %</label><input id="c-match" type="number" value="98"></div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
                        <div><label>Estreno (Fecha)</label><input id="c-releaseDate" type="date"></div>
                        <div style="display:flex; align-items:end; padding-bottom:10px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                <input id="c-isUpcoming" type="checkbox" style="width:20px; height:20px;">
                                <span style="font-size:1rem;">Es "Próximamente"</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom:1rem;">
                        <label>Género</label>
                        <select id="c-genre">
                            <option value="Acción">Acción</option>
                            <option value="Aventura">Aventura</option>
                            <option value="Comedia">Comedia</option>
                            <option value="Drama">Drama</option>
                            <option value="Terror">Terror</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Ciencia Ficción">Ciencia Ficción</option>
                            <option value="Fantasía">Fantasía</option>
                            <option value="Romance">Romance</option>
                            <option value="Documental">Documental</option>
                            <option value="Crimen">Crimen</option>
                            <option value="Misterio">Misterio</option>
                            <option value="Animación">Animación</option>
                        </select>
                    </div>

                    <div style="margin-bottom:1rem;"><label>Elenco (separado por comas)</label><input id="c-cast" placeholder="Actor 1, Actor 2..."></div>
                    <div style="margin-bottom:1rem;"><label>Director</label><input id="c-director" placeholder="Nombre del Director"></div>
                    <div style="margin-bottom:1rem;"><label>Premios</label><input id="c-awards" placeholder="Oscar, Globo de Oro..."></div>

                    <div style="margin-bottom:1rem;">
                        <label>Imagen de Portada</label>
                        <input type="file" id="c-img-file" accept="image/*">
                    </div>

                    <div id="video-field" style="margin-bottom:1rem;">
                        <label>Archivo de Video (Solo Películas)</label>
                        <input type="file" id="c-video-file" accept="video/*">
                    </div>

                    <div style="margin-bottom:1rem;">
                        <label>Trailer URL (YouTube/MP4) - Opcional</label>
                        <input id="c-trailer" placeholder="https://youtube.com/..." style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:4px;">
                    </div>

                    <button class="btn btn-primary" onclick="handleAddContent()" id="btn-upload">Publicar</button>
                    <div id="upload-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                </div>
            `);
        }

        function toggleVideoField(val) {
            const f = document.getElementById('video-field');
            f.style.display = val === 'movie' ? 'block' : 'none';
        }

        
        function uploadFileWithProgress(url, fd, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        if(onProgress) onProgress(percentComplete);
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            resolve(data);
                        } catch (e) {
                            reject(new Error("Invalid JSON response"));
                        }
                    } else {
                        reject(new Error("Upload failed: " + xhr.statusText));
                    }
                };
                
                xhr.onerror = () => reject(new Error("Network error"));
                xhr.send(fd);
            });
        }

        
        async function uploadChunkedFile(file, onProgress) {
            const chunkSize = 5 * 1024 * 1024; // 5MB chunks (safe for Cloudflare)
            const totalChunks = Math.ceil(file.size / chunkSize);
            const uploadId = Date.now().toString() + Math.random().toString().substr(2, 5);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const fd = new FormData();
                fd.append('chunk', chunk);
                fd.append('chunkIndex', i);
                fd.append('totalChunks', totalChunks);
                fd.append('fileName', file.name);
                fd.append('uploadId', uploadId);
                
                // Retry logic for robustness
                let attempts = 0;
                while(attempts < 3) {
                    try {
                        const res = await fetch('/upload/chunk', { method: 'POST', body: fd });
                        if (!res.ok) throw new Error('Upload failed');
                        const data = await res.json();
                        
                        // Report progress
                        if (onProgress) {
                            const percent = ((i + 1) / totalChunks) * 100;
                            onProgress(percent);
                        }
                        
                        if (data.done) {
                            return data;
                        }
                        break; // Success, move to next chunk
                    } catch (e) {
                        attempts++;
                        console.error(`Chunk ${i} failed, attempt ${attempts}`, e);
                        if(attempts >= 3) throw e;
                        await new Promise(r => setTimeout(r, 1000 * attempts)); // Backoff
                    }
                }
            }
        }

        async function handleAddContent() {
            const btn = document.getElementById('btn-upload');
            const status = document.getElementById('upload-status');
            
            btn.disabled = true;
            status.innerText = "Subiendo archivos...";

            try {
                // Upload Image
                const imgFile = document.getElementById('c-img-file').files[0];
                let imgUrl = "https://via.placeholder.com/800x450";
                
                if(imgFile) {
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) imgUrl = data.url;
                }

                const type = document.getElementById('c-type').value;
                let videoUrl = "";

                if(type === 'movie') {
                    const vidFile = document.getElementById('c-video-file').files[0];
                    if(vidFile) {
                        status.innerHTML = 'Subiendo video: <span id="upload-pct">0%</span><div style="width:100%; height:4px; background:#333; margin-top:5px; border-radius:2px;"><div id="upload-bar" style="width:0%; height:100%; background:var(--color-brand-primary); transition:width 0.2s;"></div></div>';
                        
                        const data = await uploadChunkedFile(vidFile, (pct) => {
                            const p = Math.floor(pct);
                            const pctEl = document.getElementById('upload-pct');
                            const barEl = document.getElementById('upload-bar');
                            if(pctEl) pctEl.innerText = p + '%';
                            if(barEl) barEl.style.width = p + '%';
                            if(p >= 100) status.innerHTML = "Procesando video... <i class='ri-loader-4-line spin'></i>";
                        });
                        
                        if(data.url) videoUrl = data.url;

                    }
                }

                const newItem = {
                    id: Date.now(),
                    type,
                    title: document.getElementById('c-title').value,
                    desc: document.getElementById('c-desc').value,
                    year: document.getElementById('c-year').value,
                    match: document.getElementById('c-match').value,
                    genre: document.getElementById('c-genre').value,
                    releaseDate: document.getElementById('c-releaseDate').value,
                    isUpcoming: document.getElementById('c-isUpcoming').checked,
                    cast: document.getElementById('c-cast').value,
                    director: document.getElementById('c-director').value,
                    awards: document.getElementById('c-awards').value,
                    trailer: document.getElementById('c-trailer').value,
                    img: imgUrl,
                    rating: "16+",
                    seasons: type === 'series' ? [{ id: Date.now(), name: "Temporada 1", episodes: [] }] : undefined,
                    video: type === 'movie' ? videoUrl : undefined
                };

                allItems.unshift(newItem);
                await app.saveDB({ items: allItems });
                
                app.renderAdmin();
                
                if(type === 'series') {
                    // Smooth transition to episode management
                    manageEpisodes(newItem.id);
                } else {
                    closeModal();
                }

            } catch(e) {
                console.error(e);
                app.showToast("Error subiendo contenido", "error");
                btn.disabled = false;
                status.innerText = "";
            }
        }

        // --- Edit Content ---
        function openEditContentModal(id) {
            const item = allItems.find(i => i.id === id);
            if(!item) return;

            openModal(`
                <div style="padding:2rem;">
                    <h2>Editar Contenido</h2>
                    <div style="margin-bottom:1rem;">
                        <label>Tipo</label>
                        <input value="${item.type === 'movie' ? 'Película' : 'Serie'}" disabled style="opacity:0.6;">
                    </div>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="e-title" value="${item.title}" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="e-desc" rows="3">${item.desc}</textarea></div>
                    <div class="input-grid-3">
                        <div><label>Año</label><input id="e-year" type="number" value="${item.year}"></div>
                        <div><label>Género</label><input id="e-genre" value="${item.genre || ''}"></div>
                        <div><label>Match %</label><input id="e-match" type="number" value="${item.match}"></div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
                        <div><label>Estreno (Fecha)</label><input id="e-releaseDate" type="date" value="${item.releaseDate || ''}"></div>
                        <div style="display:flex; align-items:end; padding-bottom:10px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                <input id="e-isUpcoming" type="checkbox" style="width:20px; height:20px;" ${item.isUpcoming ? 'checked' : ''}>
                                <span style="font-size:1rem;">Es "Próximamente"</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom:1rem;"><label>Elenco (separado por comas)</label><input id="e-cast" value="${item.cast || ''}" placeholder="Actor 1, Actor 2..."></div>
                    <div style="margin-bottom:1rem;"><label>Director</label><input id="e-director" value="${item.director || ''}" placeholder="Nombre del Director"></div>
                    <div style="margin-bottom:1rem;"><label>Premios</label><input id="e-awards" value="${item.awards || ''}" placeholder="Oscar, Globo de Oro..."></div>
                    <div style="margin-bottom:1rem;"><label>Trailer URL</label><input id="e-trailer" value="${item.trailer || ''}" placeholder="https://youtube.com/..."></div>
                    
                    <div style="margin-bottom:1rem;">
                        <label>Cambiar Imagen de Portada (Opcional)</label>
                        <input type="file" id="e-img-file" accept="image/*">
                        <div style="font-size:0.8rem;color:#aaa;margin-top:5px;">Actual: <a href="${item.img}" target="_blank" style="text-decoration:underline;">Ver imagen</a></div>
                    </div>

                    ${item.type === 'movie' ? `
                    <div id="video-field" style="margin-bottom:1rem;">
                        <label>Cambiar Archivo de Video (Opcional)</label>
                        <input type="file" id="e-video-file" accept="video/*">
                        ${item.video ? `<div style="font-size:0.8rem;color:#aaa;margin-top:5px;">Video actual cargado</div>` : ''}
                    </div>
                    ` : ''}

                    <button class="btn btn-primary" onclick="handleUpdateContent(${item.id})" id="btn-update">Guardar Cambios</button>
                    <div id="update-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                </div>
            `);
        }

        async function handleUpdateContent(id) {
            const btn = document.getElementById('btn-update');
            const status = document.getElementById('update-status');
            const item = allItems.find(i => i.id === id);
            
            if(!item) return;

            btn.disabled = true;
            status.innerText = "Guardando...";

            try {
                // Upload Image if changed
                const imgFile = document.getElementById('e-img-file').files[0];
                if(imgFile) {
                    status.innerText = "Subiendo nueva imagen...";
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) item.img = data.url;
                }

                // Upload Video if changed (Movie only)
                if(item.type === 'movie') {
                    const vidFile = document.getElementById('e-video-file').files[0];
                    if(vidFile) {
                        status.innerText = "Iniciando carga optimizada...";
                        // Use Chunked Upload
                        const data = await uploadChunkedFile(vidFile, (pct) => {
                            const p = Math.floor(pct);
                            status.innerText = `Subiendo video: ${p}%`;
                        });
                        if(data.url) item.video = data.url;
                    }
                }

                // Update text fields
                item.title = document.getElementById('e-title').value;
                item.desc = document.getElementById('e-desc').value;
                item.year = document.getElementById('e-year').value;
                item.match = document.getElementById('e-match').value;
                item.genre = document.getElementById('e-genre').value;
                item.releaseDate = document.getElementById('e-releaseDate').value;
                item.isUpcoming = document.getElementById('e-isUpcoming').checked;
                item.cast = document.getElementById('e-cast').value;
                item.director = document.getElementById('e-director').value;
                item.awards = document.getElementById('e-awards').value;
                item.trailer = document.getElementById('e-trailer').value;

                await app.saveDB({ items: allItems });
                
                closeModal();
                app.renderAdmin();

            } catch(e) {
                console.error(e);
                alert("Error actualizando contenido");
                btn.disabled = false;
                status.innerText = "";
            }
        }


        async function deleteFile(url) {
            if (!url) return;
            try {
                await fetch('/delete', {
                    method: 'POST',
                    body: JSON.stringify({ url })
                });
            } catch (e) {
                console.error("Error deleting file:", url, e);
            }
        }

        // --- Confetti Effect ---
        function runConfetti(x, y) {
            const colors = ['#e50914', '#ffffff', '#222222'];
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.style.position = 'fixed';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.width = Math.random() * 6 + 4 + 'px';
                p.style.height = Math.random() * 6 + 4 + 'px';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.borderRadius = '50%';
                p.style.pointerEvents = 'none';
                p.style.zIndex = '9999';
                document.body.appendChild(p);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100 + 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                p.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], {
                    duration: Math.random() * 500 + 500,
                    easing: 'cubic-bezier(0, .9, .57, 1)',
                }).onfinish = () => p.remove();
            }
        }


        async function deleteItem(id) {
            app.confirmAction("¿Eliminar este contenido y todos sus archivos asociados?", async () => {
                const item = allItems.find(i => i.id === id);
            if (!item) return;

            // Delete from Downloads (Local)
            try {
                if (item.type === 'movie') {
                    if(await DownloadManager.has(id)) await DownloadManager.remove(id);
                } else if (item.type === 'series' && item.seasons) {
                    for(const s of item.seasons) {
                        if(s.episodes) {
                            for(const ep of s.episodes) {
                                if(await DownloadManager.has(ep.id)) await DownloadManager.remove(ep.id);
                            }
                        }
                    }
                }
            } catch(e) { console.error("Error removing local downloads", e); }

            // Delete Image
            if (item.img && item.img.startsWith('/media/')) {
                await deleteFile(item.img);
            }

            // Delete Video(s)
            if (item.type === 'movie' && item.video && item.video.startsWith('/media/')) {
                await deleteFile(item.video);
            } else if (item.type === 'series' && item.seasons) {
                for (const season of item.seasons) {
                    if (season.episodes) {
                        for (const ep of season.episodes) {
                            if (ep.video && ep.video.startsWith('/media/')) {
                                await deleteFile(ep.video);
                            }
                            if (ep.img && ep.img.startsWith('/media/')) {
                                await deleteFile(ep.img);
                            }
                        }
                    }
                }
            }

            allItems = allItems.filter(i => i.id !== id);
            await app.saveDB({ items: allItems });
            app.renderAdmin();
            app.showToast("Contenido eliminado");
            });
        }

        // --- Series Management ---
        function manageEpisodes(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            if(!item) return;

            openModal(`
                <div style="padding:2rem; width:100%;">
                    <h2>Gestionar: ${item.title}</h2>
                    <div style="margin:1rem 0; max-height:400px; overflow-y:auto;">
                        ${item.seasons.length === 0 ? '<p>No hay temporadas.</p>' : ''}
                        ${item.seasons.map((s, sIdx) => `
                            <div style="background:rgba(255,255,255,0.05); padding:1rem; margin-bottom:1rem; border-radius:8px;">
                                <h4 style="color:var(--color-brand-primary); margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center;">
                                    ${s.name}
                                    <button onclick="deleteSeason(${seriesId}, ${sIdx})" style="color:#ef4444; font-size:0.9rem; background:none; border:none; cursor:pointer;" title="Eliminar Temporada"><i class="ri-delete-bin-line"></i></button>
                                </h4>
                                <div style="margin-left:1rem;">
                                    ${s.episodes.map(ep => `
                                        <div style="font-size:0.9rem; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                                            <div style="display:flex; align-items:center; gap:10px;">
                                                <img src="${ep.img || item.img}" style="width:50px; height:30px; object-fit:cover; border-radius:2px; opacity:0.7;">
                                                <span>${ep.title}</span>
                                            </div>
                                            <button onclick="deleteEpisode(${seriesId}, ${sIdx}, ${ep.id})" style="color:#ef4444; font-size:1rem; background:none; border:none; cursor:pointer;" title="Eliminar Episodio"><i class="ri-close-circle-line"></i></button>
                                        </div>
                                    `).join('')}
                                    <button class="btn btn-secondary" style="margin-top:10px; font-size:0.8rem;" onclick="addEpisode(${seriesId}, ${sIdx})">+ Añadir Episodio</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-primary" onclick="addSeason(${seriesId})">Nueva Temporada</button>
                </div>
            `);
        }

        async function deleteSeason(seriesId, seasonIdx) {
            app.confirmAction("¿Eliminar esta temporada y todos sus episodios? Esta acción no se puede deshacer.", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                
                if(season.episodes) {
                    for(const ep of season.episodes) {
                        try {
                            if(await DownloadManager.has(ep.id)) await DownloadManager.remove(ep.id);
                        } catch(e) {}

                        if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                        if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    }
                }
                
                item.seasons.splice(seasonIdx, 1);
                await app.saveDB({ items: allItems });
                manageEpisodes(seriesId);
                app.showToast("Temporada eliminada");
            });
        }

        async function deleteEpisode(seriesId, seasonIdx, episodeId) {
            app.confirmAction("¿Eliminar este episodio?", async () => {
                const item = allItems.find(i => i.id === seriesId);
                const season = item.seasons[seasonIdx];
                const ep = season.episodes.find(e => e.id === episodeId);
                
                if(ep) {
                    try {
                        if(await DownloadManager.has(episodeId)) await DownloadManager.remove(episodeId);
                    } catch(e) {}

                    if(ep.video && ep.video.startsWith('/media/')) await deleteFile(ep.video);
                    if(ep.img && ep.img.startsWith('/media/')) await deleteFile(ep.img);
                    
                    season.episodes = season.episodes.filter(e => e.id !== episodeId);
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId);
                    app.showToast("Episodio eliminado");
                }
            });
        }

        async function addSeason(seriesId) {
            const item = allItems.find(i => i.id === seriesId);
            const nextSeasonNum = item.seasons.length + 1;
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Nueva Temporada</h3>
                    <div style="margin-bottom:1rem;">
                        <label>Nombre de la Temporada</label>
                        <input id="new-season-name" value="Temporada ${nextSeasonNum}" required>
                    </div>
                    <button class="btn btn-primary" onclick="handleCreateSeason(${seriesId})">Crear Temporada</button>
                </div>
            `);
        }

        async function handleCreateSeason(seriesId) {
            const name = document.getElementById('new-season-name').value;
            if(!name) return app.showToast("El nombre es obligatorio", "error");
            
            const item = allItems.find(i => i.id === seriesId);
            item.seasons.push({ id: Date.now(), name, episodes: [] });
            
            await app.saveDB({ items: allItems });
            app.showToast("Temporada creada");
            
            // Close the small modal and reopen the manage modal (a bit hacky but works for this structure)
            // Ideally we would have stacked modals or just re-render the content
            // effectively "closeModal()" closes the current one.
            // We need to reopen manageEpisodes.
            manageEpisodes(seriesId); 
        }

        async function addEpisode(seriesId, seasonIdx) {
            const item = allItems.find(i => i.id === seriesId);
            const season = item.seasons[seasonIdx];
            
            openModal(`
                <div style="padding:2rem;">
                    <h3>Añadir Episodio a ${season.name}</h3>
                    <div style="margin-bottom:1rem;"><label>Título</label><input id="ep-title" required></div>
                    <div style="margin-bottom:1rem;"><label>Descripción</label><textarea id="ep-desc" rows="2"></textarea></div>
                    <div style="margin-bottom:1rem;">
                        <label>Imagen del Episodio (Thumbnail)</label>
                        <input type="file" id="ep-img" accept="image/*">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label>Video del Episodio</label>
                        <input type="file" id="ep-video" accept="video/*">
                    </div>
                    <button class="btn btn-primary" id="btn-ep-upload" onclick="handleEpUpload(${seriesId}, ${seasonIdx})">Subir Episodio</button>
                    <div id="ep-status" style="margin-top:10px; color:var(--color-brand-accent);"></div>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="manageEpisodes(${seriesId})">Cancelar</button>
                </div>
            `);
        }

        async function handleEpUpload(seriesId, seasonIdx) {
            const btn = document.getElementById('btn-ep-upload');
            const status = document.getElementById('ep-status');
            const title = document.getElementById('ep-title').value;
            const desc = document.getElementById('ep-desc').value;
            const vidFile = document.getElementById('ep-video').files[0];
            const imgFile = document.getElementById('ep-img').files[0];
            
            if(!title || !vidFile) return app.showToast("Faltan datos (título y video son obligatorios)", "error");

            btn.disabled = true;
            status.innerText = "Subiendo archivos...";

            try {
                // Upload Image
                let imgUrl = "";
                if(imgFile) {
                    const fd = new FormData();
                    fd.append('file', imgFile);
                    const res = await fetch('/upload/image', { method:'POST', body:fd });
                    const data = await res.json();
                    if(data.url) imgUrl = data.url;
                }

                
                // Upload Video (Chunked)
                status.innerHTML = 'Subiendo video: <span id="ep-upload-pct">0%</span><div style="width:100%; height:4px; background:#333; margin-top:5px; border-radius:2px;"><div id="ep-upload-bar" style="width:0%; height:100%; background:var(--color-brand-primary); transition:width 0.2s;"></div></div>';
                
                const data = await uploadChunkedFile(vidFile, (pct) => {
                    const p = Math.floor(pct);
                    const pctEl = document.getElementById('ep-upload-pct');
                    const barEl = document.getElementById('ep-upload-bar');
                    if(pctEl) pctEl.innerText = p + '%';
                    if(barEl) barEl.style.width = p + '%';
                    if(p >= 100) status.innerHTML = "Procesando video... <i class='ri-loader-4-line spin'></i>";
                });
    
                
                if(data.url) {
                    const item = allItems.find(i => i.id === seriesId);
                    item.seasons[seasonIdx].episodes.push({
                        id: Date.now(),
                        title,
                        desc,
                        img: imgUrl,
                        video: data.url
                    });
                    await app.saveDB({ items: allItems });
                    manageEpisodes(seriesId); // Go back to list
                } else {
                    throw new Error("Upload failed");
                }
            } catch(e) {
                console.error(e);
                app.showToast("Error subiendo episodio", "error");
                btn.disabled = false;
                status.innerText = "";
            }
        }

        // --- Init ---
        app.init();

        /* --- Status Page --- */
        function openStatusPage() {
            const html = `
                <div class="status-overlay" id="status-overlay" style="display:flex;">
                    <div style="background:var(--color-bg-surface); width:100%; max-width:600px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); overflow:hidden;">
                        <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0;">Estado del Sistema</h2>
                            <button onclick="document.getElementById('status-overlay').remove()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;"><i class="ri-close-line"></i></button>
                        </div>
                        <div style="padding:20px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                                    <div style="color:#aaa; font-size:0.9rem;">Estado del Servidor</div>
                                    <div style="color:#4ade80; font-weight:bold; font-size:1.1rem; display:flex; align-items:center; gap:5px;"><i class="ri-checkbox-circle-fill"></i> Operativo</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                                    <div style="color:#aaa; font-size:0.9rem;">Base de Datos</div>
                                    <div style="color:#4ade80; font-weight:bold; font-size:1.1rem; display:flex; align-items:center; gap:5px;"><i class="ri-database-2-fill"></i> Conectada</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                                    <div style="color:#aaa; font-size:0.9rem;">Versión App</div>
                                    <div style="color:white; font-weight:bold; font-size:1.1rem;">v2.5.0</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                                    <div style="color:#aaa; font-size:0.9rem;">Latencia</div>
                                    <div style="color:white; font-weight:bold; font-size:1.1rem;">${Math.floor(Math.random() * 50 + 20)}ms</div>
                                </div>
                            </div>
                            
                            <h3 style="font-size:1rem; margin-bottom:10px;">Servicios</h3>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <div style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.02); border-radius:4px;">
                                    <span>Streaming API</span>
                                    <span style="color:#4ade80;">Online</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.02); border-radius:4px;">
                                    <span>Auth Service</span>
                                    <span style="color:#4ade80;">Online</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.02); border-radius:4px;">
                                    <span>Upload Service</span>
                                    <span style="color:#4ade80;">Online</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = html;
            document.body.appendChild(div.firstElementChild);
        }

        /* --- Secret Admin Access --- */
        let secretCode = [];
        const secretPattern = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
        window.addEventListener('keydown', (e) => {
            secretCode.push(e.key);
            if (secretCode.length > secretPattern.length) secretCode.shift();
            if (JSON.stringify(secretCode) === JSON.stringify(secretPattern)) {
                if(app.state.user && app.state.user.role === 'admin') { app.router('admin'); }
            }
        });
        
        // Mobile Secret: Triple tap on Logo
        let tapCount = 0;
        let tapTimer;
        document.addEventListener('click', (e) => {
            if(e.target.closest('.logo')) {
                tapCount++;
                clearTimeout(tapTimer);
                tapTimer = setTimeout(() => tapCount = 0, 500);
                if(tapCount === 5) {
                    if(app.state.user && app.state.user.role === 'admin') { app.router('admin'); }
                }
            }
        });

        /* --- Notification Management --- */
        async function deleteNotification(index) {
            await app.fetchDB();
            let db = { notifications: [] };
            try {
                 const res = await fetch('/db');
                 db = await res.json();
            } catch(e) {}
            if(db.notifications) {
                db.notifications.splice(index, 1);
                await app.saveDB({ notifications: db.notifications });
                app.renderHeader();
            }
        }

        async function handleSendNotification(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const message = form.message.value;
            
            if(!title || !message) return app.showToast("Completa todos los campos", "error");
            
            try {
                const res = await fetch('/api/notifications/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title, message })
                });
                
                if(res.ok) {
                    app.showToast("Notificación enviada exitosamente", "success");
                    form.reset();
                } else {
                    app.showToast("Error al enviar notificación", "error");
                }
            } catch(e) {
                console.error(e);
                app.showToast("Error de conexión", "error");
            }
        }

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered', registration);
                        
                        function showUpdateToast(worker) {
                            // Don't show if user is watching video
                            const video = document.querySelector('video');
                            if(video && !video.paused) {
                                console.log("Update pending, but video playing. deferring.");
                                return;
                            }
                            
                            // Check if toast already exists
                            if(document.querySelector('.update-toast')) return;

                            // Custom Toast with Action
                            const toast = document.createElement('div');
                            toast.className = 'update-toast';
                            toast.innerHTML = `
                                <div>
                                    <i class="ri-download-cloud-2-line"></i>
                                    <span>Nueva versión disponible</span>
                                </div>
                                <button>Actualizar</button>
                            `;
                            Object.assign(toast.style, {
                                position: 'fixed', bottom: '80px', right: '20px', 
                                background: 'rgba(30, 20, 50, 0.95)', border: '1px solid var(--color-brand-primary)',
                                padding: '15px', borderRadius: '12px', zIndex: '10000',
                                display: 'flex', gap: '15px', alignItems: 'center',
                                boxShadow: '0 10px 30px rgba(0,0,0,0.5)', backdropFilter: 'blur(10px)',
                                animation: 'slideInUp 0.5s cubic-bezier(0.19, 1, 0.22, 1)'
                            });
                            // Style the button
                            const btn = toast.querySelector('button');
                            Object.assign(btn.style, {
                                background: 'var(--color-brand-primary)', color: 'white',
                                border: 'none', padding: '8px 16px', borderRadius: '6px',
                                fontWeight: '600', fontSize: '0.9rem'
                            });
                            
                            btn.onclick = () => {
                                worker.postMessage({ type: 'SKIP_WAITING' });
                                toast.remove();
                            };

                            document.body.appendChild(toast);
                        }

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateToast(newWorker);
                                }
                            });
                        });
                        
                        // Check if there is already a waiting worker
                         if (registration.waiting) {
                              showUpdateToast(registration.waiting);
                        }
                    })
                    .catch(err => console.log('SW registration failed', err));
                
                // Reload when controller changes
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }
    </script>







    <script>
        // Minimalist Menu Logic: Switch Line/Fill icons
        document.addEventListener('DOMContentLoaded', () => {

            // Set initial active state based on function called or URL
            // Since we use app.router('home'), we can hook into that or just default to home.
            // Let's highlight 'nav-home' by default.
            document.getElementById('nav-home').classList.add('active');

            const navItems = document.querySelectorAll('.nav-item');
            
            function updateIcons() {
                navItems.forEach(item => {
                    const icon = item.querySelector('i');
                    if(icon) {
                        if (item.classList.contains('active')) {
                            // Switch to fill
                            icon.className = icon.className.replace('-line', '-fill');
                        } else {
                            // Switch to line
                            icon.className = icon.className.replace('-fill', '-line');
                        }
                    }
                });
            }

            // Observer to watch for class changes (since app router might change active class)
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class') {
                        updateIcons();
                    }
                });
            });

            navItems.forEach(item => {
                observer.observe(item, { attributes: true });
                // Also add click listener for immediate feedback
                item.addEventListener('click', () => {
                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            
            // Initial check
            updateIcons();
        });
    </script>


<script>
// OVERRIDE renderHome for New UI
app.renderHome = function(filterType) {
    const main = document.getElementById('main-view');
    if(!main) return;
    
    let html = '';
    
    // Logic to handle filterType (Movies, Series, etc.)
    let categories = [];
    if(filterType === 'movies') {
        categories.push({ title: "Películas", filter: i => i.type === 'movie' });
    } else if(filterType === 'series') {
        categories.push({ title: "Series", filter: i => i.type === 'series' });
    } else {
        categories.push(
            { title: "Tendencias", filter: i => i.year >= 2024 },
            { title: "Recientes", filter: i => true },
            { title: "Acción", filter: i => i.genre && i.genre.includes('Acción') }
        );
    }
    
    categories.forEach(cat => {
        let items = allItems.filter(cat.filter);
        if(app.state.currentMood) {
             if(app.state.currentMood === 'chill') items = items.filter(i => i.genre && (i.genre.includes('Comedia') || i.genre.includes('Animación') || i.genre.includes('Romance')));
             if(app.state.currentMood === 'intense') items = items.filter(i => i.genre && (i.genre.includes('Acción') || i.genre.includes('Terror') || i.genre.includes('Suspenso')));
             if(app.state.currentMood === 'magic') items = items.filter(i => i.genre && (i.genre.includes('Fantasía') || i.genre.includes('Ciencia Ficción')));
             if(app.state.currentMood === 'drama') items = items.filter(i => i.genre && (i.genre.includes('Drama') || i.genre.includes('Misterio')));
        }
        
        if(items.length === 0) return;
        
        html += `
            <section class="content-list">
                <h2 class="list-header">${cat.title}</h2>
                <div class="scroll-container">
                    ${items.slice(0, 15).map(item => `
                        <div class="media-card" onclick="openDetails(${item.id})">
                            <img src="${item.img}" loading="lazy">
                            <div class="media-info">
                                <div class="media-title">${item.title}</div>
                                <div class="media-desc">${item.year}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </section>
        `;
    });
    
    main.innerHTML = html;
};

// Also override renderHeader to do nothing (since we have static header)
app.renderHeader = function() {}; 

// Override router to handle active state of bottom nav
const originalRouter = app.router;
app.router = function(route) {
    // Call original logic to set state
    if(originalRouter) originalRouter.call(app, route);
    
    // Update nav classes
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(route === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
    if(route === 'movies') document.querySelectorAll('.nav-item')[1].classList.add('active');
    if(route === 'series') document.querySelectorAll('.nav-item')[2].classList.add('active');
    if(route === 'downloads' || route === 'mylist') document.querySelectorAll('.nav-item')[3].classList.add('active');
};

// Override filterByMood
app.filterByMood = function(mood) {
    app.state.currentMood = mood;
    // Update UI
    document.querySelectorAll('.mood-card').forEach(el => el.style.opacity = '0.5');
    document.querySelectorAll('.mood-' + mood).forEach(el => el.style.opacity = '1');
    
    app.renderHome();
};
</script>
</body>
</html>
